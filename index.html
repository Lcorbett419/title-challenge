<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title Challenge - Football Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        @keyframes goalFlashAnim {
          0% { background: #FFD700; color: #000; }
          20% { background: #000; color: #FFD700; }
          40% { background: #FFD700; color: #000; }
          60% { background: #000; color: #FFD700; }
          80% { background: #FFD700; color: #000; }
          100% { background: #000; color: #FFD700; }
        }
        .goal-flash-active {
          animation: goalFlashAnim 0.6s ease-in-out 3;
        }
        .goal-flash-active p, .goal-flash-active div {
          color: inherit !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Menu = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>;
        const Trophy = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>;

        const calculatePlayerValue = (player, asOfDate, leagueTier) => {
          const { positions, rating, dob } = player;
          const pv = { 'ST':1.0,'LW':0.95,'RW':0.95,'CAM':0.85,'CM':0.70,'CDM':0.68,'LB':0.65,'RB':0.65,'CB':0.60,'GK':0.55 };
          const mx = Math.max(...positions.map(p => pv[p]||0.5));
          const bd = new Date(dob), cd = asOfDate||new Date();
          let age = cd.getFullYear()-bd.getFullYear();
          if(cd.getMonth()-bd.getMonth()<0||(cd.getMonth()===bd.getMonth()&&cd.getDate()<bd.getDate())) age--;
          let am; if(age>=21&&age<=29) am=1.0; else if(age<21) am=rating>=14?0.6+(age-16)*0.08+(rating-14)*0.05:0.4+(age-16)*0.12; else am=Math.max(0.2,1.0-((age-29)*0.08));
        
          // League tier multiplier: tier 0 (top) = 1.0, tier 1 = 0.6, tier 2 = 0.35, tier 3 = 0.2
          const tierMultipliers = [1.0, 0.6, 0.35, 0.2];
          const tm = tierMultipliers[leagueTier !== undefined ? Math.min(leagueTier, 3) : 0];
        
          return Math.min(Math.round(Math.pow(rating,2)*mx*am*tm*250000),100000000);
        };

        const getLeagueTier = (leagueKey) => {
          const pyramids = {
            england: ['england', 'england_championship', 'england_league1', 'england_league2'],
            germany: ['germany', 'germany_2'],
            spain: ['spain', 'spain_segunda'],
            france: ['france', 'france_ligue2'],
            italy: ['italy', 'italy_serieb']
          };
          for (const [, pyramid] of Object.entries(pyramids)) {
            const idx = pyramid.indexOf(leagueKey);
            if (idx !== -1) return idx;
          }
          return 0;
        };
        
        const App = () => {
          const [db, setDb] = useState(null);
          const [state, setState] = useState('main-menu');
          const [league, setLeague] = useState(null);
          const [team, setTeam] = useState(null);
          const [leagues, setLeagues] = useState(null);
          const [fixtures, setFixtures] = useState({});
          const [date, setDate] = useState(new Date('2025-08-01'));
          const [formation, setFormation] = useState('4-3-3');
          const [menuOpen, setMenuOpen] = useState(false);
          const [page, setPage] = useState('home');
          const [match, setMatch] = useState(null);
          const [commentary, setCommentary] = useState([]);
          const [financeHistory, setFinanceHistory] = useState([]);
          const [startingXI, setStartingXI] = useState({});
          const [selectedSlot, setSelectedSlot] = useState(null);
          const [showBench, setShowBench] = useState(false);
          const [country, setCountry] = useState(null);
          const [selectedPlayer, setSelectedPlayer] = useState(null);
          const [selectedPlayerTeam, setSelectedPlayerTeam] = useState(null);
          const [playerHistories, setPlayerHistories] = useState({});
          const [selectedTeamProfile, setSelectedTeamProfile] = useState(null);
          const [transferList, setTransferList] = useState([]);
          const [transferFilter, setTransferFilter] = useState('all');
          const [transferSearch, setTransferSearch] = useState('');
          const [transferAgeFilter, setTransferAgeFilter] = useState('any');
          const [transferSpecialFilter, setTransferSpecialFilter] = useState('all');
          const [transferSortBy, setTransferSortBy] = useState('rating');  
          const [transferNegotiation, setTransferNegotiation] = useState(null);
          const [incomingOffers, setIncomingOffers] = useState([]);
          const [facilities, setFacilities] = useState({ stadiumLevel: 3, devLevel: 1 });
          const [preMatchXI, setPreMatchXI] = useState({});  
          const [liveMatch, setLiveMatch] = useState(null);
          const [liveMinute, setLiveMinute] = useState(0);
          const [liveCommentary, setLiveCommentary] = useState([]);
          const [liveScore, setLiveScore] = useState({ home: 0, away: 0 });
          const [matchTab, setMatchTab] = useState('commentary');
          const [matchPlayerRatings, setMatchPlayerRatings] = useState({ home: [], away: [] });
          const [goalFlash, setGoalFlash] = useState(false);
          const [matchEnded, setMatchEnded] = useState(false);
          const [isHalfTime, setIsHalfTime] = useState(false);
          const [matchSubs, setMatchSubs] = useState({ made: 0, max: 5 });
          const [matchHalf, setMatchHalf] = useState(1);
          const [tacticsPaused, setTacticsPaused] = useState(false);
          const pendingTimeoutsRef = useRef([]);  
          const clockPausedRef = useRef(false);
          const matchIntRef = useRef(null);

          const formations = {
            '4-3-3': { positions: ['GK','LB','CB','CB','RB','CDM','CM','CM','LW','RW','ST'], labels: ['GK','LB','CB','CB','RB','CDM','CM','CM','LW','RW','ST'] },
            '4-4-2': { positions: ['GK','LB','CB','CB','RB','CM','CM','CAM','CAM','ST','ST'], labels: ['GK','LB','CB','CB','RB','CM','CM','CAM','CAM','ST','ST'] },
            '4-2-3-1': { positions: ['GK','LB','CB','CB','RB','CDM','CDM','CAM','LW','RW','ST'], labels: ['GK','LB','CB','CB','RB','CDM','CDM','CAM','LW','RW','ST'] },
            '3-5-2': { positions: ['GK','CB','CB','CB','LB','RB','CM','CM','CM','ST','ST'], labels: ['GK','CB','CB','CB','LB','RB','CM','CM','CM','ST','ST'] }
          };

          useEffect(() => {
            fetch('./leagues-database.json').then(r => r.json()).then(data => setDb(data)).catch(() => alert('Failed to load database'));
          }, []);

          const calcAge = (dob) => {
            const bd = new Date(dob);
            let age = date.getFullYear() - bd.getFullYear();
            const m = date.getMonth() - bd.getMonth();
            if (m < 0 || (m === 0 && date.getDate() < bd.getDate())) age--;
            return age;
          };

          const getWeeksUntil = (isoDate) => {
            const ret = new Date(isoDate);
            const diff = ret.getTime() - date.getTime();
            const weeks = Math.ceil(diff / (7 * 24 * 60 * 60 * 1000));
            return Math.max(0, weeks);
          };

          const healInjuredPlayers = (currentDate) => {
          if (!leagues) return;
          Object.keys(leagues).forEach(lk => {
            leagues[lk].teams.forEach(tm => {
              tm.players.forEach(p => {
                if (p.injured && p.injuryUntil) {
                  if (new Date(p.injuryUntil) <= currentDate) {
                    p.injured = false;
                    p.injuryUntil = null;
                  }
                }
              });
            });
          });
          // Heals the team directly (in case team object isn't in leagues)
          if (team) {
            team.players.forEach(p => {
              if (p.injured && p.injuryUntil) {
                if (new Date(p.injuryUntil) <= currentDate) {
                  p.injured = false;
                  p.injuryUntil = null;
                }
              }
            });
          }
        };

          const formatCurrency = (amt) => 'Â£' + (amt / 1000000).toFixed(1) + 'M';
          const formatDate = (d) => new Date(d).toLocaleDateString('en-GB');

            const commentaryTemplates = {
              chance: [
                "{player} fires a shot from distance â€” saved!",
                "{player} cuts inside and shoots, but it's straight at the keeper.",
                "{player} gets in behind but fires just wide!",
                "Great run by {player}, but the shot is blocked.",
                "{player} heads it towards goal â€” just over the bar!",
                "A dangerous cross finds {player}, but he can't direct it on target.",
                "{player} plays a lovely one-two but the final shot is saved well.",
                "{player} unleashes a volley â€” it rattles the crossbar!"
              ],
              goal: [
                "GOAL! {player} smashes it into the net! Clinical finish!",
                "GOAL! {player} scores! He was in the right place at the right time.",
                "GOAL! A brilliant strike from {player}! What a hit!",
                "GOAL! {player} slots it home coolly. Great composure.",
                "GOAL! {player} heads it in from close range!",
                "GOAL! {player} rounds the keeper and finishes into an empty net!"
              ],
              defend: [
                "Great defending from {player} to head it away.",
                "{player} makes a crucial tackle to stop the attack.",
                "The keeper pulls off a brilliant save!",
                "{player} clears it off the line!",
                "Strong challenge by {player}, the referee says play on."
              ],
              midfield: [
                "{player} wins the ball back in midfield.",
                "Nice passing move involving {player}.",
                "{player} spreads it wide with a lovely pass.",
                "That's a poor pass from {player}. This could be dangerous.",
                "{player} drives forward with the ball."
              ],
                yellowCard: [
                  "ðŸŸ¨ {player} is booked for that challenge.",
                  "ðŸŸ¨ Yellow card for {player}. He's been warned.",
                  "ðŸŸ¨ {player} goes into the book after a reckless tackle.",
                  "ðŸŸ¨ The referee shows {player} a yellow card.",
                  "ðŸŸ¨ {player} picks up a booking for persistent fouling."
                ],
                redCard: [
                  "ðŸŸ¥ RED CARD! {player} is sent off!",
                  "ðŸŸ¥ That's a straight red for {player}! He's off!",
                  "ðŸŸ¥ Second yellow for {player}! He has to go!"
                ],
                assist: [
                  "Assisted by {player} with a brilliant pass.",
                  "Great vision from {player} to set up the chance.",
                  "{player} with the key pass to create the goal."
                ],
              foul: [
                "Free kick awarded after a foul on {player}.",
                "{player} is brought down on the edge of the box.",
                "The referee blows for a foul by {player}."
              ]
            };
            
            const pickTemplate = (type) => {
              const arr = commentaryTemplates[type];
              return arr[Math.floor(Math.random() * arr.length)];
            };

         const generateTransferList = () => {
          const available = [];
          Object.keys(leagues).forEach(lk => {
            leagues[lk].teams.forEach(tm => {
              if (tm.id === team.id) return;
              tm.players.forEach(p => {
                if (Math.random() < 0.3) {
                  available.push({ player: p, team: tm, leagueKey: lk, askingPrice: Math.round(calculatePlayerValue(p, date, getLeagueTier(lk)) * (1.1 + Math.random() * 0.4))});
                }
              });
            });
          });
          available.sort((a, b) => b.player.rating - a.player.rating);
          setTransferList(available);
        };
        
          const buyPlayer = (listing) => {
          if (team.budget < listing.askingPrice) { alert('Insufficient funds!'); return; }
          if (team.players.length >= 30) { alert('Squad is full! (max 30) Sell a player first.'); return; }
          setState('negotiation');    
        
          // Start negotiation screen
          setTransferNegotiation({
            type: 'buy',
            player: listing.player,
            fromTeam: listing.team,
            price: listing.askingPrice,
            stage: 'bidding', // bidding -> negotiating -> result
            result: null,
            message: ''
          });
        
          // Simulate negotiation after a moment
          setTimeout(() => {
            setTransferNegotiation(prev => {
              if (!prev) return null;
              return { ...prev, stage: 'negotiating', message: `${listing.team.name} have accepted your bid.` };
            });
        
            setTimeout(() => {
              // Player decision based on team strength comparison
              const myStrength = getTeamStrength(team);
              const theirStrength = getTeamStrength(listing.team);
              const playerRating = listing.player.rating;
              const strengthDiff = myStrength - theirStrength;
        
              // Base acceptance chance
              let acceptChance = 0.5;
        
              // Better team = more likely to accept
              acceptChance += strengthDiff * 0.15;
        
              // Star players (high rating) are harder to convince for a step down
              if (playerRating >= 17 && strengthDiff < 0) acceptChance -= 0.3;
              if (playerRating >= 15 && strengthDiff < -1) acceptChance -= 0.2;
        
              // Players from weaker teams are easier to sign
              if (strengthDiff > 2) acceptChance += 0.3;
        
              // Clamp between 5% and 95%
              acceptChance = Math.max(0.05, Math.min(0.95, acceptChance));
        
              const accepted = Math.random() < acceptChance;
        
              setTransferNegotiation(prev => {
                if (!prev) return null;
                return {
                  ...prev,
                  stage: 'result',
                  result: accepted,
                  message: accepted
                    ? `${listing.player.name} has agreed to join your club!`
                    : `${listing.player.name} has rejected your offer. The player prefers to stay at ${listing.team.name}.`
                };
              });
            }, 1500);
          }, 1000);
        };
        
        const confirmBuy = () => {
          if (!transferNegotiation || !transferNegotiation.result) return;
          const { player, fromTeam, price } = transferNegotiation;
          team.budget -= price;
          fromTeam.players = fromTeam.players.filter(p => p.id !== player.id);
          const maxId = Math.max(...team.players.map(p => p.id), 0);
          const newPlayer = { ...player, id: maxId + 1, goals: 0, injured: false, injuryUntil: null };
          team.players.push(newPlayer);
          setTransferList(transferList.filter(l => !(l.player.id === player.id && l.team.id === fromTeam.id)));
          setFinanceHistory([...financeHistory, { date: date.toISOString(), balance: team.budget }]);
          setTransferNegotiation(null);
        };
                
                  const sellPlayer = (p) => {
                  if (team.players.length <= 11) { alert('Cannot sell! You need at least 11 players.'); return; }
                  const value = calculatePlayerValue(p, date, getLeagueTier(league));
                  const offer = Math.round(value * (0.7 + Math.random() * 0.3));
                  setState('negotiation');
                
                  setTransferNegotiation({
                    type: 'sell',
                    player: p,
                    fromTeam: team,
                    buyingClub: 'An interested club',
                    price: offer,
                    stage: 'result',
                    result: true,
                    message: `A club has offered ${formatCurrency(offer)} for ${p.name}. Do you want to accept?`
                  });
                };
                
                const confirmSell = () => {
                  if (!transferNegotiation) return;
                  const { player, price } = transferNegotiation;
                  team.budget += price;
                  team.players = team.players.filter(pl => pl.id !== player.id);
                  const xi = { ...startingXI };
                  Object.keys(xi).forEach(k => { if (xi[k] === player.id) delete xi[k]; });
                  setStartingXI(xi);
                  setFinanceHistory([...financeHistory, { date: date.toISOString(), balance: team.budget }]);
                  setTransferNegotiation(null);
                };
        
                const processAITransfers = () => {
                const countryLeagues = Object.keys(leagues).filter(lk => lk.startsWith(country));
                const allTeams = [];
                countryLeagues.forEach(lk => {
                    leagues[lk].teams.forEach(tm => {
                      if (tm.id !== team.id) allTeams.push({ team: tm, leagueKey: lk });
                    });
                  });
                
                  // Each AI team attempts 1-3 transfers
                  allTeams.forEach(({ team: aiTeam }) => {
                    const numTransfers = Math.floor(Math.random() * 3) + 1;
                    for (let i = 0; i < numTransfers; i++) {
                      if (aiTeam.players.length <= 11) break;
                
                      // Pick a random position to improve
                      const positions = ['GK','CB','LB','RB','CDM','CM','CAM','LW','RW','ST'];
                      const targetPos = positions[Math.floor(Math.random() * positions.length)];
                
                      // Find weakest player in that position to sell
                      const posPlayers = aiTeam.players.filter(p => p.positions.includes(targetPos));
                      if (posPlayers.length <= 1) continue;
                      const weakest = posPlayers.sort((a, b) => a.rating - b.rating)[0];
                
                      // Find a better player from another AI team
                      let bestBuy = null;
                      let bestBuyTeam = null;
                      allTeams.forEach(({ team: otherTeam }) => {
                        if (otherTeam.id === aiTeam.id) return;
                        if (otherTeam.players.length <= 11) return;
                        otherTeam.players.forEach(p => {
                          if (!p.positions.includes(targetPos)) return;
                          if (p.rating <= weakest.rating) return;
                          if (Math.random() > 0.15) return; // Low chance to keep it rare
                          if (!bestBuy || p.rating > bestBuy.rating) {
                            bestBuy = p;
                            bestBuyTeam = otherTeam;
                          }
                        });
                      });
                
                      if (bestBuy && bestBuyTeam) {
                        // Swap: sell weakest, buy bestBuy
                        bestBuyTeam.players = bestBuyTeam.players.filter(p => p.id !== bestBuy.id);
                        aiTeam.players = aiTeam.players.filter(p => p.id !== weakest.id);
                        bestBuy.goals = 0; bestBuy.injured = false; bestBuy.injuryUntil = null;
                        weakest.goals = 0; weakest.injured = false; weakest.injuryUntil = null;
                        aiTeam.players.push(bestBuy);
                        bestBuyTeam.players.push(weakest);
                      }
                    }
                  });
                };

          const generateIncomingOffers = () => {
          const offers = [];
          team.players.forEach(p => {
            if (Math.random() < 0.1) {
              const value = calculatePlayerValue(p, date, getLeagueTier(league));
              const offerAmount = Math.round(value * (0.6 + Math.random() * 0.5));
              const allTeams = [];
              Object.keys(leagues).forEach(lk => {
                leagues[lk].teams.forEach(tm => {
                  if (tm.id !== team.id) allTeams.push(tm);
                });
              });
              const biddingTeam = allTeams[Math.floor(Math.random() * allTeams.length)];
              if (biddingTeam) {
                offers.push({ player: p, biddingTeam, offerAmount });
              }
            }
          });
          setIncomingOffers(offers);
        };
        
        const acceptOffer = (offer) => {
          if (team.players.length <= 11) { alert('Cannot sell! You need at least 11 players.'); return; }
          setTransferNegotiation({
            type: 'incoming',
            player: offer.player,
            fromTeam: team,
            buyingClub: offer.biddingTeam.name,
            buyingTeamObj: offer.biddingTeam,
            price: offer.offerAmount,
            stage: 'result',
            result: true,
            message: `${offer.biddingTeam.name} have bid ${formatCurrency(offer.offerAmount)} for ${offer.player.name}. Do you want to accept?`
          });
            setState('negotiation');
        };
        
        const confirmIncomingSale = () => {
          if (!transferNegotiation) return;
          const { player, price, buyingTeamObj } = transferNegotiation;
          team.budget += price;
          team.players = team.players.filter(pl => pl.id !== player.id);
          if (buyingTeamObj) {
            const sold = { ...player, goals: 0, injured: false, injuryUntil: null };
            buyingTeamObj.players.push(sold);
          }
          const xi = { ...startingXI };
          Object.keys(xi).forEach(k => { if (xi[k] === player.id) delete xi[k]; });
          setStartingXI(xi);
          setFinanceHistory([...financeHistory, { date: date.toISOString(), balance: team.budget }]);
          setIncomingOffers(incomingOffers.filter(o => o.player.id !== player.id));
          setTransferNegotiation(null);
        };
            
        const getTeamStrength = (tm) => {
          if (!tm || !tm.players || tm.players.length === 0) return 0;
          const sorted = [...tm.players].sort((a, b) => b.rating - a.rating);
          const best11 = sorted.slice(0, 11);
          return best11.reduce((s, p) => s + p.rating, 0) / best11.length;
        };
            
        const getStarRating = (rating) => {
          if (rating >= 20) return { stars: 5, half: false, label: 'World Class', color: 'text-yellow-400' };
          if (rating >= 18) return { stars: 5, half: false, label: '5 Star', color: 'text-yellow-400' };
          if (rating >= 16) return { stars: 4, half: true, label: '4.5 Star', color: 'text-green-400' };
          if (rating >= 14) return { stars: 4, half: false, label: '4 Star', color: 'text-green-400' };
          if (rating >= 12) return { stars: 3, half: true, label: '3.5 Star', color: 'text-blue-400' };
          if (rating >= 10) return { stars: 3, half: false, label: '3 Star', color: 'text-blue-400' };
          if (rating >= 8) return { stars: 2, half: true, label: '2.5 Star', color: 'text-gray-400' };
          if (rating >= 6) return { stars: 2, half: false, label: '2 Star', color: 'text-gray-400' };
          if (rating >= 4) return { stars: 1, half: true, label: '1.5 Star', color: 'text-orange-400' };
          if (rating >= 2) return { stars: 1, half: false, label: '1 Star', color: 'text-orange-400' };
          return { stars: 0, half: true, label: '0.5 Star', color: 'text-red-400' };
        };
        
        const StarDisplay = ({ rating }) => {
        const sr = getStarRating(rating);
          return (
            <span className={sr.color}>
              {'â˜…'.repeat(sr.stars)}{sr.half ? 'â¯ª' : ''}{'â˜†'.repeat(5 - sr.stars - (sr.half ? 1 : 0))}
            </span>
          );
        };

          const newGame = () => {
            setTeam(null); setLeague(null); setCountry(null);
            setLeagues(JSON.parse(JSON.stringify(db)));
            setFixtures({}); setDate(new Date('2025-08-01'));
            setFinanceHistory([]);
            setFacilities({ stadiumLevel: 3, devLevel: 1 });
            localStorage.removeItem('footballManagerSave');
            setState('country-select');
          };

          const loadGame = () => {
            const saved = localStorage.getItem('footballManagerSave');
            if (saved) {
              try {
                const data = JSON.parse(saved);
                if (data.gameData) {
                  setLeague(data.gameData.league); setTeam(data.gameData.team);
                  setCountry(data.gameData.country);
                  setLeagues(data.gameData.leagues); setFixtures(data.gameData.fixtures);
                  setDate(new Date(data.gameData.date));
                  setFormation(data.gameData.formation || '4-3-3');
                  setFinanceHistory(data.gameData.financeHistory || []);
                  setStartingXI(data.gameData.startingXI || {});
                  setFacilities(data.gameData.facilities || { stadiumLevel: 3, devLevel: 1 });
                  setPlayerHistories(data.gameData.playerHistories || {});
                  setState('info-page');
                }
              } catch (e) { alert('Error loading game'); }
            }
          };

          const hasSaved = () => {
            try {
              const saved = localStorage.getItem('footballManagerSave');
              if (saved) { const data = JSON.parse(saved); return data.gameData && data.gameData.team; }
            } catch (e) {}
            return false;
          };

          useEffect(() => {
            if (team && state === 'info-page') {
              const gameData = { league, team, country, leagues, fixtures, date: date.toISOString(), formation, financeHistory, startingXI, facilities, playerHistories };
              localStorage.setItem('footballManagerSave', JSON.stringify({ gameData }));
            }
          }, [team, leagues, fixtures, date, state, facilities]);

          const selectCountry = (c) => { setCountry(c); setState('league-select'); };

          const selectLeague = (lk) => { setLeague(lk); setState('team-select'); };

          const selectTeam = (t) => {
            setTeam(t); generateFixtures();
            setFinanceHistory([{ date: new Date('2025-08-01').toISOString(), balance: t.budget }]);
            const xi = {};
            formations['4-3-3'].positions.forEach((pos, idx) => {
              const eligible = t.players.filter(p => p.positions.includes(pos) && !Object.values(xi).includes(p.id));
              if (eligible.length > 0) xi[`pos${idx}`] = eligible.sort((a, b) => b.rating - a.rating)[0].id;
            });
            setStartingXI(xi);
            const stadLvl = t.stadiumCapacity ? Math.round(t.stadiumCapacity / 10000) : 3;
            setFacilities({ stadiumLevel: Math.max(1, Math.min(10, stadLvl)), devLevel: 1 });
            setState('info-page');
          };

          const generateFixtures = () => {
            const newFix = {};
            Object.keys(leagues).forEach(lk => {
              const lg = leagues[lk]; const teams = lg.teams;
              teams.forEach(tm => { tm.players.forEach(p => {
                  if (!p.goals) p.goals = 0;
                  if (!p.assists) p.assists = 0;
                  if (!p.yellowCards) p.yellowCards = 0;
                  if (!p.redCards) p.redCards = 0;
                  if (!p.injured) p.injured = false;
                }); });
              const n = teams.length; const fix = [];
              for (let r = 0; r < (n - 1) * 2; r++) {
                const first = r < n - 1; const base = first ? r : r - (n - 1);
                for (let i = 0; i < n / 2; i++) {
                  let h = (base + i) % (n - 1); let a = (n - 1 - i + base) % (n - 1);
                  if (i === 0) a = n - 1; if (!first) [h, a] = [a, h];
                  fix.push({ homeTeamId: teams[h].id, awayTeamId: teams[a].id, played: false, homeScore: null, awayScore: null, scorers: [], matchday: r + 1 });
                }
              }
              newFix[lk] = fix;
            });
            setFixtures(newFix);
          };

          const startNewSeason = () => {
            const fix = fixtures[league] || [];
            const seasonComplete = fix.length > 0 && fix.every(f => f.played);
            
            if (!seasonComplete) {
              alert('Season not complete yet!');
              return;
            }

            const tbl = getTable(league);
            const playerPos = tbl.findIndex(t => t.teamId === team.id);
            
            const leaguePyramids = {
              england: ['england', 'england_championship', 'england_league1', 'england_league2'],
              germany: ['germany', 'germany_2'],
              spain: ['spain', 'spain_segunda'],
              france: ['france', 'france_ligue2'],
              italy: ['italy', 'italy_serieb']
            };
            
            let foundCountry = null;
            let currentTier = -1;
            
            for (const [countryKey, pyramid] of Object.entries(leaguePyramids)) {
              const tierIndex = pyramid.indexOf(league);
              if (tierIndex !== -1) {
                foundCountry = countryKey;
                currentTier = tierIndex;
                break;
              }
            }
            
            if (!foundCountry) {
              alert('Error: League not found in pyramid system');
              return;
            }
            
            const pyramid = leaguePyramids[foundCountry];
            let newLeague = league;
            let message = '';
            
            if (playerPos < 2 && currentTier > 0) {
              newLeague = pyramid[currentTier - 1];
              message = `ðŸŽ‰ PROMOTED! You finished ${playerPos + 1}${playerPos === 0 ? 'st' : 'nd'} and are promoted to ${leagues[newLeague].name}!`;
            } else if (playerPos >= tbl.length - 3 && currentTier < pyramid.length - 1) {
              newLeague = pyramid[currentTier + 1];
              message = `ðŸ˜¢ RELEGATED. You finished ${playerPos + 1}th and are relegated to ${leagues[newLeague].name}.`;
            } else if (playerPos === 0 && currentTier === 0) {
              message = `ðŸ† CHAMPIONS! You won ${leagues[league].name}! You are the best team in ${leagues[league].country}!`;
            } else if (playerPos === 0) {
              message = `ðŸ† CHAMPIONS! You won ${leagues[league].name}!`;
            } else {
              message = `Season complete! You finished ${playerPos + 1}${playerPos === 1 ? 'nd' : playerPos === 2 ? 'rd' : 'th'}.`;
            }
            
            alert(message);

            // Compute ALL tables BEFORE any swaps happen
            const allTables = {};
            pyramid.forEach(key => {
              if (leagues[key]) allTables[key] = getTable(key);
            });
            
            // Now process all swaps using pre-computed tables
            const swaps = [];
            for (let tier = 0; tier < pyramid.length - 1; tier++) {
              const upperKey = pyramid[tier];
              const lowerKey = pyramid[tier + 1];
              if (!allTables[upperKey] || !allTables[lowerKey]) continue;
            
              const relegatedIds = allTables[upperKey].slice(-3).map(t => t.teamId);
              const promotedIds = allTables[lowerKey].slice(0, 3).map(t => t.teamId);
            
              swaps.push({ upperKey, lowerKey, relegatedIds, promotedIds });
            }
            
            // Apply all swaps at once
            swaps.forEach(({ upperKey, lowerKey, relegatedIds, promotedIds }) => {
              const relegatedTeams = relegatedIds.map(id => leagues[upperKey].teams.find(t => t.id === id)).filter(Boolean);
              const promotedTeams = promotedIds.map(id => leagues[lowerKey].teams.find(t => t.id === id)).filter(Boolean);
            
              leagues[upperKey].teams = leagues[upperKey].teams.filter(t => !relegatedIds.includes(t.id));
              leagues[lowerKey].teams = leagues[lowerKey].teams.filter(t => !promotedIds.includes(t.id));
            
              promotedTeams.forEach(t => leagues[upperKey].teams.push(t));
              relegatedTeams.forEach(t => leagues[lowerKey].teams.push(t));
            });
            
            if (newLeague !== league) {
              setLeague(newLeague);
            }
            const seasonYear = date.getMonth() >= 7 ? date.getFullYear() + 1 : date.getFullYear();
            const newDate = new Date(`${seasonYear}-08-01`);
            setDate(newDate);
            
            // Apply youth development to YOUR team's players
            team.players.forEach(p => {
              const age = calcAge(p.dob);
              if (age <= 27 && p.rating < 20) {
                const growthChance = 0.15 + (facilities.devLevel - 1) * 0.05;
                if (Math.random() < growthChance) {
                  p.rating = Math.min(20, p.rating + 1);
                }
              }
              if (age >= 32) {
                const declineChance = 0.15 + (age - 32) * 0.1;
                if (Math.random() < declineChance && p.rating > 5) {
                  p.rating -= 1;
                }
              }
            });

            Object.keys(leagues).forEach(lk => {
              leagues[lk].teams.forEach(tm => {
                tm.players.forEach(p => {
                  p.goals = 0;
                  p.assists = 0;
                  p.yellowCards = 0;
                  p.redCards = 0;  
                  p.injured = false;
                  p.injuryUntil = null;
                });
              });
            });
            
            processAITransfers();
            setIncomingOffers([]);
            setTransferList([]);
            generateFixtures();
          };

          const getTable = (lk) => {
            const lg = leagues[lk]; const fix = fixtures[lk] || [];
            const tbl = lg.teams.map(t => ({ teamId: t.id, name: t.name, played: 0, won: 0, drawn: 0, lost: 0, goalsFor: 0, goalsAgainst: 0, points: 0 }));
            fix.filter(f => f.played).forEach(f => {
              const h = tbl.find(t => t.teamId === f.homeTeamId); const a = tbl.find(t => t.teamId === f.awayTeamId);
              if (h && a) {
                h.played++; a.played++;
                h.goalsFor += f.homeScore; h.goalsAgainst += f.awayScore;
                a.goalsFor += f.awayScore; a.goalsAgainst += f.homeScore;
                if (f.homeScore > f.awayScore) { h.won++; h.points += 3; a.lost++; }
                else if (f.homeScore < f.awayScore) { a.won++; a.points += 3; h.lost++; }
                else { h.drawn++; a.drawn++; h.points++; a.points++; }
              }
            });
            tbl.sort((a, b) => b.points !== a.points ? b.points - a.points : (b.goalsFor - b.goalsAgainst) - (a.goalsFor - a.goalsAgainst));
            return tbl;
          };

          const getNext = () => {
            const fix = fixtures[league] || [];
            return fix.find(f => !f.played && (f.homeTeamId === team.id || f.awayTeamId === team.id));
          };

          const simMatch = (h, a, track) => {
            const comm = []; const scorers = [];
            const getMatchPlayers = (tm) => {
              if (tm.id === team.id && Object.keys(startingXI).length > 0) {
                return Object.entries(startingXI).map(([key, playerId]) => {
                  const player = tm.players.find(p => p.id === playerId);
                  if (!player || player.injured) return null;
                  const posIdx = parseInt(key.replace('pos', ''));
                  const requiredPos = formations[formation].positions[posIdx];
                  const inPosition = player.positions.includes(requiredPos);
                  return { ...player, effectiveRating: inPosition ? player.rating : Math.max(1, player.rating - 5) };
                }).filter(p => p !== null);
              } else {
                return tm.players.filter(p => !p.injured).sort((a, b) => b.rating - a.rating).slice(0, 11).map(p => ({ ...p, effectiveRating: p.rating }));
              }
            };
            const homePlayers = getMatchPlayers(h); const awayPlayers = getMatchPlayers(a);
            let hs = 0, as = 0;
            comm.push(`${h.name} vs ${a.name}`); comm.push("Kick off!");
            for (let i = 0; i < 10; i++) {
              const min = Math.floor(Math.random() * 90) + 1;
              if (Math.random() < 0.3) {
                const pickScorer = (players) => {
                  const r = Math.random();
                  if (r < 0.70) { const fwd = players.filter(p => p.positions.some(pos => ['ST','LW','RW','CAM'].includes(pos))); return fwd.length > 0 ? fwd[Math.floor(Math.random() * fwd.length)] : null; }
                  if (r < 0.90) { const mid = players.filter(p => p.positions.some(pos => ['CDM','CM'].includes(pos))); return mid.length > 0 ? mid[0] : null; }
                  if (r < 0.999) { const def = players.filter(p => p.positions.some(pos => ['LB','CB','RB'].includes(pos))); return def.length > 0 ? def[0] : null; }
                  return players.find(p => p.positions.includes('GK')) || null;
                };
                if (Math.random() < 0.5) {
                  const sc = pickScorer(homePlayers);
                  if (sc && Math.random() < (0.2 + sc.effectiveRating * 0.02)) { hs++; comm.push(`${min}' GOAL! ${sc.name}! ${hs}-${as}`); if (track) scorers.push({ playerId: sc.id, teamId: h.id }); }
                } else {
                  const sc = pickScorer(awayPlayers);
                  if (sc && Math.random() < (0.2 + sc.effectiveRating * 0.02)) { as++; comm.push(`${min}' GOAL! ${sc.name}! ${hs}-${as}`); if (track) scorers.push({ playerId: sc.id, teamId: a.id }); }
                }
              }
            }
            [...homePlayers, ...awayPlayers].forEach(p => {
              if (!p.injured && Math.random() < 0.01) {
                const tmObj = h.players.find(pl => pl.id === p.id) ? h : a;
                const originalPlayer = tmObj.players.find(pl => pl.id === p.id);
                if (originalPlayer) {
                  originalPlayer.injured = true;
                  const w = 1 + Math.floor(Math.random() * 4);
                  const injDate = new Date(date);
                  injDate.setDate(injDate.getDate() + w * 7);
                  originalPlayer.injuryUntil = injDate.toISOString();
                  if ((h.id === team.id || a.id === team.id)) comm.push(`âš•ï¸ ${p.name} injured (${w} week${w > 1 ? 's' : ''})`);
                }
              }
            });
            comm.push(`FULL TIME: ${h.name} ${hs} - ${as} ${a.name}`);
            return { homeScore: hs, awayScore: as, commentary: comm, scorers };
          };

            const generateMatchEvents = (homePlayers, awayPlayers, h, a, minStart, minEnd, existingScore, existingScorers) => {
              const events = [];
              let hs = existingScore.home, as = existingScore.away;
              const scorers = [...existingScorers];
            
              const homeStrength = homePlayers.reduce((s, p) => s + p.effectiveRating, 0) / Math.max(homePlayers.length, 1);
              const awayStrength = awayPlayers.reduce((s, p) => s + p.effectiveRating, 0) / Math.max(awayPlayers.length, 1);
              const totalStrength = homeStrength + awayStrength;
              const baseChanceRate = 0.04 + (totalStrength / 40) * 0.08;
              const homeDominance = homeStrength / totalStrength;
              const homeChancePct = Math.min(0.75, homeDominance + 0.05);
            
              const matchCards = {};
              const sentOff = { home: [], away: [] };
            
              for (let min = minStart; min <= minEnd; min++) {
                const activeHome = homePlayers.filter(p => !sentOff.home.includes(p.id));
                const activeAway = awayPlayers.filter(p => !sentOff.away.includes(p.id));
            
                const homeManPenalty = activeHome.length < 11 ? 0.7 : 1.0;
                const awayManPenalty = activeAway.length < 11 ? 0.7 : 1.0;
                const adjustedRate = baseChanceRate * Math.max(homeManPenalty, awayManPenalty);
            
                let adjHomePct = homeChancePct;
                if (activeHome.length < activeAway.length) adjHomePct = Math.max(0.25, homeChancePct - 0.15);
                else if (activeAway.length < activeHome.length) adjHomePct = Math.min(0.75, homeChancePct + 0.15);
            
                if (Math.random() < adjustedRate) {
                  const isHome = Math.random() < adjHomePct;
                  const players = isHome ? activeHome : activeAway;
                  const defPlayers = isHome ? activeAway : activeHome;
                  const evTeam = isHome ? h : a;
            
                  const pickPlayer = (ps) => {
                    const r = Math.random();
                    if (r < 0.70) { const fwd = ps.filter(p => p.positions.some(pos => ['ST','LW','RW','CAM'].includes(pos))); if (fwd.length > 0) return fwd[Math.floor(Math.random() * fwd.length)]; }
                    if (r < 0.90) { const mid = ps.filter(p => p.positions.some(pos => ['CDM','CM'].includes(pos))); if (mid.length > 0) return mid[Math.floor(Math.random() * mid.length)]; }
                    const def = ps.filter(p => p.positions.some(pos => ['LB','CB','RB'].includes(pos))); if (def.length > 0) return def[Math.floor(Math.random() * def.length)];
                    return ps[0];
                  };
            
                  const attacker = pickPlayer(players);
                  const defender = defPlayers[Math.floor(Math.random() * defPlayers.length)];
                  if (!attacker) continue;
            
                  const midfielder = players.filter(p => p.positions.some(pos => ['CDM','CM','CAM'].includes(pos)))[0] || attacker;
                  events.push({ min, type: 'midfield', text: pickTemplate('midfield').replace('{player}', midfielder.name), isHome, isGoal: false, playerId: midfielder.id });
                  
                  const scoreChance = 0.2 + attacker.effectiveRating * 0.02;
                  if (Math.random() < scoreChance) {
                    if (isHome) hs++; else as++;
                    const possibleAssisters = players.filter(p => p.id !== attacker.id);
                    let assister = null;
                    if (possibleAssisters.length > 0) {
                      const midAtk = possibleAssisters.filter(p => p.positions.some(pos => ['CAM','CM','LW','RW','ST'].includes(pos)));
                      assister = midAtk.length > 0 ? midAtk[Math.floor(Math.random() * midAtk.length)] : possibleAssisters[Math.floor(Math.random() * possibleAssisters.length)];
                    }
                    events.push({ min, type: 'goal', text: pickTemplate('goal').replace('{player}', attacker.name), isHome, isGoal: true, score: { home: hs, away: as }, playerId: attacker.id });
                    if (assister) {
                      events.push({ min, type: 'assist', text: pickTemplate('assist').replace('{player}', assister.name), isHome, isGoal: false, playerId: assister.id });
                      scorers.push({ playerId: attacker.id, teamId: evTeam.id, assisterId: assister.id });
                    } else {
                      scorers.push({ playerId: attacker.id, teamId: evTeam.id, assisterId: null });
                    }
                  } else {
                    events.push({ min, type: 'chance', text: pickTemplate('chance').replace('{player}', attacker.name), isHome, isGoal: false, playerId: attacker.id });
                    if (defender) {
                      events.push({ min, type: 'defend', text: pickTemplate('defend').replace('{player}', defender.name), isHome: !isHome, isGoal: false, playerId: defender.id });
                    }
                  }
                } else if (Math.random() < 0.03 + (totalStrength / 40) * 0.02) {
                  const isHome = Math.random() < 0.5;
                  const players = isHome ? homePlayers : awayPlayers;
                  const p = players[Math.floor(Math.random() * players.length)];
                  if (p) {
                    events.push({ min, type: 'foul', text: pickTemplate('foul').replace('{player}', p.name), isHome, isGoal: false });
                    if (Math.random() < 0.4) {
                      const cardKey = `${p.id}`;
                      if (!matchCards[cardKey]) matchCards[cardKey] = 0;
                      matchCards[cardKey]++;
                      if (matchCards[cardKey] >= 2) {
                        events.push({ min, type: 'redCard', text: pickTemplate('redCard').replace('{player}', p.name), isHome, isGoal: false, playerId: p.id, teamId: isHome ? h.id : a.id, cardType: 'red' });
                        if (isHome) { sentOff.home.push(p.id); } else { sentOff.away.push(p.id); }
                      } else {
                        events.push({ min, type: 'yellowCard', text: pickTemplate('yellowCard').replace('{player}', p.name), isHome, isGoal: false, playerId: p.id, teamId: isHome ? h.id : a.id, cardType: 'yellow' });
                      }
                    } else if (Math.random() < 0.03) {
                      events.push({ min, type: 'redCard', text: pickTemplate('redCard').replace('{player}', p.name), isHome, isGoal: false, playerId: p.id, teamId: isHome ? h.id : a.id, cardType: 'red' });
                      if (isHome) { sentOff.home.push(p.id); } else { sentOff.away.push(p.id); }
                    }
                  }
                }
              }
            
              return { events, score: { home: hs, away: as }, scorers };
            };

           const scheduleEvents = (events, minOffset, totalMinutes) => {
              const baseDuration = (totalMinutes / 45) * 30000;
              const msPerMinute = baseDuration / totalMinutes;
            
              clockPausedRef.current = false;
              pendingTimeoutsRef.current = [];
            
              matchIntRef.current = setInterval(() => {
                if (clockPausedRef.current) return;
                setLiveMinute(prev => {
                  const target = minOffset + totalMinutes;
                  if (prev >= target) {
                    clearInterval(matchIntRef.current);
                    return target;
                  }
                  return prev + 1;
                });
              }, msPerMinute);
            
              events.sort((a, b) => a.min - b.min);
              let cumulativeDelay = 0;
            
              events.forEach((ev, idx) => {
                const baseDelay = (ev.min - minOffset) * msPerMinute;
                const prevEv = idx > 0 ? events[idx - 1] : null;
                if (prevEv && prevEv.type === 'chance') cumulativeDelay += 2500;
                else if (prevEv && prevEv.type === 'goal') cumulativeDelay += 3500;
            
                const delay = baseDelay + cumulativeDelay + Math.random() * 150;
            
                const tid = setTimeout(() => {
                  setLiveCommentary(prev => [ev, ...prev]);
            
                  if (ev.type === 'chance') {
                    clockPausedRef.current = true;
                    setTimeout(() => { clockPausedRef.current = false; }, 2500);
                  }
                  if (ev.isGoal && ev.score) {
                    setLiveScore(ev.score);
                    setGoalFlash(true);
                    setTimeout(() => setGoalFlash(false), 3600);
                    clockPausedRef.current = true;
                    setTimeout(() => { clockPausedRef.current = false; }, 3500);
                  }
                  if (ev.type === 'halftime') {
                    clearInterval(matchIntRef.current);
                    setLiveMinute(45);
                    setIsHalfTime(true);
                    setMatchHalf(2);
                  }
                  if (ev.type === 'end') {
                    clearInterval(matchIntRef.current);
                    setLiveMinute(90);
                    setMatchEnded(true);
                  }
                }, delay);
            
                pendingTimeoutsRef.current.push(tid);
              });
            }; 

            const pauseForTactics = () => {
              // Cancel all pending events
              clearInterval(matchIntRef.current);
              pendingTimeoutsRef.current.forEach(tid => clearTimeout(tid));
              pendingTimeoutsRef.current = [];
              clockPausedRef.current = true;
              setTacticsPaused(true);
              setSelectedSlot(null);
            };
            
            const resumeFromTactics = () => {
              if (!liveMatch) return;
              const { homeTeam, awayTeam } = liveMatch;
              const currentMin = liveMinute;
            
              // Rebuild players with subs applied
              const getUpdatedPlayers = (tm) => {
                if (tm.id === team.id && Object.keys(startingXI).length > 0) {
                  return Object.entries(startingXI).map(([key, playerId]) => {
                    const player = tm.players.find(p => p.id === playerId);
                    if (!player || player.injured) return null;
                    const posIdx = parseInt(key.replace('pos', ''));
                    const requiredPos = formations[formation].positions[posIdx];
                    const inPosition = player.positions.includes(requiredPos);
                    const computed = computeLiveRatings(
                    [...(liveMatch.homePlayers || []), ...(liveMatch.awayPlayers || [])],
                    liveCommentary,
                    liveMatch.homeTeam.players.find(pl => pl.id === playerId) ? true : false
                    ).find(p => p.id === playerId);
                    return { ...player, effectiveRating: inPosition ? player.rating : Math.max(1, player.rating - 5), matchRating: baseRating };
                  }).filter(p => p !== null);
                } else {
                  return tm.players.filter(p => !p.injured).sort((a, b) => b.rating - a.rating).slice(0, 11).map(p => {
                    const computed = computeLiveRatings(
                      [...(liveMatch.homePlayers || []), ...(liveMatch.awayPlayers || [])],
                      liveCommentary,
                      liveMatch.homeTeam.players.find(pl => pl.id === playerId) ? true : false
                    ).find(cp => cp.id === p.id);
                    return { ...p, effectiveRating: p.rating, matchRating: existing ? existing.matchRating : 6.0 + Math.random() * 1.0 };
                  });
                }
              };
            
              const newHome = getUpdatedPlayers(homeTeam);
              const newAway = getUpdatedPlayers(awayTeam);
              const currentScore = { home: liveScore.home, away: liveScore.away };
              const currentScorers = liveMatch.scorers || [];
            
              // Generate remaining events
              const endMin = currentMin < 45 ? 45 : 90;
              const remaining = generateMatchEvents(newHome, newAway, homeTeam, awayTeam, currentMin + 1, endMin, currentScore, currentScorers);
            
              // Add half-time or full-time marker
              if (endMin === 45) {
                remaining.events.push({ min: 45, type: 'halftime', text: 'ðŸ• Half Time', isHome: true, isGoal: false });
              } else {
                remaining.events.push({ min: 90, type: 'end', text: 'The final whistle has blown!', isHome: true, isGoal: false, score: remaining.score });
              }
            
              // Add sub commentary
              remaining.events.unshift({ min: currentMin, type: 'midfield', text: `ðŸ“‹ Tactical changes made. Play resumes.`, isHome: true, isGoal: false });
            
              // Second half injuries
              [...newHome, ...newAway].forEach(p => {
                if (!p.injured && Math.random() < 0.005) {
                  const tmObj = homeTeam.players.find(pl => pl.id === p.id) ? homeTeam : awayTeam;
                  const originalPlayer = tmObj.players.find(pl => pl.id === p.id);
                  if (originalPlayer) {
                    originalPlayer.injured = true;
                    const w = 1 + Math.floor(Math.random() * 4);
                    const injDate = new Date(date);
                    injDate.setDate(injDate.getDate() + w * 7);
                    originalPlayer.injuryUntil = injDate.toISOString();
                    remaining.events.push({ min: currentMin + Math.floor(Math.random() * (endMin - currentMin)), type: 'injury', text: `âš•ï¸ ${p.name} injured (${w} week${w > 1 ? 's' : ''})`, isHome: homeTeam.players.find(pl => pl.id === p.id) ? true : false, isGoal: false });
                  }
                }
              });
            
              remaining.events.sort((a, b) => a.min - b.min);
            
              // Update liveMatch
              setLiveMatch(prev => ({
                ...prev,
                events: [...(prev.events || []), ...remaining.events],
                scorers: remaining.scorers,
                finalScore: remaining.score,
                homePlayers: newHome,
                awayPlayers: newAway
              }));
            
              setTacticsPaused(false);
              setSelectedSlot(null);
            
              // Schedule remaining events
              const minutesLeft = endMin - currentMin;
              scheduleEvents(remaining.events, currentMin, minutesLeft);
            };
            
          const computeLiveRatings = (players, commentary, isHomeTeam) => {
          return players.map(p => {
            let rating = 6.0;
        
            commentary.forEach(ev => {
              if (!ev.playerId || ev.playerId !== p.id) return;
              // Only count events for the correct team
              if (ev.isHome !== isHomeTeam && ev.type !== 'defend') return;
              // Defend events have flipped isHome, so check opposite
              if (ev.type === 'defend' && ev.isHome !== isHomeTeam) return;
        
              switch (ev.type) {
                case 'goal':
                  rating += 1.0 + Math.random() * 0.3;
                  break;
                case 'assist':
                  rating += 0.6 + Math.random() * 0.2;
                  break;
                case 'chance':
                  rating += 0.15;
                  break;
                case 'defend':
                  rating += 0.3;
                  break;
                case 'midfield':
                  rating += 0.1;
                  break;
                case 'yellowCard':
                  rating -= 1;
                  break;
                case 'redCard':
                  rating -= 5.0;
                  break;
              }
            });
        
            // Clamp between 1 and 10
            rating = Math.max(1, Math.min(10, rating));
        
            return { ...p, matchRating: rating };
          });
        };
            
          const playMatch = () => {
          const next = getNext();
          if (!next) {
            alert('Season complete!');
            startNewSeason();
            return;
          }
          const lg = leagues[league];
          const h = next.homeTeamId === team.id ? team : lg.teams.find(t => t.id === next.homeTeamId);
          const a = next.awayTeamId === team.id ? team : lg.teams.find(t => t.id === next.awayTeamId);
        
          const getMatchPlayers = (tm) => {
            if (tm.id === team.id && Object.keys(startingXI).length > 0) {
              return Object.entries(startingXI).map(([key, playerId]) => {
                const player = tm.players.find(p => p.id === playerId);
                if (!player || player.injured) return null;
                const posIdx = parseInt(key.replace('pos', ''));
                const requiredPos = formations[formation].positions[posIdx];
                const inPosition = player.positions.includes(requiredPos);
                return { ...player, effectiveRating: inPosition ? player.rating : Math.max(1, player.rating - 5), matchRating: 6.0 + Math.random() * 1.0 };
              }).filter(p => p !== null);
            } else {
              return tm.players.filter(p => !p.injured).sort((a, b) => b.rating - a.rating).slice(0, 11).map(p => ({ ...p, effectiveRating: p.rating, matchRating: 6.0 + Math.random() * 1.0 }));
            }
          };
        
          const homePlayers = getMatchPlayers(h);
          const awayPlayers = getMatchPlayers(a);
        
          // Pre-generate FIRST HALF events
            const firstHalf = generateMatchEvents(homePlayers, awayPlayers, h, a, 1, 45, { home: 0, away: 0 }, []);
            
            firstHalf.events.unshift({ min: 0, type: 'start', text: 'Kick off!', isHome: true, isGoal: false });
            firstHalf.events.push({ min: 45, type: 'halftime', text: 'ðŸ• Half Time', isHome: true, isGoal: false });
            
            // First half injuries
            [...homePlayers, ...awayPlayers].forEach(p => {
              if (!p.injured && Math.random() < 0.005) {
                const tmObj = h.players.find(pl => pl.id === p.id) ? h : a;
                const originalPlayer = tmObj.players.find(pl => pl.id === p.id);
                if (originalPlayer) {
                  originalPlayer.injured = true;
                  const w = 1 + Math.floor(Math.random() * 4);
                  const injDate = new Date(date);
                  injDate.setDate(injDate.getDate() + w * 7);
                  originalPlayer.injuryUntil = injDate.toISOString();
                  firstHalf.events.push({ min: Math.floor(Math.random() * 40) + 1, type: 'injury', text: `âš•ï¸ ${p.name} injured (${w} week${w > 1 ? 's' : ''})`, isHome: h.players.find(pl => pl.id === p.id) ? true : false, isGoal: false });
                }
              }
            });
            
            firstHalf.events.sort((a, b) => a.min - b.min);
            
            setPreMatchXI({ ...startingXI });
            setLiveMatch({ homeTeam: h, awayTeam: a, events: firstHalf.events, scorers: firstHalf.scorers, finalScore: firstHalf.score, homePlayers, awayPlayers, fixture: next });
            setLiveMinute(0);
            setMatchEnded(false);
            setIsHalfTime(false);
            setTacticsPaused(false);
            setMatchHalf(1);
            setMatchSubs({ made: 0, max: 5 });
            setLiveCommentary([]);
            setLiveScore({ home: 0, away: 0 });
            setMatchPlayerRatings({ home: homePlayers, away: awayPlayers });
            setMatchTab('commentary');
            setState('live-match');
            
            scheduleEvents(firstHalf.events, 0, 45);
                      };

          const finishLiveMatch = () => {
          if (!liveMatch) return;
          const { homeTeam, awayTeam, scorers, finalScore, fixture } = liveMatch;
             const allEvents = liveMatch.events || [];
        
          // Update fixtures
          const uf = JSON.parse(JSON.stringify(fixtures));
          const idx = uf[league].findIndex(f => f.homeTeamId === fixture.homeTeamId && f.awayTeamId === fixture.awayTeamId && !f.played);
          if (idx !== -1) {
            uf[league][idx].played = true;
            uf[league][idx].homeScore = finalScore.home;
            uf[league][idx].awayScore = finalScore.away;
            uf[league][idx].scorers = scorers;
              scorers.forEach(sc => {
              const lg = leagues[league];
              const t = lg.teams.find(tm => tm.id === sc.teamId);
              if (t) {
                const p = t.players.find(pl => pl.id === sc.playerId);
                if (p) p.goals = (p.goals || 0) + 1;
                if (sc.assisterId) {
                  const a = t.players.find(pl => pl.id === sc.assisterId);
                  if (a) a.assists = (a.assists || 0) + 1;
                }
              }
            }
                             );
            
            // Credit cards from events
            allEvents.filter(ev => ev.cardType).forEach(ev => {
              const lg = leagues[league];
              const t = lg.teams.find(tm => tm.id === ev.teamId);
              if (t) {
                const p = t.players.find(pl => pl.id === ev.playerId);
                if (p) {
                  if (ev.cardType === 'yellow') p.yellowCards = (p.yellowCards || 0) + 1;
                  if (ev.cardType === 'red') p.redCards = (p.redCards || 0) + 1;
                }
              }
            });
                      }
        
          // Sim other matches
          Object.keys(leagues).forEach(lk => {
            const l = leagues[lk]; const lf = uf[lk]; if (!lf) return;
            const played = lf.filter(f => f.played).length;
            const md = Math.floor(played / (l.teams.length / 2)) + 1;
            lf.filter(f => f.matchday === md && !f.played).forEach(f => {
              const ht = l.teams.find(t => t.id === f.homeTeamId);
              const at = l.teams.find(t => t.id === f.awayTeamId);
              if (ht && at) {
                const r = simMatch(ht, at, true);
                f.played = true; f.homeScore = r.homeScore; f.awayScore = r.awayScore; f.scorers = r.scorers;
                r.scorers.forEach(sc => { const tm = l.teams.find(t => t.id === sc.teamId); if (tm) { const pl = tm.players.find(p => p.id === sc.playerId); if (pl) pl.goals = (pl.goals || 0) + 1; } });
              }
            });
          });
        
          setFixtures(uf);
        
         // --- PLAYER STATS TRACKING ---
            const season = getSeasonDisplay();
            const newHistories = { ...playerHistories };
            
            const matchPlayers = [...new Set(Object.values(startingXI))].filter(pid => {
              const p = team.players.find(pl => pl.id === pid);
              return p && !p.injured;
            });
            
            const finalHome = computeLiveRatings(liveMatch.homePlayers || [], liveCommentary, true);
            const finalAway = computeLiveRatings(liveMatch.awayPlayers || [], liveCommentary, false);
            const allMatchPlayers = [...finalHome, ...finalAway];
            
            let motmId = null, motmRating = 0;
            allMatchPlayers.filter(mp => matchPlayers.includes(mp.id)).forEach(mp => {
              if (mp.matchRating > motmRating) { motmRating = mp.matchRating; motmId = mp.id; }
            });
            
            matchPlayers.forEach(pid => {
              const key = `${pid}-${season}`;
              if (!newHistories[key]) newHistories[key] = {
                playerId: pid, season, apps: 0, goals: 0, assists: 0,
                yellowCards: 0, redCards: 0, totalRating: 0, matchCount: 0, motm: 0,
                team: team.name
              };
              newHistories[key].apps += 1;
              newHistories[key].team = team.name;
            
              const mp = allMatchPlayers.find(m => m.id === pid);
              if (mp) {
                newHistories[key].totalRating += mp.matchRating;
                newHistories[key].matchCount += 1;
              }
              if (pid === motmId) newHistories[key].motm += 1;
            });
            
            scorers.filter(sc => sc.teamId === team.id).forEach(sc => {
              const key = `${sc.playerId}-${season}`;
              if (newHistories[key]) newHistories[key].goals += 1;
            
              if (sc.assisterId) {
                const aKey = `${sc.assisterId}-${season}`;
                if (newHistories[aKey]) newHistories[aKey].assists += 1;
              }
            });
            
            allEvents.filter(ev => ev.cardType && ev.teamId === team.id).forEach(ev => {
              const key = `${ev.playerId}-${season}`;
              if (newHistories[key]) {
                if (ev.cardType === 'yellow') newHistories[key].yellowCards += 1;
                if (ev.cardType === 'red') newHistories[key].redCards += 1;
              }
            });
            
            setPlayerHistories(newHistories);
            // --- END PLAYER STATS TRACKING ---
        
          if (Math.random() < 0.15) generateIncomingOffers();
        
          // Advance date
          const nd = new Date(date);
          nd.setDate(nd.getDate() + 7);
          const seasonEndYear = date.getMonth() >= 7 ? date.getFullYear() + 1 : date.getFullYear();
          const seasonEnd = new Date(`${seasonEndYear}-07-31`);
          if (nd > seasonEnd) nd.setTime(seasonEnd.getTime());
          setDate(nd);
          healInjuredPlayers(nd);
        
          if (nd.getDate() === 1 || financeHistory.length === 0 || new Date(financeHistory[financeHistory.length - 1].date).getMonth() !== nd.getMonth()) {
            setFinanceHistory([...financeHistory, { date: nd.toISOString(), balance: team.budget }]);
          }
        
          // Set match result for display
          const isHome = fixture.homeTeamId === team.id;
          setMatch({
            opp: isHome ? awayTeam.name : homeTeam.name,
            ps: isHome ? finalScore.home : finalScore.away,
            os: isHome ? finalScore.away : finalScore.home,
            home: isHome
          });
          setCommentary(liveCommentary.reverse().map(e => `${e.min}' ${e.text}`));
        
          setStartingXI({ ...preMatchXI });
          setLiveMatch(null);
          setPage('home');
          setState('info-page');
        };
            const getScorers = (lk) => {
            const sc = [];
            leagues[lk].teams.forEach(t => { t.players.forEach(p => { if (p.goals > 0) sc.push({ name: p.name, team: t.name, goals: p.goals }); }); });
            sc.sort((a, b) => b.goals - a.goals); return sc.slice(0, 10);
          };

          const getSeasonDisplay = () => {
            if (date.getMonth() >= 7) return `${date.getFullYear()}/${date.getFullYear() + 1}`;
            return `${date.getFullYear() - 1}/${date.getFullYear()}`;
          };

          const getSeasonNumber = () => {
            if (date.getMonth() >= 7) return date.getFullYear() - 2024;
            return date.getFullYear() - 2025;
          };

          if (!db) return <div className="min-h-screen bg-gray-900 flex items-center justify-center"><div className="text-white">Loading...</div></div>;

          const renderShirt = (teamObj, size) => {
            const s = teamObj?.shirtStyle || 'plain';
            const c1 = teamObj?.primaryColor || '#1a1a2e';
            const c2 = teamObj?.secondaryColor || '#FFFFFF';
            const clipId = `hsc-${teamObj?.id}-${Math.random().toString(36).substr(2,5)}`;
            return (
              <svg viewBox="0 0 60 55" style={{ width: size || '80px', height: size ? undefined : '72px' }}>
                <defs><clipPath id={clipId}><path d="M10 18 L0 12 L5 0 L20 5 L22 0 L38 0 L40 5 L55 0 L60 12 L50 18 L50 50 L10 50 Z" /></clipPath></defs>
                <path d="M10 18 L0 12 L5 0 L20 5 L22 0 L38 0 L40 5 L55 0 L60 12 L50 18 L50 50 L10 50 Z" fill={c1} />
                <g clipPath={`url(#${clipId})`}>
                  {s === 'stripes' && <>{[4,14,24,34,44,54].map(x => <rect key={x} x={x} y="0" width="5" height="55" fill={c2} />)}</>}
                  {s === 'hoops' && <>{[5,15,25,35,45].map(y => <rect key={y} x="0" y={y} width="60" height="5" fill={c2} />)}</>}
                  {s === 'quarters' && <><rect x="30" y="0" width="30" height="25" fill={c2} /><rect x="0" y="25" width="30" height="30" fill={c2} /></>}
                  {s === 'sleeves' && <><path d="M0 12 L5 0 L20 5 L10 18 Z" fill={c2} /><path d="M60 12 L55 0 L40 5 L50 18 Z" fill={c2} /></>}
                  {s === 'sash' && <><path d="M0 12 L5 0 L20 5 L10 18 Z" fill={c2} /><path d="M60 12 L55 0 L40 5 L50 18 Z" fill={c2} /><polygon points="5,50 15,50 55,10 55,0 50,0 45,0 0,45 0,50" fill={c2} opacity="0.9" /></>}
                  {s === 'halves' && <><rect x="30" y="0" width="30" height="55" fill={c2} /><path d="M0 12 L5 0 L20 5 L10 18 Z" fill={c2} /><path d="M60 12 L55 0 L40 5 L50 18 Z" fill={c1} /></>}
                </g>
                <path d="M10 18 L0 12 L5 0 L20 5 L22 0 L38 0 L40 5 L55 0 L60 12 L50 18 L50 50 L10 50 Z" fill="none" stroke="rgba(255,255,255,0.4)" strokeWidth="0.8" />
              </svg>
            );
          };

          if (state === 'main-menu') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-gray-900 to-gray-800 flex items-center justify-center p-4">
                <div className="max-w-md w-full text-center">
                  <div className="w-24 h-24 mx-auto mb-6 text-green-500 flex items-center justify-center"><Trophy /></div>
                  <h1 className="text-5xl font-bold text-white mb-8">Title Challenge</h1>
                  <button onClick={newGame} className="w-full bg-green-600 text-white py-6 rounded-lg font-bold text-xl mb-4 hover:bg-green-700">New Game</button>
                  <button onClick={loadGame} disabled={!hasSaved()} className={`w-full py-6 rounded-lg font-bold text-xl ${hasSaved() ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-800 text-gray-600 cursor-not-allowed'}`}>Load Game</button>
                </div>
              </div>
            );
          }

          if (state === 'country-select')
          {
            const countries = [
              { key: 'england', name: 'England', flag: 'ðŸ´ó §ó ¢', tiers: 4 },
              { key: 'germany', name: 'Germany', flag: 'ðŸ‡©ðŸ‡ª', tiers: 2 },
              { key: 'spain', name: 'Spain', flag: 'ðŸ‡ªðŸ‡¸', tiers: 2 },
              { key: 'france', name: 'France', flag: 'ðŸ‡«ðŸ‡·', tiers: 2 },
              { key: 'italy', name: 'Italy', flag: 'ðŸ‡®ðŸ‡¹', tiers: 2 }
            ];
            return (
              <div className="min-h-screen bg-gray-900 p-4">
                <div className="max-w-4xl mx-auto pt-8">
                    <button onClick={() => setState('main-menu')} className="text-gray-400 mb-4 hover:text-white">â† Back</button>
                    <h1 className="text-4xl font-bold text-white mb-8 text-center">Choose Your Country</h1>
                    <div className="space-y-4">
                    {countries.map(c => (
                      <div key={c.key} onClick={() => selectCountry(c.key)} className="bg-gray-800 rounded-lg p-6 cursor-pointer hover:bg-gray-700">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-4">
                            <span className="text-5xl">{c.flag}</span>
                            <div>
                              <h2 className="text-2xl font-bold text-white">{c.name}</h2>
                              <p className="text-gray-400">{c.tiers} league tier{c.tiers > 1 ? 's' : ''}</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            );
          }

          if (state === 'league-select') {
            const countryLeagues = Object.keys(db).filter(lk => lk.startsWith(country));
            return (
              <div className="min-h-screen bg-gray-900 p-4">
                <div className="max-w-4xl mx-auto pt-8">
                  <button onClick={() => setState('country-select')} className="text-gray-400 mb-4 hover:text-white">â† Back</button>
                    <h1 className="text-4xl font-bold text-white mb-8 text-center">Choose Your League</h1>
                      <div className="space-y-4">
                    {countryLeagues.map(lk => (
                      <div key={lk} onClick={() => selectLeague(lk)} className="bg-gray-800 rounded-lg p-6 cursor-pointer hover:bg-gray-700">
                        <h2 className="text-2xl font-bold text-white">{db[lk].name}</h2>
                        <p className="text-gray-400">{db[lk].country} â€¢ {db[lk].teams.length} teams</p>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            );
          }

          if (state === 'team-select') {
            return (
              <div className="min-h-screen bg-gray-900 p-4">
                <div className="max-w-4xl mx-auto pt-8">
                    <button onClick={() => setState('league-select')} className="text-gray-400 mb-4 hover:text-white">â† Back</button>
                  <h1 className="text-4xl font-bold text-white mb-8 text-center">{db[league].name}</h1>
                  <div className="grid gap-4">
                    {db[league].teams.map(t => (
                      <div key={t.id} onClick={() => selectTeam(t)} className="bg-gray-800 rounded-lg p-6 cursor-pointer hover:bg-gray-700">
                        <h2 className="text-2xl font-bold text-white">{t.name}</h2>
                        <p className="text-gray-400">Squad: {t.players.length}</p>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            );
          }

          if (state === 'info-page') {
            const next = getNext();
            const tbl = getTable(league);
            const pos = tbl.findIndex(t => t.teamId === team.id);
            const ctx = tbl.slice(Math.max(0, pos - 2), Math.min(tbl.length, pos + 3));
            const opp = next ? (next.homeTeamId === team.id ? leagues[league].teams.find(t => t.id === next.awayTeamId) : leagues[league].teams.find(t => t.id === next.homeTeamId)) : null;

            return (
              <div className="min-h-screen bg-gray-900">
                <div className="p-4 flex justify-between items-center" style={{ backgroundColor: team.primaryColor || '#ea580c' }}>
                  <button onClick={() => setMenuOpen(!menuOpen)} style={{ color: ['#FFFFFF','#FFE114','#FDE100','#FDB913','#FCDD09','#FFD700','#8AC3EE','#87CEEB','#6CABDD','#95BFE5','#99D6EA','#65B32E'].includes(team.primaryColor) ? '#000' : '#fff' }}><Menu /></button>
                  <div className="text-center" style={{ color: ['#FFFFFF','#FFE114','#FDE100','#FDB913','#FCDD09','#FFD700','#8AC3EE','#87CEEB','#6CABDD','#95BFE5','#99D6EA','#65B32E'].includes(team.primaryColor) ? '#000' : '#fff' }}>
                    <div className="text-sm opacity-80">Season {getSeasonNumber()}</div>
                    <div className="font-bold">{getSeasonDisplay()}</div>
                  </div>
                  <div className="w-10"></div>
                </div>

                {menuOpen && (
                  <div className="fixed inset-0 bg-black/50 z-50" onClick={() => setMenuOpen(false)}>
                    <div className="bg-gray-800 w-64 h-full" onClick={(e) => e.stopPropagation()}>
                      <div className="p-4 space-y-2">
                        <h2 className="text-white font-bold mb-4">{team.name}</h2>
                        {[
                          { key: 'home', label: 'Home' },
                          { key: 'squad', label: 'Squad' },
                          { key: 'starting-xi', label: 'Tactics' },
                          { key: 'transfers', label: 'Transfers', action: () => { if (transferList.length === 0) generateTransferList(); } },
                          { key: 'finances', label: 'Finances' },
                          { key: 'facilities', label: 'Facilities' },
                          { key: 'table', label: 'League Table' },
                          { key: 'fixtures', label: 'Fixtures' },
                          { key: 'scorers', label: 'Stats Tables' },
                        ].map(p => (
                          <button key={p.key} onClick={() => { if (p.action) p.action(); setPage(p.key); setMenuOpen(false); }} className="w-full text-left text-white py-2 px-3 rounded hover:bg-gray-700">{p.label}</button>
                        ))}
                        <button onClick={() => setState('main-menu')} className="w-full text-left text-red-400 py-2 px-3 rounded hover:bg-gray-700">Exit</button>
                      </div>
                    </div>
                  </div>
                )}

                <div className="bg-gray-800 p-3 text-center border-b border-gray-700">
                  <div className="text-orange-500 text-sm">ðŸ“… {formatDate(date)}</div>
                </div>

                <div className="p-4 max-w-4xl mx-auto pb-24">
                  {page === 'home' && next && opp && (
                    <>
                      <div className="bg-gray-800 rounded-lg p-6 mb-4">
                        <div className="text-gray-400 text-sm mb-2">NEXT FIXTURE</div>
                        <div className="flex items-center justify-between">
                          <div className="text-center flex-1">
                            <div className="flex justify-center mb-2">{renderShirt(next.homeTeamId === team.id ? team : opp, '70px')}</div>
                            <div className="text-white font-bold text-lg cursor-pointer hover:text-orange-400" onClick={() => {
                            const t = next.homeTeamId === team.id ? team : opp;
                            setSelectedTeamProfile({ team: t, leagueKey: league }); setPage('team-profile');
                            }}>{next.homeTeamId === team.id ? team.name : opp.name}</div>
                            <div className="text-gray-500 text-sm">{next.homeTeamId === team.id ? pos + 1 : tbl.findIndex(t => t.teamId === opp.id) + 1}th</div>
                          </div>
                          <div className="text-gray-400 font-bold px-4 text-xl">vs</div>
                          <div className="text-center flex-1">
                            <div className="flex justify-center mb-2">{renderShirt(next.awayTeamId === team.id ? team : opp, '70px')}</div>
                            <div className="text-white font-bold text-lg cursor-pointer hover:text-orange-400" onClick={() => {
                            const t = next.awayTeamId === team.id ? team : opp;
                            setSelectedTeamProfile({ team: t, leagueKey: league }); setPage('team-profile');
                            }}>{next.awayTeamId === team.id ? team.name : opp.name}</div>
                            <div className="text-gray-500 text-sm">{next.awayTeamId === team.id ? pos + 1 : tbl.findIndex(t => t.teamId === opp.id) + 1}th</div>
                          </div>
                        </div>
                      </div>

                      <div className="bg-gray-800 rounded-lg p-4 mb-4">
                        <div className="flex justify-between mb-3">
                          <h3 className="text-white font-bold">League Table</h3>
                          <button onClick={() => setPage('table')} className="text-orange-500 text-sm">View Full â†’</button>
                        </div>
                        <table className="w-full text-sm">
                          <thead><tr className="text-gray-500 text-xs"><th className="text-left">Pos</th><th className="text-left">Team</th><th className="text-center">Pld</th><th className="text-center">GD</th><th className="text-center">Pts</th></tr></thead>
                          <tbody>
                            {ctx.map(t => (
                              <tr key={t.teamId} className={t.teamId === team.id ? 'bg-green-900/30' : ''}>
                                <td className="text-white py-2">{tbl.findIndex(x => x.teamId === t.teamId) + 1}</td>
                                <td className="text-white font-semibold">{t.name}</td>
                                <td className="text-center text-gray-400">{t.played}</td>
                                <td className="text-center text-gray-400">{t.goalsFor - t.goalsAgainst}</td>
                                <td className="text-center text-white font-bold">{t.points}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>

                      <div className="bg-gray-800 rounded-lg p-4 mb-4">
                        <div className="text-gray-400 text-sm mb-1">Finances: Balance</div>
                          <div className="bg-gray-800 rounded-lg p-4 mb-4">
                          <div className="text-gray-400 text-sm mb-1">Board Objective</div>
                          <div className="text-white font-bold text-xl">{(() => {
                            const myStrength = getTeamStrength(team);
                            const leagueTeams = leagues[league].teams.map(t => ({
                              id: t.id,
                              strength: getTeamStrength(t)
                            })).sort((a, b) => b.strength - a.strength);
                            const rank = leagueTeams.findIndex(t => t.id === team.id) + 1;
                            const total = leagueTeams.length;
                            const pct = rank / total;
                            if (pct <= 0.1) return 'ðŸ† Win the league';
                            if (pct <= 0.2) return 'ðŸ¥‡ Challenge for the title';
                            if (pct <= 0.3) return 'â­ Top 4 finish';
                            if (pct <= 0.5) return 'ðŸ“ˆ Top half finish';
                            if (pct <= 0.7) return 'ðŸ“Š Mid-table finish';
                            if (pct <= 0.85) return 'âš ï¸ Avoid relegation';
                            return 'ðŸ”´ Survival';
                          })()}</div>
                          <div className="text-gray-500 text-xs mt-1">Based on squad strength ranking in {leagues[league].name}</div>
                        </div>
                        <div className="text-white font-bold text-3xl cursor-pointer hover:text-orange-500 transition" onClick={() => setPage('finances')}>{formatCurrency(team.budget)}</div>
                      </div>
                    </>
                  )}

                  {page === 'home' && !next && (
                    <div className="bg-gray-800 rounded-lg p-6 mb-4 text-center">
                      <h2 className="text-white font-bold text-2xl mb-2">Season Complete!</h2>
                      <p className="text-gray-400 mb-4">
                        Final position: {pos + 1}{pos === 0 ? 'st' : pos === 1 ? 'nd' : pos === 2 ? 'rd' : 'th'}
                        {pos < 2 && <span className="block text-green-400 mt-2">ðŸŽ‰ Promotion zone!</span>}
                        {pos >= tbl.length - 3 && <span className="block text-red-400 mt-2">âš ï¸ Relegation zone</span>}
                      </p>
                      <button onClick={startNewSeason} className="bg-green-600 text-white py-3 px-8 rounded-lg font-bold hover:bg-green-700">Start New Season</button>
                    </div>
                  )}

                  {page === 'starting-xi' && (() => {
                    const formationLayouts = {
                      '4-3-3': [
                        { x: 50, y: 92 },
                        { x: 12, y: 74 }, { x: 37, y: 77 }, { x: 63, y: 77 }, { x: 88, y: 74 },
                        { x: 50, y: 56 }, { x: 25, y: 50 }, { x: 75, y: 50 },
                        { x: 15, y: 28 }, { x: 85, y: 28 }, { x: 50, y: 22 }
                      ],
                      '4-4-2': [
                        { x: 50, y: 92 },
                        { x: 12, y: 74 }, { x: 37, y: 77 }, { x: 63, y: 77 }, { x: 88, y: 74 },
                        { x: 15, y: 50 }, { x: 40, y: 53 }, { x: 60, y: 53 }, { x: 85, y: 50 },
                        { x: 35, y: 22 }, { x: 65, y: 22 }
                      ],
                      '4-2-3-1': [
                        { x: 50, y: 92 },
                        { x: 12, y: 74 }, { x: 37, y: 77 }, { x: 63, y: 77 }, { x: 88, y: 74 },
                        { x: 35, y: 58 }, { x: 65, y: 58 },
                        { x: 15, y: 38 }, { x: 50, y: 40 }, { x: 85, y: 38 },
                        { x: 50, y: 20 }
                      ],
                      '3-5-2': [
                        { x: 50, y: 92 },
                        { x: 25, y: 77 }, { x: 50, y: 77 }, { x: 75, y: 77 },
                        { x: 10, y: 53 }, { x: 90, y: 53 },
                        { x: 30, y: 48 }, { x: 50, y: 45 }, { x: 70, y: 48 },
                        { x: 35, y: 22 }, { x: 65, y: 22 }
                      ]
                    };

                    const layout = formationLayouts[formation];
                    const availablePlayers = team.players.filter(p => !p.injured);
                    const benchPlayers = availablePlayers.filter(p => !Object.values(startingXI).includes(p.id));

                    const handleSlotClick = (idx) => {
                      if (selectedSlot === idx) { setSelectedSlot(null); return; }
                      if (selectedSlot !== null) {
                        const xi = { ...startingXI };
                        const temp = xi[`pos${selectedSlot}`];
                        xi[`pos${selectedSlot}`] = xi[`pos${idx}`];
                        xi[`pos${idx}`] = temp;
                        setStartingXI(xi);
                        setSelectedSlot(null);
                      } else {
                        setSelectedSlot(idx);
                      }
                    };

                    const handleBenchToSlot = (playerId, slotIdx) => {
                      const xi = { ...startingXI };
                      const existingSlot = Object.entries(xi).find(([k, v]) => v === playerId);
                      if (existingSlot) xi[existingSlot[0]] = xi[`pos${slotIdx}`];
                      xi[`pos${slotIdx}`] = playerId;
                      setStartingXI(xi);
                      setSelectedSlot(null);
                      setShowBench(false);
                    };

                    const handleBenchClick = (playerId) => {
                      if (selectedSlot !== null) handleBenchToSlot(playerId, selectedSlot);
                    };

                    const autoFillBest = () => {
                      const xi = {};
                      formations[formation].positions.forEach((pos, idx) => {
                        const eligible = team.players.filter(p => p.positions.includes(pos) && !Object.values(xi).includes(p.id) && !p.injured);
                        if (eligible.length > 0) xi[`pos${idx}`] = eligible.sort((a, b) => b.rating - a.rating)[0].id;
                      });
                      setStartingXI(xi);
                    };

                    const style = team.shirtStyle || 'plain';
                    const pc = team.primaryColor || '#1a1a2e';
                    const sc = team.secondaryColor || '#FFFFFF';
                    const gkColor = '#2d8a4e';

                    const ShirtSvg = ({ number, isGK, isOOP }) => {
                      const clipId = `sc${number}-${Math.random().toString(36).substr(2,5)}`;
                      const c1 = isGK ? gkColor : isOOP ? '#b45309' : pc;
                      const c2 = isGK ? '#1a6b30' : isOOP ? '#92400e' : sc;
                      const s = isGK ? 'plain' : isOOP ? 'plain' : style;
                      const dark = ['#000000','#00205B','#1a1a2e','#1B458F','#034694','#003399','#1D428A','#132257','#231F20','#241F20','#012B4A','#00225C','#122336','#0A2452','#1A2F6B','#10274f','#022663','#6D2C34','#7A263A','#670E36','#6C1D45','#5B2D8E','#781D2A','#004D98','#012C57','#99022C','#00205B','#003DA5','#004FA3','#0054A6','#0055A4','#245701','#2B6303','#1D2CCF','#00296B','#003D7C','#DD0000','#DC052D','#ED1C24','#E2001A','#E32221','#CB3524','#E20613','#D91A2A','#C8102E','#DA291C','#e30613','#EB172B','#EE2523','#E7192F','#E1000F','#ED0000','#6B3524','#c22538','#1B2A4A','#0068A8','#FB090B','#1E71B8','#A31E2D','#A50044','#D40027','#CD2534','#00954C','#12A0D7','#F47920','#E2001A','#6A2382','#00843D'].includes(c1);
                      const light = ['#FFFFFF','#FFE114','#FDE100','#FDB913','#FCDD09','#FFD700','#8AC3EE','#87CEEB','#6CABDD','#95BFE5','#99D6EA','#65B32E'].includes(c1);
                      const txtCol = isGK ? '#FFFFFF' : dark ? '#FFFFFF' : light ? '#000000' : '#FFFFFF';
                      return (
                        <svg viewBox="0 0 60 55" style={{ width: '100%', height: '100%' }}>
                          <defs><clipPath id={clipId}><path d="M10 18 L0 12 L5 0 L20 5 L22 0 L38 0 L40 5 L55 0 L60 12 L50 18 L50 50 L10 50 Z" /></clipPath></defs>
                          <path d="M10 18 L0 12 L5 0 L20 5 L22 0 L38 0 L40 5 L55 0 L60 12 L50 18 L50 50 L10 50 Z" fill={c1} />
                          <g clipPath={`url(#${clipId})`}>
                            {s === 'stripes' && <>{[4,14,24,34,44,54].map(x => <rect key={x} x={x} y="0" width="5" height="55" fill={c2} />)}</>}
                            {s === 'hoops' && <>{[5,15,25,35,45].map(y => <rect key={y} x="0" y={y} width="60" height="5" fill={c2} />)}</>}
                            {s === 'quarters' && <><rect x="30" y="0" width="30" height="25" fill={c2} /><rect x="0" y="25" width="30" height="30" fill={c2} /></>}
                            {s === 'sleeves' && <><path d="M0 12 L5 0 L20 5 L10 18 Z" fill={c2} /><path d="M60 12 L55 0 L40 5 L50 18 Z" fill={c2} /></>}
                            {s === 'sash' && <><path d="M0 12 L5 0 L20 5 L10 18 Z" fill={c2} /><path d="M60 12 L55 0 L40 5 L50 18 Z" fill={c2} /><polygon points="5,50 15,50 55,10 55,0 50,0 45,0 0,45 0,50" fill={c2} opacity="0.9" /></>}
                            {s === 'halves' && <><rect x="30" y="0" width="30" height="55" fill={c2} /><path d="M0 12 L5 0 L20 5 L10 18 Z" fill={c2} /><path d="M60 12 L55 0 L40 5 L50 18 Z" fill={c1} /></>}
                          </g>
                          <path d="M10 18 L0 12 L5 0 L20 5 L22 0 L38 0 L40 5 L55 0 L60 12 L50 18 L50 50 L10 50 Z" fill="none" stroke="rgba(255,255,255,0.6)" strokeWidth="1" />
                          <text x="30" y="36" textAnchor="middle" fill={txtCol} fontSize="18" fontWeight="bold" fontFamily="Arial" stroke={txtCol === '#FFFFFF' ? 'rgba(0,0,0,0.3)' : 'rgba(255,255,255,0.3)'} strokeWidth="0.5">{number}</text>
                        </svg>
                      );
                    };

                    return (
                      <div>
                        <div className="bg-gray-800 rounded-t-lg p-3 flex justify-between items-center border-b border-gray-700">
                          <div>
                            <h2 className="text-white font-bold text-lg">{team.name}</h2>
                            <p className="text-gray-400 text-xs">Tactics</p>
                          </div>
                          </div>

                        <div className="bg-gray-800 p-3 border-b border-gray-700">
                          <div className="flex gap-2 items-center">
                            {Object.keys(formations).map(f => (
                              <button key={f} onClick={() => {
                                setFormation(f);
                                const xi = {};
                                formations[f].positions.forEach((pos, idx) => {
                                  const eligible = team.players.filter(p => p.positions.includes(pos) && !Object.values(xi).includes(p.id) && !p.injured);
                                  if (eligible.length > 0) xi[`pos${idx}`] = eligible.sort((a, b) => b.rating - a.rating)[0].id;
                                });
                                setStartingXI(xi);
                                setSelectedSlot(null);
                              }} className={`px-3 py-1.5 rounded text-xs font-bold ${formation === f ? 'bg-orange-600 text-white' : 'bg-gray-700 text-gray-400'}`}>{f}</button>
                            ))}
                            <button onClick={autoFillBest} className="ml-auto px-3 py-1.5 rounded bg-gray-700 text-gray-300 text-xs font-bold hover:bg-gray-600">âš¡ Auto</button>
                          </div>
                        </div>

                        {(() => {
                          const next = getNext();
                          if (!next) return null;
                          const tbl = getTable(league);
                          const opp = next.homeTeamId === team.id ? leagues[league].teams.find(t => t.id === next.awayTeamId) : leagues[league].teams.find(t => t.id === next.homeTeamId);
                          const oppPos = tbl.findIndex(t => t.teamId === opp?.id) + 1;
                          const homeAway = next.homeTeamId === team.id ? 'Home' : 'Away';
                          const ordinal = oppPos === 1 ? 'st' : oppPos === 2 ? 'nd' : oppPos === 3 ? 'rd' : 'th';
                          return (
                            <div className="bg-green-900/60 px-3 py-2 text-center">
                              <p className="text-green-300 text-xs font-semibold">Next fixture: {homeAway} to {opp?.name} ({oppPos}{ordinal})</p>
                            </div>
                          );
                        })()}

                        <div className="relative w-full" style={{ paddingBottom: '140%', background: 'linear-gradient(180deg, #2d5a1e 0%, #357a24 8%, #2d5a1e 16%, #357a24 24%, #2d5a1e 32%, #357a24 40%, #2d5a1e 48%, #357a24 56%, #2d5a1e 64%, #357a24 72%, #2d5a1e 80%, #357a24 88%, #2d5a1e 100%)' }}>
                          <div className="absolute inset-0">
                            <svg viewBox="0 0 100 140" className="absolute inset-0 w-full h-full">
                              <rect x="2" y="2" width="96" height="136" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="0.4" />
                              <line x1="2" y1="70" x2="98" y2="70" stroke="rgba(255,255,255,0.2)" strokeWidth="0.3" />
                              <circle cx="50" cy="70" r="10" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="0.3" />
                              <circle cx="50" cy="70" r="0.6" fill="rgba(255,255,255,0.2)" />
                              <rect x="25" y="2" width="50" height="18" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="0.3" />
                              <rect x="35" y="2" width="30" height="7" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="0.3" />
                              <rect x="25" y="120" width="50" height="18" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="0.3" />
                              <rect x="35" y="131" width="30" height="7" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="0.3" />
                              <path d="M 35 20 A 12 12 0 0 0 65 20" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="0.3" />
                              <path d="M 35 120 A 12 12 0 0 1 65 120" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="0.3" />
                            </svg>

                            {layout.map((pos, idx) => {
                              const playerId = startingXI[`pos${idx}`];
                              const player = playerId ? team.players.find(p => p.id === playerId) : null;
                              const requiredPos = formations[formation].positions[idx];
                              const isGK = requiredPos === 'GK';
                              const isOutOfPosition = player && !player.positions.includes(requiredPos);
                              const isSelected = selectedSlot === idx;

                              const posAbbrevs = player ? player.positions.map(p => {
                                const map = { 'GK':'G', 'LB':'DL', 'RB':'DR', 'CB':'DC', 'CDM':'MC', 'CM':'MC', 'CAM':'AC', 'LW':'ALC', 'RW':'ARC', 'ST':'A' };
                                return map[p] || p;
                              }).join(' ') : '';

                              const shirtNum = player ? (idx + 1) : '?';
                              const surname = player ? player.name.split(' ').pop() : requiredPos;

                              return (
                                <div key={idx} onClick={() => handleSlotClick(idx)} className="absolute flex flex-col items-center cursor-pointer" style={{ left: `${pos.x}%`, top: `${pos.y / 140 * 100}%`, transform: 'translate(-50%, -50%)', zIndex: isSelected ? 20 : 10, width: '18%' }}>
                                  <div className={`relative transition-transform ${isSelected ? 'scale-110' : ''}`} style={{ width: '42px', height: '38px' }}>
                                    <ShirtSvg number={shirtNum} isGK={isGK} isOOP={isOutOfPosition && !!player} />
                                    {isSelected && <div className="absolute inset-0 rounded" style={{ boxShadow: '0 0 12px rgba(249,115,22,0.8)' }}></div>}
                                  </div>
                                  <div className="text-white text-center font-bold leading-tight mt-0.5 cursor-pointer" style={{ fontSize: '8px', textShadow: '0 1px 3px rgba(0,0,0,0.9)' }} onClick={(e) => { if (player) { e.stopPropagation(); setSelectedPlayer(player); setSelectedPlayerTeam(team); setPage('player-profile'); }}}>{surname}</div>
                                  <div className="text-gray-300 text-center leading-tight" style={{ fontSize: '7px', textShadow: '0 1px 2px rgba(0,0,0,0.8)' }}>{player ? posAbbrevs : ''}</div>
                                  {isOutOfPosition && player && (<div style={{ fontSize: '8px' }} className="text-yellow-400">âš ï¸</div>)}
                                </div>
                              );
                            })}
                          </div>
                        </div>

                        {selectedSlot !== null && (
                          <div className="bg-orange-900/40 px-3 py-2 text-center">
                            <p className="text-orange-300 text-xs font-semibold">Tap a bench player to place them, or tap another shirt to swap</p>
                          </div>
                        )}

                      <div className="bg-gray-800 rounded-b-lg p-4">
                          <h3 className="text-white font-bold mb-3">Substitutes</h3>
                          <div className="space-y-2 max-h-64 overflow-y-auto">
                              {benchPlayers.map(p => {
                          const bestSlot = selectedSlot !== null ? formations[formation].positions[selectedSlot] : null;
                          const fitsSelected = bestSlot && p.positions.includes(bestSlot);
                          return (
                              <div key={p.id} onClick={() => handleBenchClick(p.id)} className={`rounded p-2 flex items-center gap-3 transition-all ${selectedSlot !== null ? fitsSelected ? 'bg-green-900/40 cursor-pointer ring-1 ring-green-500' : 'bg-gray-700 cursor-pointer hover:bg-gray-600' : 'bg-gray-700'}`}>
                                  <div style={{ width: '32px', height: '28px', flexShrink: 0 }}>
                                      <ShirtSvg number={p.rating} isGK={p.positions.includes('GK')} isOOP={false} />
                                  </div>
                                  <div className="flex-1 min-w-0">
                                      <div className="text-white font-semibold text-sm truncate">{p.name}</div>
                                      <div className="text-gray-400 text-xs">{p.positions.join('/')} â€¢ Age {calcAge(p.dob)}</div>
                                  </div>
                                  {selectedSlot !== null && fitsSelected && <span className="text-green-400 text-xs font-bold">âœ“</span>}
                              </div>
                          );
                      })}
                              {benchPlayers.length === 0 && <p className="text-gray-500 text-sm">All players in starting XI</p>}
                          </div>
                          </div>
                      </div>
                          );
                        })()}

{page === 'team-profile' && selectedTeamProfile && (() => {
  const tp = selectedTeamProfile.team;
  const lk = selectedTeamProfile.leagueKey;
  const tbl = getTable(lk);
  const tblRow = tbl.find(t => t.teamId === tp.id);
  const posIdx = tbl.findIndex(t => t.teamId === tp.id);
  const posLabel = posIdx >= 0 ? `${posIdx + 1}${posIdx === 0 ? 'st' : posIdx === 1 ? 'nd' : posIdx === 2 ? 'rd' : 'th'}` : '-';
  const isMyTeam = tp.id === team.id;

   // Star player = highest rated
  const starPlayer = [...tp.players].sort((a, b) => b.rating - a.rating)[0];

  // Last result
  const teamFixtures = (fixtures[lk] || []).filter(f => (f.homeTeamId === tp.id || f.awayTeamId === tp.id) && f.played);
  const lastMatch = teamFixtures.length > 0 ? teamFixtures[teamFixtures.length - 1] : null;

  // Next fixture
  const nextMatch = (fixtures[lk] || []).find(f => !f.played && (f.homeTeamId === tp.id || f.awayTeamId === tp.id));
  const nextOpp = nextMatch ? (nextMatch.homeTeamId === tp.id ? leagues[lk].teams.find(t => t.id === nextMatch.awayTeamId) : leagues[lk].teams.find(t => t.id === nextMatch.homeTeamId)) : null;
  const nextHomeAway = nextMatch ? (nextMatch.homeTeamId === tp.id ? 'Home' : 'Away') : '';

  const lastOpp = lastMatch ? (lastMatch.homeTeamId === tp.id ? leagues[lk].teams.find(t => t.id === lastMatch.awayTeamId) : leagues[lk].teams.find(t => t.id === lastMatch.homeTeamId)) : null;
  const lastScore = lastMatch ? (lastMatch.homeTeamId === tp.id ? `${lastMatch.homeScore} - ${lastMatch.awayScore}` : `${lastMatch.awayScore} - ${lastMatch.homeScore}`) : null;
  const lastHomeAway = lastMatch ? (lastMatch.homeTeamId === tp.id ? 'Home' : 'Away') : '';
  const lastResult = lastMatch ? (
    (lastMatch.homeTeamId === tp.id && lastMatch.homeScore > lastMatch.awayScore) ||
    (lastMatch.awayTeamId === tp.id && lastMatch.awayScore > lastMatch.homeScore) ? 'W' :
    lastMatch.homeScore === lastMatch.awayScore ? 'D' : 'L'
  ) : null;

  // Board objective
  const getBoardObjective = () => {
  const teamStrength = getTeamStrength(tp);
  const leagueTeams = leagues[lk].teams.map(t => ({
    id: t.id,
    strength: getTeamStrength(t)
  })).sort((a, b) => b.strength - a.strength);
  const rank = leagueTeams.findIndex(t => t.id === tp.id) + 1;
  const total = leagueTeams.length;
  const pct = rank / total;

  if (pct <= 0.1) return 'Win the league';
  if (pct <= 0.2) return 'Challenge for the title';
  if (pct <= 0.3) return 'Top 4 finish';
  if (pct <= 0.5) return 'Top half finish';
  if (pct <= 0.7) return 'Mid-table finish';
  if (pct <= 0.85) return 'Avoid relegation';
  return 'Survival';
};

  return (
    <div>
      {/* Header */}
      <div className="bg-gray-800 rounded-t-lg p-3 flex items-center gap-3 border-b border-gray-700">
        <button onClick={() => setPage('table')} className="text-gray-400 hover:text-white">â† Back</button>
        <h2 className="text-white font-bold">Club Profile</h2>
      </div>

      {/* Club info card */}
      <div className="bg-gray-800 p-4 flex items-center gap-4">
        <div className="flex-shrink-0">{renderShirt(tp, '100px')}</div>
        <div>
          <h2 className="text-white font-bold text-xl">{tp.name}</h2>
          <p className="text-gray-400 text-sm">{tp.stadiumName || 'Stadium'} ({(tp.stadiumCapacity || 0).toLocaleString()})</p>
          <p className="text-gray-400 text-sm">{leagues[lk].name}</p>
          <p className="text-gray-400 text-sm">Board: {getBoardObjective()}</p>
        </div>
      </div>

      {/* Current Season stats */}
      <div className="bg-gray-800 border-t border-gray-700 p-4">
        <h3 className="text-gray-500 text-xs mb-3">Current Season</h3>
        <div className="grid grid-cols-7 gap-1 text-center">
          <div><p className="text-gray-500 text-xs">Pos</p><p className="text-white font-bold text-lg">{posLabel}</p></div>
          <div><p className="text-gray-500 text-xs">Pld</p><p className="text-white font-bold text-lg">{tblRow?.played || 0}</p></div>
          <div><p className="text-gray-500 text-xs">Won</p><p className="text-white font-bold text-lg">{tblRow?.won || 0}</p></div>
          <div><p className="text-gray-500 text-xs">Lost</p><p className="text-white font-bold text-lg">{tblRow?.lost || 0}</p></div>
          <div><p className="text-gray-500 text-xs">Draw</p><p className="text-white font-bold text-lg">{tblRow?.drawn || 0}</p></div>
          <div><p className="text-gray-500 text-xs">GD</p><p className="text-white font-bold text-lg">{tblRow ? tblRow.goalsFor - tblRow.goalsAgainst : 0}</p></div>
          <div><p className="text-gray-500 text-xs">Pts</p><p className="text-white font-bold text-lg">{tblRow?.points || 0}</p></div>
        </div>
      </div>

      {/* Last Result & Next Fixture */}
      <div className="bg-gray-800 border-t border-gray-700 grid grid-cols-2">
        <div className="p-4 border-r border-gray-700">
          <h3 className="text-gray-500 text-xs mb-2">Last Result</h3>
          {lastMatch ? (
            <div className="flex items-center gap-2">
              <div className="flex-shrink-0">{renderShirt(lastOpp, '40px')}</div>
              <div>
                <p className={`font-bold text-lg ${lastResult === 'W' ? 'text-green-400' : lastResult === 'L' ? 'text-red-400' : 'text-yellow-400'}`}>{lastScore}</p>
                <p className="text-gray-400 text-xs">{lastOpp?.name}</p>
                <p className="text-gray-500 text-xs">{lastHomeAway}</p>
              </div>
            </div>
          ) : (
            <p className="text-gray-500 text-sm">No matches played</p>
          )}
        </div>
        <div className="p-4">
          <h3 className="text-gray-500 text-xs mb-2">Next Fixture</h3>
          {nextMatch ? (
            <div className="flex items-center gap-2">
              <div className="flex-shrink-0">{renderShirt(nextOpp, '40px')}</div>
              <div>
                <p className="text-white font-bold">Vs</p>
                <p className="text-gray-400 text-xs">{nextOpp?.name}</p>
                <p className="text-gray-500 text-xs">{nextHomeAway}</p>
              </div>
            </div>
          ) : (
            <p className="text-gray-500 text-sm">Season complete</p>
          )}
        </div>
      </div>

      {/* Star Player */}
      {starPlayer && (
        <div className="bg-gray-800 border-t border-gray-700 p-4 rounded-b-lg">
          <h3 className="text-gray-500 text-xs mb-2">Star Player</h3>
          <div className="flex items-center gap-3 cursor-pointer" onClick={() => {
           setSelectedPlayer(starPlayer); setSelectedPlayerTeam(tp); setPage('player-profile');
          }}>
            <div className="flex-shrink-0">{renderShirt(tp, '50px')}</div>
            <div className="flex-1">
              <p className="text-white font-bold">{starPlayer.name}</p>
              <p className="text-orange-400 text-sm">{starPlayer.positions.join(', ')}</p>
              <p className="text-gray-400 text-xs">{tp.name}</p>
            </div>
            <div className="text-right">
              <div className="flex items-center gap-2">
                <span className="text-gray-400 text-xs border border-gray-600 rounded px-1">Age {calcAge(starPlayer.dob)}</span>
                <span className="text-white font-bold text-sm">{formatCurrency(calculatePlayerValue(starPlayer, date, getLeagueTier(lk)))}</span>
              </div>
              <div className="mt-1">
                <StarDisplay rating={starPlayer.rating} />
              </div>
              <div className="grid grid-cols-3 gap-2 mt-1 text-center">
                <div><p className="text-gray-500" style={{ fontSize: '9px' }}>App</p><p className="text-white text-xs font-bold">{starPlayer.goals !== undefined ? (tblRow?.played || 0) : 0}</p></div>
                <div><p className="text-gray-500" style={{ fontSize: '9px' }}>Gls</p><p className="text-white text-xs font-bold">{starPlayer.goals || 0}</p></div>
                <div><p className="text-gray-500" style={{ fontSize: '9px' }}>Rtg</p><p className="text-white text-xs font-bold">{starPlayer.rating}</p></div>
              </div>
            </div>
          </div>
        </div>
      )}
        
        {/* Squad list */}
        <div className="bg-gray-800 border-t border-gray-700 p-4">
          <h3 className="text-gray-500 text-xs mb-2">Squad ({tp.players.length} players)</h3>
          <div className="space-y-1 max-h-64 overflow-y-auto">
            {[...tp.players].sort((a, b) => b.rating - a.rating).map(p => (
              <div key={p.id} className="flex items-center justify-between py-1 cursor-pointer hover:bg-gray-700 rounded px-2" onClick={() => { setSelectedPlayer(p); setSelectedPlayerTeam(tp); setPage('player-profile'); }}>
                <div className="flex-1 min-w-0">
                  <span className="text-white text-sm">{p.name}</span>
                  <span className="text-gray-500 text-xs ml-2">{p.positions.join('/')}</span>
                </div>
                <div className="flex items-center gap-2">
                  <StarDisplay rating={p.rating} />
                  <span className="text-gray-400 text-xs">Age {calcAge(p.dob)}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
        
      {/* View Squad button for own team */}
      {isMyTeam && (
        <div className="mt-4">
          <button onClick={() => setPage('squad')} className="w-full bg-orange-600 text-white py-3 rounded-lg font-bold hover:bg-orange-700">View Squad</button>
        </div>
      )}
    </div>
  );
})()}
                    
                    {page === 'player-profile' && selectedPlayer && (() => {
                    const p = selectedPlayer;
                    const profileTeam = selectedPlayerTeam || team;
                    const age = calcAge(p.dob);
                    const value = calculatePlayerValue(p, date, getLeagueTier(league));
                    const season = getSeasonDisplay();
  
                      // Get all seasons for this player
                      const allSeasons = Object.values(playerHistories)
                        .filter(h => h.playerId === p.id)
                        .sort((a, b) => {
                          const aYear = parseInt(a.season.split('/')[0]);
                          const bYear = parseInt(b.season.split('/')[0]);
                          return bYear - aYear;
                        });
  
                      const currentSeason = allSeasons.find(h => h.season === season) || { apps: 0, goals: 0 };
                      
                          
                      const ShirtLarge = () => {
                        const style = profileTeam.shirtStyle || 'plain';
                        const c1 = profileTeam.primaryColor || '#1a1a2e';
                        const c2 = profileTeam.secondaryColor || '#FFFFFF';
                        const clipId = `profile-${Math.random().toString(36).substr(2,5)}`;
                        const dark = ['#000000','#00205B','#1a1a2e','#1B458F','#034694','#003399','#1D428A','#132257','#231F20','#241F20','#012B4A','#00225C','#122336','#0A2452','#1A2F6B','#10274f','#022663','#6D2C34','#7A263A','#670E36','#6C1D45','#5B2D8E','#781D2A','#004D98','#012C57','#99022C','#00205B','#003DA5','#004FA3','#0054A6','#0055A4','#245701','#2B6303','#1D2CCF','#00296B','#003D7C','#DD0000','#DC052D','#ED1C24','#E2001A','#E32221','#CB3524','#E20613','#D91A2A','#C8102E','#DA291C','#e30613','#EB172B','#EE2523','#E7192F','#E1000F','#ED0000','#6B3524','#c22538','#1B2A4A','#0068A8','#FB090B','#1E71B8','#A31E2D','#A50044','#D40027','#CD2534','#00954C','#12A0D7','#F47920','#E2001A','#6A2382','#00843D'].includes(c1);
                        const light = ['#FFFFFF','#FFE114','#FDE100','#FDB913','#FCDD09','#FFD700','#8AC3EE','#87CEEB','#6CABDD','#95BFE5','#99D6EA','#65B32E'].includes(c1);
                        const txtCol = dark ? '#FFFFFF' : light ? '#000000' : '#FFFFFF';
                        return (
                          <svg viewBox="0 0 60 55" style={{ width: '120px' }}>
                            <defs><clipPath id={clipId}><path d="M10 18 L0 12 L5 0 L20 5 L22 0 L38 0 L40 5 L55 0 L60 12 L50 18 L50 50 L10 50 Z" /></clipPath></defs>
                            <path d="M10 18 L0 12 L5 0 L20 5 L22 0 L38 0 L40 5 L55 0 L60 12 L50 18 L50 50 L10 50 Z" fill={c1} />
                            <g clipPath={`url(#${clipId})`}>
                              {style === 'stripes' && <>{[4,14,24,34,44,54].map(x => <rect key={x} x={x} y="0" width="5" height="55" fill={c2} />)}</>}
                              {style === 'hoops' && <>{[5,15,25,35,45].map(y => <rect key={y} x="0" y={y} width="60" height="5" fill={c2} />)}</>}
                              {style === 'quarters' && <><rect x="30" y="0" width="30" height="25" fill={c2} /><rect x="0" y="25" width="30" height="30" fill={c2} /></>}
                              {style === 'sleeves' && <><path d="M0 12 L5 0 L20 5 L10 18 Z" fill={c2} /><path d="M60 12 L55 0 L40 5 L50 18 Z" fill={c2} /></>}
                              {style === 'sash' && <><path d="M0 12 L5 0 L20 5 L10 18 Z" fill={c2} /><path d="M60 12 L55 0 L40 5 L50 18 Z" fill={c2} /><polygon points="5,50 15,50 55,10 55,0 50,0 45,0 0,45 0,50" fill={c2} opacity="0.9" /></>}
                              {style === 'halves' && <><rect x="30" y="0" width="30" height="55" fill={c2} /><path d="M0 12 L5 0 L20 5 L10 18 Z" fill={c2} /><path d="M60 12 L55 0 L40 5 L50 18 Z" fill={c1} /></>}
                            </g>
                            <path d="M10 18 L0 12 L5 0 L20 5 L22 0 L38 0 L40 5 L55 0 L60 12 L50 18 L50 50 L10 50 Z" fill="none" stroke="rgba(255,255,255,0.6)" strokeWidth="1" />
                            <text x="30" y="38" textAnchor="middle" fill={txtCol} fontSize="20" fontWeight="bold" fontFamily="Arial">{p.rating}</text>
                          </svg>
                        );
                      };
                    
                      return (
                        <div>
                          {/* Header */}
                          <div className="bg-gray-800 rounded-t-lg p-3 flex items-center gap-3 border-b border-gray-700">
                            <button onClick={() => { if (selectedPlayerTeam && selectedPlayerTeam.id !== team.id) { const cameFromTransfers = transferList.some(l => l.player.id === selectedPlayer.id && l.team.id === selectedPlayerTeam.id); setPage(cameFromTransfers ? 'transfers' : 'team-profile'); } else setPage('squad'); }} className="text-gray-400 hover:text-white">â† Back</button>
                            <h2 className="text-white font-bold">Player Details</h2>
                          </div>
                    
                          {/* Injury/status banner */}
                          {p.injured && (
                            <div className="bg-red-600 px-3 py-1 text-center">
                              <p className="text-white text-xs font-semibold">Injured â€” {(() => { const w = getWeeksUntil(p.injuryUntil); return w > 0 ? `${w} week${w > 1 ? 's' : ''} remaining` : 'Returning soon'; })()}</p>
                            </div>
                          )}
                    
                          {/* Player card */}
                          <div className="bg-gray-800 p-4 flex items-center gap-4">
                            <ShirtLarge />
                            <div>
                              <h2 className="text-white font-bold text-xl">{p.name}</h2>
                              <p className="text-orange-400 font-semibold text-sm">{p.positions.join(', ')}</p>
                                <p className={`text-sm font-semibold ${getStarRating(p.rating).color}`}>
                          {getStarRating(p.rating).label} {p.rating >= 20 && 'â­'}
                      </p>
                          <StarDisplay rating={p.rating} />
                            </div>
                          </div>
                    
                          {/* Club info */}
                          <div className="bg-gray-800 border-t border-gray-700 p-4">
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <p className="text-gray-500 text-xs">Club</p>
                                <p className="text-white font-bold">{profileTeam.name}</p>
                              </div>
                              <div>
                                <p className="text-gray-500 text-xs">Age</p>
                                <p className="text-white font-bold">{age}</p>
                              </div>
                              <div>
                                <p className="text-gray-500 text-xs">Rating</p>
                                <p className="text-white font-bold">{p.rating}/20</p>
                              </div>
                              <div>
                                <p className="text-gray-500 text-xs">DOB</p>
                                <p className="text-white font-bold">{formatDate(p.dob)}</p>
                              </div>
                            </div>
                          </div>
                    
                          {/* Current season stats */}
                          <div className="bg-gray-800 border-t border-gray-700 p-4">
                            <h3 className="text-gray-500 text-xs mb-3">Current Season</h3>
                            <div className="grid grid-cols-7 gap-1 text-center">
                              <div>
                                <p className="text-gray-500 text-xs">Apps</p>
                                <p className="text-white font-bold text-2xl">{currentSeason.apps}</p>
                              </div>
                              <div>
                                <p className="text-gray-500 text-xs">Gls</p>
                                <p className="text-white font-bold text-2xl">{currentSeason.goals || 0}</p>
                              </div>
                              <div>
                                <p className="text-gray-500 text-xs">Ast</p>
                                <p className="text-white font-bold text-2xl">{currentSeason.assists || 0}</p>
                              </div>
                              <div>
                                <p className="text-gray-500 text-xs">Yel</p>
                                <p className="text-yellow-400 font-bold text-2xl">{currentSeason.yellowCards || 0}</p>
                              </div>
                              <div>
                                <p className="text-gray-500 text-xs">Red</p>
                                <p className="text-red-400 font-bold text-2xl">{currentSeason.redCards || 0}</p>
                              </div>
                              <div>
                                <p className="text-gray-500 text-xs">MoM</p>
                                <p className="text-orange-400 font-bold text-2xl">{currentSeason.motm || 0}</p>
                              </div>
                              <div>
                                <p className="text-gray-500 text-xs">Avg R</p>
                                <p className="text-green-400 font-bold text-2xl">{currentSeason.matchCount > 0 ? (currentSeason.totalRating / currentSeason.matchCount).toFixed(2) : '-'}</p>
                              </div>
                            </div>
                          </div>
                    
                          {/* Season history */}
                          {allSeasons.length > 0 && (
                            <div className="bg-gray-800 border-t border-gray-700 p-4 rounded-b-lg">
                              <h3 className="text-gray-500 text-xs mb-3">Career History</h3>
                              <table className="w-full text-sm">
                                <thead>
                                  <tr className="text-gray-500 border-b border-gray-700 text-xs">
                                  <th className="text-left p-1">S</th>
                                  <th className="text-left p-1">Club</th>
                                  <th className="text-center p-1">App</th>
                                  <th className="text-center p-1">Gls</th>
                                  <th className="text-center p-1">Ast</th>
                                  <th className="text-center p-1">Yel</th>
                                  <th className="text-center p-1">Red</th>
                                  <th className="text-center p-1">MoM</th>
                                  <th className="text-center p-1">Avg</th>
                                </tr>
                                </thead>
                                <tbody>
                                  {allSeasons.map((h, i) => (
                                    <tr key={i} className={`border-b border-gray-700/50 ${h.season === season ? 'bg-green-900/20' : ''}`}>
                                      <td className="text-gray-400 p-1">{i + 1}</td>
                                      <td className="text-white p-1 text-xs">{h.team}</td>
                                      <td className="text-center text-gray-400 p-1">{h.apps}</td>
                                      <td className="text-center text-gray-400 p-1">{h.goals}</td>
                                      <td className="text-center text-gray-400 p-1">{h.assists || 0}</td>
                                      <td className="text-center text-yellow-400 p-1">{h.yellowCards || 0}</td>
                                      <td className="text-center text-red-400 p-1">{h.redCards || 0}</td>
                                      <td className="text-center text-orange-400 p-1">{h.motm || 0}</td>
                                      <td className="text-center text-green-400 p-1">{h.matchCount > 0 ? (h.totalRating / h.matchCount).toFixed(2) : '-'}</td>
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                            </div>
                          )}
                        </div>
                      );
                    })()}

                  {page === 'squad' && (
                    <div className="bg-gray-800 rounded-lg p-4">
                      <h2 className="text-white font-bold mb-4">Squad</h2>
                      {team.players.map(p => (
                        <div key={p.id} className={`rounded p-3 mb-2 ${p.injured ? 'bg-red-900/20' : 'bg-gray-700'}`}>
                          <div className="flex justify-between">
                            <div>
                              <div className="text-white font-semibold cursor-pointer hover:text-orange-400" onClick={(e) => { e.stopPropagation(); setSelectedPlayer(p); setSelectedPlayerTeam(team); setPage('player-profile'); }}>{p.name} {p.injured && 'âš•ï¸'}</div>                              <div className="text-gray-400 text-sm">
                                {p.positions.join('/')} â€¢ Age {calcAge(p.dob)} {p.goals > 0 && `â€¢ âš½ ${p.goals}`}
                                {p.injured && p.injuryUntil && (() => {
                                  const w = getWeeksUntil(p.injuryUntil);
                                  return ` â€¢ ðŸ¥ ${w > 0 ? `${w} week${w > 1 ? 's' : ''} left` : 'Returning soon'}`;
                                })()}
                              </div>
                            </div>
                           <div className="text-green-500 text-sm">{formatCurrency(calculatePlayerValue(p, date, getLeagueTier(league)))}</div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}

                  {page === 'table' && (
                  <div>
                      {Object.keys(leagues).filter(lk => lk.startsWith(country)).map(lk => {
                      const t = getTable(lk);
                      const isCurrentLeague = lk === league;
                      return (
                          <div key={lk} className={`bg-gray-800 rounded-lg p-4 mb-4 ${isCurrentLeague ? 'ring-2 ring-orange-500' : ''}`}>
                              <h2 className="text-white font-bold mb-4">{leagues[lk].name}</h2>
                              <table className="w-full text-sm">
                                  <thead><tr className="text-gray-400 border-b border-gray-700"><th className="text-left p-2">Pos</th><th className="text-left p-2">Team</th><th className="text-center p-2">P</th><th className="text-center p-2">W</th><th className="text-center p-2">D</th><th className="text-center p-2">L</th><th className="text-center p-2">GF</th><th className="text-center p-2">GA</th><th className="text-center p-2">GD</th><th className="text-center p-2">Pts</th></tr></thead>
                                  <tbody>
                                      {t.map((row, i) => {
                              let zoneBg = '';
                              if (i < 2) zoneBg = 'bg-green-900/40';
                              else if (i >= t.length - 3) zoneBg = 'bg-red-900/40';
                              const isPlayer = row.teamId === team.id;
                              return (
                                  <tr key={row.teamId} className={`border-b border-gray-700 ${isPlayer ? 'ring-2 ring-orange-500' : zoneBg}`}>
                                      <td className="text-white p-2">{i + 1}{i < 2 && <span className="ml-1 text-green-400">â†‘</span>}{i >= t.length - 3 && <span className="ml-1 text-red-400">â†“</span>}</td>
                                      <td className="text-white p-2 cursor-pointer hover:text-orange-400" onClick={() => {
                                      const tm = leagues[lk].teams.find(t => t.id === row.teamId);
                                      if (tm) { setSelectedTeamProfile({ team: tm, leagueKey: lk }); setPage('team-profile'); }
                                        }}>{row.name}</td>
                                      <td className="text-center text-gray-400 p-2">{row.played}</td>
                                      <td className="text-center text-gray-400 p-2">{row.won}</td>
                                      <td className="text-center text-gray-400 p-2">{row.drawn}</td>
                                      <td className="text-center text-gray-400 p-2">{row.lost}</td>
                                      <td className="text-center text-gray-400 p-2">{row.goalsFor}</td>
                                      <td className="text-center text-gray-400 p-2">{row.goalsAgainst}</td>
                                      <td className="text-center text-gray-400 p-2">{row.goalsFor - row.goalsAgainst}</td>
                                      <td className="text-center text-white font-bold p-2">{row.points}</td>
                                  </tr>
                              );
                          })}
                                  </tbody>
                              </table>
                          </div>
                      );
                  })}
                      <div className="space-y-2 text-xs">
                          <div className="flex items-center gap-2"><div className="w-4 h-4 bg-green-900/40 rounded"></div><span className="text-gray-400">Promotion zone (Top 2)</span></div>
                          <div className="flex items-center gap-2"><div className="w-4 h-4 bg-red-900/40 rounded"></div><span className="text-gray-400">Relegation zone (Bottom 3)</span></div>
                      </div>
                  </div>
              )}
                    

                  {page === 'fixtures' && (
                    <div className="bg-gray-800 rounded-lg p-4">
                      <h2 className="text-white font-bold mb-4">Fixtures</h2>
                      <div className="space-y-2 max-h-96 overflow-y-auto">
                        {(fixtures[league] || []).map((f, i) => {
                          const h = leagues[league].teams.find(t => t.id === f.homeTeamId);
                          const a = leagues[league].teams.find(t => t.id === f.awayTeamId);
                          const isPM = f.homeTeamId === team.id || f.awayTeamId === team.id;
                          return (
                            <div key={i} className={`p-3 rounded text-sm ${isPM ? f.played ? 'bg-green-900/30' : 'bg-orange-900/30' : 'bg-gray-700'}`}>
                              <div className="flex justify-between">
                                <span className="text-white">{h?.name} vs {a?.name}</span>
                                {f.played ? <span className="text-white font-bold">{f.homeScore} - {f.awayScore}</span> : <span className="text-gray-500">-</span>}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}

                  {page === 'scorers' && (
                    <div className="bg-gray-800 rounded-lg p-4">
                      <h2 className="text-white font-bold mb-4">âš½ Top Scorers</h2>
                      {Object.keys(leagues).filter(lk => lk.startsWith(country)).map(lk => {
                        const sc = getScorers(lk);
                        return (
                          <div key={lk} className="mb-6">
                            <h3 className="text-orange-500 font-bold mb-3">{leagues[lk].name}</h3>
                            {sc.length > 0 ? sc.map((s, i) => (
                              <div key={i} className="flex justify-between bg-gray-700 p-2 rounded mb-2 text-sm">
                                <span className="text-white"><span className="text-orange-500">{i + 1}.</span> {s.name} <span className="text-gray-400 text-xs">({s.team})</span></span>
                                <span className="text-white font-bold">{s.goals}</span>
                              </div>
                            )) : <p className="text-gray-500 text-sm">No goals yet</p>}
                          </div>
                        );
                      })}
                    </div>
                  )}

                  {page === 'transfers' && (() => {
                  const positions = ['all','GK','CB','LB','RB','CDM','CM','CAM','LW','RW','ST'];
                  const filtered = transferList.filter(l => {
                    const posMatch = transferFilter === 'all' || l.player.positions.includes(transferFilter);
                    const nameMatch = transferSearch === '' || l.player.name.toLowerCase().includes(transferSearch.toLowerCase());
                    return posMatch && nameMatch;
                  });
                
                  return (
                    <div>
                      {/* Header with tabs */}
                      <div className="bg-gray-800 rounded-t-lg p-3 flex gap-2 border-b border-gray-700">
                        <button onClick={() => setTransferFilter('buy')} className={`px-4 py-2 rounded-lg font-bold text-sm ${transferFilter !== 'sell' ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-400'}`}>Buy Players</button>
                        <button onClick={() => setTransferFilter('sell')} className={`px-4 py-2 rounded-lg font-bold text-sm ${transferFilter === 'sell' ? 'bg-red-600 text-white' : 'bg-gray-700 text-gray-400'}`}>Sell Players</button>
                      </div>
                
                      {/* Budget bar */}
                      <div className="bg-gray-800 p-3 border-b border-gray-700 flex justify-between items-center">
                        <span className="text-gray-400 text-sm">Budget:</span>
                        <span className="text-white font-bold text-lg">{formatCurrency(team.budget)}</span>
                      </div>
                        
                        {/* Incoming Offers */}
                        {incomingOffers.length > 0 && (
                          <div className="bg-yellow-900/30 p-3 border-b border-yellow-700/50">
                            <h3 className="text-yellow-400 font-bold text-sm mb-2">ðŸ“¨ Incoming Offers ({incomingOffers.length})</h3>
                            <div className="space-y-2">
                              {incomingOffers.map((o, i) => (
                                <div key={i} className="bg-gray-700 rounded-lg p-3 flex items-center gap-3">
                                  <div className="flex-shrink-0" style={{ width: '36px' }}>{renderShirt(o.biddingTeam, '36px')}</div>
                                  <div className="flex-1 min-w-0">
                                    <p className="text-white font-semibold text-sm truncate">{o.player.name}</p>
                                    <p className="text-gray-400 text-xs">{o.biddingTeam.name} bid {formatCurrency(o.offerAmount)}</p>
                                    <p className="text-gray-500 text-xs">Value: {formatCurrency(calculatePlayerValue(o.player, date, getLeagueTier(league)))}</p>
                                  </div>
                                  <div className="flex gap-2">
                                    <button onClick={() => setIncomingOffers(incomingOffers.filter((_, idx) => idx !== i))} className="px-2 py-1 rounded text-xs font-bold bg-red-600 text-white">âœ•</button>
                                    <button onClick={() => acceptOffer(o)} className="px-2 py-1 rounded text-xs font-bold bg-green-600 text-white">âœ“</button>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                        
                      {transferFilter !== 'sell' ? (
                       <>
                          {/* Search */}
                          <div className="bg-gray-800 p-3 border-b border-gray-700">
                            <input
                              type="text"
                              placeholder="Search player name..."
                              value={transferSearch}
                              onChange={(e) => setTransferSearch(e.target.value)}
                              className="w-full bg-gray-700 text-white rounded-lg px-3 py-2 text-sm mb-2 outline-none focus:ring-2 focus:ring-orange-500"
                            />
                        
                            {/* Position filter */}
                            <p className="text-gray-500 text-xs mb-1">Position</p>
                            <div className="flex gap-1 flex-wrap mb-3">
                              {positions.map(pos => (
                                <button key={pos} onClick={() => setTransferFilter(pos)} className={`px-2 py-1 rounded text-xs font-bold ${transferFilter === pos ? 'bg-orange-600 text-white' : 'bg-gray-700 text-gray-400'}`}>{pos === 'all' ? 'All' : pos}</button>
                              ))}
                            </div>
                        
                            {/* Age filter */}
                            <p className="text-gray-500 text-xs mb-1">Age</p>
                            <div className="flex gap-1 flex-wrap mb-3">
                              {[
                                { key: 'any', label: 'Any' },
                                { key: 'u21', label: 'U21' },
                                { key: '21-25', label: '21-25' },
                                { key: '26-29', label: '26-29' },
                                { key: '30+', label: '30+' }
                              ].map(a => (
                                <button key={a.key} onClick={() => setTransferAgeFilter(a.key)} className={`px-2 py-1 rounded text-xs font-bold ${transferAgeFilter === a.key ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-400'}`}>{a.label}</button>
                              ))}
                            </div>
                        
                            {/* Special filters */}
                            <p className="text-gray-500 text-xs mb-1">Filter</p>
                            <div className="flex gap-1 flex-wrap mb-3">
                              {[
                                { key: 'all', label: 'All' },
                                { key: 'affordable', label: 'ðŸ’° Affordable' },
                                { key: 'bargain', label: 'ðŸ·ï¸ Bargains' },
                                { key: 'worldclass', label: 'â­ World Class' },
                                { key: 'wonderkid', label: 'ðŸŒŸ Wonderkids' },
                                { key: 'experienced', label: 'ðŸŽ–ï¸ Experienced' },
                                { key: 'upgrade', label: 'ðŸ“ˆ Upgrades' }
                              ].map(f => (
                                <button key={f.key} onClick={() => setTransferSpecialFilter(f.key)} className={`px-2 py-1 rounded text-xs font-bold ${transferSpecialFilter === f.key ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-400'}`}>{f.label}</button>
                              ))}
                            </div>
                        
                            {/* Sort */}
                            <p className="text-gray-500 text-xs mb-1">Sort by</p>
                            <div className="flex gap-1 flex-wrap">
                              {[
                                { key: 'rating', label: 'Rating â†“' },
                                { key: 'price-low', label: 'Price â†‘' },
                                { key: 'price-high', label: 'Price â†“' },
                                { key: 'age-young', label: 'Youngest' },
                                { key: 'age-old', label: 'Oldest' },
                                { key: 'value', label: 'Best Value' }
                              ].map(s => (
                                <button key={s.key} onClick={() => setTransferSortBy(s.key)} className={`px-2 py-1 rounded text-xs font-bold ${transferSortBy === s.key ? 'bg-purple-600 text-white' : 'bg-gray-700 text-gray-400'}`}>{s.label}</button>
                              ))}
                            </div>
                          </div>
                        
                          {/* Refresh */}
                          <div className="bg-gray-800 p-3 border-b border-gray-700 flex gap-2">
                            <button onClick={generateTransferList} className="flex-1 bg-gray-700 text-gray-300 py-2 rounded-lg text-sm font-bold hover:bg-gray-600">ðŸ”„ Refresh List</button>
                            <button onClick={() => { setTransferFilter('all'); setTransferAgeFilter('any'); setTransferSpecialFilter('all'); setTransferSortBy('rating'); setTransferSearch(''); }} className="bg-gray-700 text-gray-300 py-2 px-3 rounded-lg text-sm font-bold hover:bg-gray-600">âœ• Clear</button>
                          </div>
                        
                          {/* Player listings */}
                          <div className="bg-gray-800 rounded-b-lg p-3">
                            {(() => {
                              // Apply all filters
                              let results = transferList.filter(l => {
                                const posMatch = transferFilter === 'all' || l.player.positions.includes(transferFilter);
                                const nameMatch = transferSearch === '' || l.player.name.toLowerCase().includes(transferSearch.toLowerCase());
                                const age = calcAge(l.player.dob);
                        
                                // Age filter
                                let ageMatch = true;
                                if (transferAgeFilter === 'u21') ageMatch = age < 21;
                                else if (transferAgeFilter === '21-25') ageMatch = age >= 21 && age <= 25;
                                else if (transferAgeFilter === '26-29') ageMatch = age >= 26 && age <= 29;
                                else if (transferAgeFilter === '30+') ageMatch = age >= 30;
                        
                                // Special filters
                                let specialMatch = true;
                                if (transferSpecialFilter === 'affordable') specialMatch = l.askingPrice <= team.budget;
                                else if (transferSpecialFilter === 'bargain') specialMatch = l.askingPrice <= team.budget * 0.15;
                                else if (transferSpecialFilter === 'worldclass') specialMatch = l.player.rating >= 17;
                                else if (transferSpecialFilter === 'wonderkid') specialMatch = age <= 21 && l.player.rating >= 14;
                                else if (transferSpecialFilter === 'experienced') specialMatch = age >= 28 && l.player.rating >= 15;
                                else if (transferSpecialFilter === 'upgrade') {
                                  // Find best player in same position on your team
                                  const bestOwn = team.players
                                    .filter(p => p.positions.some(pos => l.player.positions.includes(pos)))
                                    .sort((a, b) => b.rating - a.rating)[0];
                                  specialMatch = bestOwn ? l.player.rating > bestOwn.rating : true;
                                }
                        
                                return posMatch && nameMatch && ageMatch && specialMatch;
                              });
                        
                              // Sort
                              if (transferSortBy === 'rating') results.sort((a, b) => b.player.rating - a.player.rating);
                              else if (transferSortBy === 'price-low') results.sort((a, b) => a.askingPrice - b.askingPrice);
                              else if (transferSortBy === 'price-high') results.sort((a, b) => b.askingPrice - a.askingPrice);
                              else if (transferSortBy === 'age-young') results.sort((a, b) => calcAge(a.player.dob) - calcAge(b.player.dob));
                              else if (transferSortBy === 'age-old') results.sort((a, b) => calcAge(b.player.dob) - calcAge(a.player.dob));
                              else if (transferSortBy === 'value') results.sort((a, b) => (b.player.rating / b.askingPrice) - (a.player.rating / a.askingPrice));
                        
                              return (
                                <>
                                  <div className="flex justify-between items-center mb-2">
                                    <p className="text-gray-500 text-xs">{results.length} players found</p>
                                    {transferSpecialFilter === 'affordable' && <p className="text-green-400 text-xs">Within budget: {formatCurrency(team.budget)}</p>}
                                  </div>
                                  <div className="space-y-2 max-h-96 overflow-y-auto">
                                    {results.slice(0, 50).map((l, i) => {
                                      const age = calcAge(l.player.dob);
                                      const canAfford = team.budget >= l.askingPrice;
                                      const isWonderkid = age <= 21 && l.player.rating >= 14;
                                      const isWorldClass = l.player.rating >= 17;
                                      return (
                                        <div key={`${l.team.id}-${l.player.id}`} className={`rounded-lg p-3 ${isWorldClass ? 'bg-yellow-900/20 border border-yellow-700/30' : isWonderkid ? 'bg-purple-900/20 border border-purple-700/30' : 'bg-gray-700'}`}>
                                          <div className="flex items-center gap-3">
                                            <div className="flex-shrink-0" style={{ width: '36px', height: '32px' }}>{renderShirt(l.team, '36px')}</div>
                                            <div className="flex-1 min-w-0">
                                              <div className="flex items-center gap-1">
                                                <span className="text-white font-semibold text-sm truncate cursor-pointer hover:text-orange-400" onClick={(e) => { e.stopPropagation(); setSelectedPlayer(l.player); setSelectedPlayerTeam(l.team); setPage('player-profile'); }}>{l.player.name}</span>
                                                {isWorldClass && <span className="text-xs">â­</span>}
                                                {isWonderkid && !isWorldClass && <span className="text-xs">ðŸŒŸ</span>}
                                              </div>
                                              <div className="text-gray-400 text-xs">{l.player.positions.join('/')} â€¢ Age {age} â€¢ <StarDisplay rating={l.player.rating} /></div>
                                              <div className="text-gray-500 text-xs">{l.team.name} â€¢ {leagues[l.leagueKey].name}</div>
                                            </div>
                                            <div className="text-right flex-shrink-0">
                                              <p className="text-orange-400 font-bold text-sm">{formatCurrency(l.askingPrice)}</p>
                                              <button onClick={() => buyPlayer(l)} disabled={!canAfford} className={`mt-1 px-3 py-1 rounded text-xs font-bold ${canAfford ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-600 text-gray-400 cursor-not-allowed'}`}>Buy</button>
                                            </div>
                                          </div>
                                        </div>
                                      );
                                    })}
                                    {results.length === 0 && <p className="text-gray-500 text-sm text-center py-4">No players match your filters</p>}
                                  </div>
                                </>
                              );
                            })()}
                          </div>
                        </>
                        ) : (
                        <>
                        
                          {/* Sell players */}
                          <div className="bg-gray-800 rounded-b-lg p-3">
                            <p className="text-gray-500 text-xs mb-2">Your squad ({team.players.length} players)</p>
                            <div className="space-y-2 max-h-96 overflow-y-auto">
                              {team.players.sort((a, b) => b.rating - a.rating).map(p => {
                                const value = calculatePlayerValue(p, date, getLeagueTier(league));
                                const inXI = Object.values(startingXI).includes(p.id);
                                return (
                                  <div key={p.id} className={`rounded-lg p-3 ${inXI ? 'bg-green-900/20' : 'bg-gray-700'}`}>
                                    <div className="flex items-center gap-3">
                                      <div className="flex-1 min-w-0">
                                        <div className="flex items-center gap-2">
                                          <span className="text-white font-semibold text-sm truncate">{p.name}</span>
                                          {inXI && <span className="text-green-400 text-xs">XI</span>}
                                          {p.injured && <span className="text-red-400 text-xs">âš•ï¸</span>}
                                        </div>
                                        <div className="text-gray-400 text-xs">{p.positions.join('/')} â€¢ Age {calcAge(p.dob)} â€¢ <StarDisplay rating={p.rating} /></div>
                                      </div>
                                      <div className="text-right flex-shrink-0">
                                        <p className="text-green-400 font-bold text-sm">{formatCurrency(value)}</p>
                                        <button onClick={() => sellPlayer(p)} disabled={team.players.length <= 11} className={`mt-1 px-3 py-1 rounded text-xs font-bold ${team.players.length > 11 ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-gray-600 text-gray-400 cursor-not-allowed'}`}>Sell</button>
                                      </div>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        </>
                      )}
                    </div>
                  );
                })()}

                  {page === 'finances' && (() => {
                  // Group finances by month
                  const monthlyData = [];
                  const seen = {};
                  financeHistory.forEach(f => {
                    const d = new Date(f.date);
                    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    seen[key] = f.balance;
                  });
                  // Add current balance for current month
                  const nowKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                  seen[nowKey] = team.budget;
                
                  const sortedKeys = Object.keys(seen).sort();
                  sortedKeys.forEach(k => {
                    const [y, m] = k.split('-');
                    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                    monthlyData.push({ label: `${monthNames[parseInt(m) - 1]} ${y.slice(2)}`, value: seen[k] });
                  });
                
                  // Chart dimensions
                  const chartW = 320;
                  const chartH = 150;
                  const padL = 50;
                  const padR = 10;
                  const padT = 10;
                  const padB = 30;
                  const graphW = chartW - padL - padR;
                  const graphH = chartH - padT - padB;
                
                  const values = monthlyData.map(d => d.value);
                  const maxVal = Math.max(...values, 1);
                  const minVal = Math.min(...values, 0);
                  const range = maxVal - minVal || 1;
                
                  const points = monthlyData.map((d, i) => {
                    const x = padL + (monthlyData.length > 1 ? (i / (monthlyData.length - 1)) * graphW : graphW / 2);
                    const y = padT + graphH - ((d.value - minVal) / range) * graphH;
                    return { x, y, ...d };
                  });
                
                  const linePath = points.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x},${p.y}`).join(' ');
                  const areaPath = linePath + ` L${points[points.length - 1].x},${padT + graphH} L${points[0].x},${padT + graphH} Z`;
                
                  return (
                    <div className="bg-gray-800 rounded-lg p-4">
                      <h2 className="text-white font-bold mb-4">ðŸ’° Finances</h2>
                      <div className="mb-6">
                        <div className="text-gray-400 text-sm mb-1">Current Balance</div>
                        <div className="text-white font-bold text-4xl">{formatCurrency(team.budget)}</div>
                      </div>
                
                      {/* Line Graph */}
                      {monthlyData.length > 1 && (
                        <div className="bg-gray-700 rounded-lg p-4 mb-4">
                          <h3 className="text-white font-semibold mb-3">Balance Over Time</h3>
                          <svg viewBox={`0 0 ${chartW} ${chartH}`} className="w-full">
                            {/* Grid lines */}
                            {[0, 0.25, 0.5, 0.75, 1].map((pct, i) => {
                              const y = padT + graphH - pct * graphH;
                              const val = minVal + pct * range;
                              return (
                                <g key={i}>
                                  <line x1={padL} y1={y} x2={padL + graphW} y2={y} stroke="rgba(255,255,255,0.1)" strokeWidth="0.5" />
                                  <text x={padL - 5} y={y + 3} textAnchor="end" fill="#9CA3AF" fontSize="7">{formatCurrency(val)}</text>
                                </g>
                              );
                            })}
                
                            {/* Area fill */}
                            <path d={areaPath} fill="url(#finGrad)" opacity="0.3" />
                            <defs>
                              <linearGradient id="finGrad" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stopColor="#22c55e" />
                                <stop offset="100%" stopColor="#22c55e" stopOpacity="0" />
                              </linearGradient>
                            </defs>
                
                            {/* Line */}
                            <path d={linePath} fill="none" stroke="#22c55e" strokeWidth="2" strokeLinejoin="round" />
                
                            {/* Data points */}
                            {points.map((p, i) => (
                              <g key={i}>
                                <circle cx={p.x} cy={p.y} r="3" fill="#22c55e" stroke="#1f2937" strokeWidth="1.5" />
                                {/* X-axis labels - show every other if many */}
                                {(monthlyData.length <= 6 || i % 2 === 0) && (
                                  <text x={p.x} y={chartH - 5} textAnchor="middle" fill="#9CA3AF" fontSize="6">{p.label}</text>
                                )}
                              </g>
                            ))}
                          </svg>
                        </div>
                      )}
                
                      {/* Balance History */}
                      <div className="bg-gray-700 rounded-lg p-4">
                        <h3 className="text-white font-semibold mb-4">Balance History</h3>
                        {financeHistory.length > 1 ? (
                          <div className="mt-4 space-y-2">
                            {financeHistory.slice(-10).reverse().map((f, i) => (
                              <div key={i} className="flex justify-between text-sm">
                                <span className="text-gray-400">{formatDate(f.date)}</span>
                                <span className="text-white font-semibold">{formatCurrency(f.balance)}</span>
                              </div>
                            ))}
                          </div>
                        ) : (
                          <p className="text-gray-400 text-sm">Play more matches to see history</p>
                        )}
                      </div>
                    </div>
                  );
                })()}
                  {page === 'facilities' && (() => {
                    const getStadiumUpgradeCost = (lvl) => Math.round((lvl + 1) * (lvl + 1) * 1200000);
                    const getDevUpgradeCost = (lvl) => Math.round((lvl + 1) * (lvl + 1) * 600000);
                    const stadCost = facilities.stadiumLevel < 10 ? getStadiumUpgradeCost(facilities.stadiumLevel) : null;
                    const devCost = facilities.devLevel < 10 ? getDevUpgradeCost(facilities.devLevel) : null;

                    const upgradeStadium = () => {
                      if (facilities.stadiumLevel >= 10) return;
                      const cost = getStadiumUpgradeCost(facilities.stadiumLevel);
                      if (team.budget < cost) { alert('Insufficient funds!'); return; }
                      team.budget -= cost;
                      setFacilities({ ...facilities, stadiumLevel: facilities.stadiumLevel + 1 });
                      setFinanceHistory([...financeHistory, { date: date.toISOString(), balance: team.budget }]);
                    };

                    const upgradeDev = () => {
                      if (facilities.devLevel >= 10) return;
                      const cost = getDevUpgradeCost(facilities.devLevel);
                      if (team.budget < cost) { alert('Insufficient funds!'); return; }
                      team.budget -= cost;
                      setFacilities({ ...facilities, devLevel: facilities.devLevel + 1 });
                      setFinanceHistory([...financeHistory, { date: date.toISOString(), balance: team.budget }]);
                    };

                    const ProgressBar = ({ level, color }) => (
                      <div className="w-full bg-gray-600 rounded-full h-5 overflow-hidden">
                        <div className="h-full rounded-full transition-all duration-500 flex items-center justify-end pr-2" style={{ width: `${level * 10}%`, background: `linear-gradient(90deg, ${color}88, ${color})`, minWidth: level > 0 ? '2rem' : '0' }}>
                          <span className="text-white text-xs font-bold">{level}/10</span>
                        </div>
                      </div>
                    );

                    return (
                      <div>
                        <div className="bg-gray-800 rounded-lg p-4 mb-4">
                          <h2 className="text-white font-bold text-xl mb-1">ðŸŸï¸ Facilities</h2>
                          <p className="text-gray-400 text-sm mb-4">Balance: {formatCurrency(team.budget)}</p>

                          <div className="bg-gray-700 rounded-lg p-4 mb-4">
                            <div className="flex justify-between items-center mb-2">
                              <div>
                                <h3 className="text-white font-bold">ðŸŸï¸ Stadium</h3>
                                <p className="text-gray-400 text-xs">{team.stadiumName || 'Stadium'} â€” {(facilities.stadiumLevel * 10000).toLocaleString()} seats</p>
                              </div>
                              <div className="text-right">
                                <span className="text-white font-bold text-2xl">{facilities.stadiumLevel}</span>
                                <span className="text-gray-400 text-sm">/10</span>
                              </div>
                            </div>
                            <div className="mb-3"><ProgressBar level={facilities.stadiumLevel} color="#22c55e" /></div>
                            {facilities.stadiumLevel < 10 ? (
                              <div className="flex justify-between items-center">
                                <div>
                                  <p className="text-gray-300 text-xs">Expand to {((facilities.stadiumLevel + 1) * 10000).toLocaleString()} seats</p>
                                  <p className="text-orange-400 text-sm font-bold">{formatCurrency(stadCost)}</p>
                                </div>
                                <button onClick={upgradeStadium} disabled={team.budget < stadCost} className={`px-4 py-2 rounded-lg font-bold text-sm ${team.budget >= stadCost ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-600 text-gray-400 cursor-not-allowed'}`}>Upgrade</button>
                              </div>
                            ) : (
                              <p className="text-green-400 text-sm font-bold text-center">âœ… Fully upgraded!</p>
                            )}
                          </div>

                          <div className="bg-gray-700 rounded-lg p-4">
                            <div className="flex justify-between items-center mb-2">
                              <div>
                                <h3 className="text-white font-bold">âš½ Youth Development</h3>
                                <p className="text-gray-400 text-xs">Improves player growth rate each season</p>
                              </div>
                              <div className="text-right">
                                <span className="text-white font-bold text-2xl">{facilities.devLevel}</span>
                                <span className="text-gray-400 text-sm">/10</span>
                              </div>
                            </div>
                            <div className="mb-3"><ProgressBar level={facilities.devLevel} color="#3b82f6" /></div>
                            <div className="mb-3 bg-gray-800 rounded p-2">
                              <p className="text-gray-400 text-xs text-center">
                                Growth bonus: <span className="text-blue-400 font-bold">+{((facilities.devLevel - 1) * 5)}%</span>
                                {facilities.devLevel === 1 && <span className="text-gray-500"> (no bonus yet)</span>}
                              </p>
                            </div>
                            {facilities.devLevel < 10 ? (
                              <div className="flex justify-between items-center">
                                <div>
                                  <p className="text-gray-300 text-xs">Level {facilities.devLevel} â†’ {facilities.devLevel + 1}</p>
                                  <p className="text-orange-400 text-sm font-bold">{formatCurrency(devCost)}</p>
                                </div>
                                <button onClick={upgradeDev} disabled={team.budget < devCost} className={`px-4 py-2 rounded-lg font-bold text-sm ${team.budget >= devCost ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-600 text-gray-400 cursor-not-allowed'}`}>Upgrade</button>
                              </div>
                            ) : (
                              <p className="text-blue-400 text-sm font-bold text-center">âœ… Fully upgraded!</p>
                            )}
                          </div>
                        </div>

                        <div className="bg-gray-800 rounded-lg p-4">
                          <h3 className="text-white font-bold mb-3">ðŸ’° Upgrade Costs</h3>
                          <table className="w-full text-xs">
                            <thead>
                              <tr className="text-gray-500 border-b border-gray-700">
                                <th className="text-left p-1">Level</th>
                                <th className="text-right p-1">Stadium</th>
                                <th className="text-right p-1">Development</th>
                              </tr>
                            </thead>
                            <tbody>
                              {[1,2,3,4,5,6,7,8,9].map(lvl => (
                                <tr key={lvl} className={`border-b border-gray-700/50 ${lvl === facilities.stadiumLevel || lvl === facilities.devLevel ? 'bg-gray-700/50' : ''}`}>
                                  <td className="text-gray-400 p-1">{lvl} â†’ {lvl+1}</td>
                                  <td className={`text-right p-1 ${lvl === facilities.stadiumLevel ? 'text-green-400 font-bold' : lvl < facilities.stadiumLevel ? 'text-gray-600 line-through' : 'text-gray-400'}`}>{formatCurrency(getStadiumUpgradeCost(lvl))}</td>
                                  <td className={`text-right p-1 ${lvl === facilities.devLevel ? 'text-blue-400 font-bold' : lvl < facilities.devLevel ? 'text-gray-600 line-through' : 'text-gray-400'}`}>{formatCurrency(getDevUpgradeCost(lvl))}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    );
                  })()}
                </div>

                {next && (
                  <div className="fixed bottom-0 left-0 right-0 p-4 bg-gray-900">
                    <button onClick={() => setState('formation')} className="w-full bg-green-600 text-white py-4 rounded-lg font-bold">Continue</button>
                  </div>
                )}
              </div>
            );
          }

          if (state === 'negotiation') {
          const neg = transferNegotiation;
          if (!neg) { setState('info-page'); return null; }
          return (
            <div className="min-h-screen bg-gray-900 flex flex-col">
              {/* Top section with illustration area */}
              <div className="flex-1 flex items-center justify-center p-8" style={{ background: 'linear-gradient(180deg, #2a1a0a 0%, #1a1a2e 100%)' }}>
                <div className="text-center">
                  <div className="text-8xl mb-4">{neg.stage === 'bidding' ? 'ðŸ“ž' : neg.stage === 'negotiating' ? 'ðŸ¤' : neg.result ? 'âœ…' : 'âŒ'}</div>
                  {neg.stage === 'bidding' && (
                    <div className="animate-pulse">
                      <p className="text-gray-400 text-lg">Contacting {neg.type === 'buy' ? neg.fromTeam.name : ''}...</p>
                    </div>
                  )}
                </div>
              </div>
        
              {/* Bottom info panel */}
              <div className="bg-white rounded-t-3xl p-6 text-center">
                <h2 className="text-black font-bold text-xl mb-3">
                  {neg.type === 'buy' ? 'Contract Negotiations' : neg.type === 'sell' ? 'Transfer Offer' : 'Incoming Bid'}
                </h2>
        
                {neg.stage === 'bidding' && (
                  <p className="text-gray-600">Submitting bid of {formatCurrency(neg.price)}...</p>
                )}
        
                {neg.stage === 'negotiating' && (
                  <div>
                    <p className="text-gray-600 mb-2">{neg.message}</p>
                    <p className="text-gray-500 animate-pulse">Contract negotiations are now taking place...</p>
                  </div>
                )}
        
                {neg.stage === 'result' && neg.type === 'buy' && (
                  <div>
                    <p className="text-gray-600 mb-2">{neg.fromTeam.name} have accepted your bid.</p>
                    {neg.result ? (
                      <>
                        <p className="text-gray-600 mb-2">Contract negotiations are now taking place...</p>
                        <p className="text-green-600 font-bold mb-2">{neg.player.name} has agreed to join your club!</p>
                        <p className="text-gray-600">Do you want to sign him for a fee of {formatCurrency(neg.price)}?</p>
                      </>
                    ) : (
                      <p className="text-red-600 font-bold">{neg.message}</p>
                    )}
                  </div>
                )}
        
                {neg.stage === 'result' && (neg.type === 'sell' || neg.type === 'incoming') && (
                  <div>
                    <p className="text-gray-600 mb-2">{neg.message}</p>
                  </div>
                )}
              </div>
        
              {/* Action buttons */}
              {neg.stage === 'result' && (
                <div className="flex">
                  <button
                    onClick={() => { setTransferNegotiation(null); setState('info-page'); setPage('transfers'); }}
                    className="flex-1 py-4 bg-red-500 text-white font-bold text-lg"
                  >
                    {neg.result ? (neg.type === 'buy' ? 'Do not buy' : 'Reject') : 'Back'}
                  </button>
                  {neg.result && (
                    <button
                      onClick={() => {
                        if (neg.type === 'buy') confirmBuy();
                        else if (neg.type === 'sell') confirmSell();
                        else if (neg.type === 'incoming') confirmIncomingSale();
                        setState('info-page'); setPage('transfers');
                      }}
                      className="flex-1 py-4 bg-green-600 text-white font-bold text-lg"
                    >
                      {neg.type === 'buy' ? 'Buy' : 'Accept'}
                    </button>
                  )}
                </div>
              )}
        
              {/* Loading state - no buttons */}
              {neg.stage !== 'result' && (
                <div className="py-4 bg-gray-800 text-center">
                  <p className="text-gray-400 animate-pulse">Please wait...</p>
                </div>
              )}
            </div>
          );
        }  
        if (state === 'live-match' && liveMatch) {
          const { homeTeam, awayTeam, homePlayers, awayPlayers } = liveMatch;
          const isFinished = matchEnded;
        
          return (
            <div className="min-h-screen bg-gray-900 flex flex-col">
              {/* Scoreboard */}
              <div className={`p-4 ${goalFlash ? 'goal-flash-active' : ''}`} style={goalFlash ? {} : { background: 'linear-gradient(180deg, #1a3a1a 0%, #0a1a0a 100%)' }}>
                <div className="flex justify-between items-center mb-1">
                  <div className="flex-1">
                    <p className="text-yellow-400 font-bold text-lg" style={{ fontFamily: 'monospace' }}>{homeTeam.name.toUpperCase()}</p>
                    <p className="text-yellow-400 font-bold text-lg" style={{ fontFamily: 'monospace' }}>{awayTeam.name.toUpperCase()}</p>
                  </div>
                  <div className="text-right flex items-center gap-3">
                    <div>
                      <p className="text-yellow-400 font-bold text-2xl" style={{ fontFamily: 'monospace' }}>{liveScore.home}</p>
                      <p className="text-yellow-400 font-bold text-2xl" style={{ fontFamily: 'monospace' }}>{liveScore.away}</p>
                    </div>
                    <div className="text-yellow-400 font-bold text-3xl" style={{ fontFamily: 'monospace' }}>{liveMinute}'</div>
                  </div>
                </div>
                <p className="text-yellow-600 text-xs" style={{ fontFamily: 'monospace' }}>{homeTeam.stadiumName || 'Stadium'} {((homeTeam.stadiumCapacity || 0)).toLocaleString()}</p>
              </div>
        
              {/* Tab switcher */}
              <div className="flex border-b border-gray-700">
                <button onClick={() => setMatchTab('commentary')} className={`flex-1 py-3 text-center font-bold text-sm ${matchTab === 'commentary' ? 'text-white border-b-2 border-orange-500' : 'text-gray-500'}`}>Match Commentary</button>
                <button onClick={() => setMatchTab('ratings')} className={`flex-1 py-3 text-center font-bold text-sm ${matchTab === 'ratings' ? 'text-white border-b-2 border-orange-500' : 'text-gray-500'}`}>Player Ratings</button>
              </div>
        
              {/* Content */}
              <div className="flex-1 overflow-y-auto pb-20" style={{ background: 'linear-gradient(180deg, #2d4a2d 0%, #1a3a1a 100%)' }}>
                {matchTab === 'commentary' && (
                  <div className="p-3 space-y-2">
                    {liveCommentary.map((ev, i) => (
                      <div key={i} className={`flex items-start gap-3 p-3 rounded-lg ${ev.isGoal ? 'bg-green-900/60 border border-green-500/50' : 'bg-gray-800/60'}`}>
                        <div className="flex-shrink-0 mt-1" style={{ width: '30px' }}>
                          {ev.type === 'end' ? <span className="text-xl">â±ï¸</span> : renderShirt(ev.isHome ? homeTeam : awayTeam, '30px')}
                        </div>
                        <div className="flex-1">
                          <p className={`text-sm font-semibold ${ev.isGoal ? 'text-green-300' : 'text-white'}`}>{ev.text}</p>
                          <p className="text-gray-500 text-xs">{ev.min}' min</p>
                        </div>
                        {ev.isGoal && <span className="text-yellow-400 text-xs font-bold">âš½</span>}
                      </div>
                    ))}
                    {liveCommentary.length === 0 && <p className="text-gray-500 text-sm text-center py-8">Match starting...</p>}
                  </div>
                )}
        
                {matchTab === 'ratings' && (
                  <div className="p-3">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="border-b border-gray-600">
                          <th className="text-yellow-400 text-xs text-left py-2 w-8">Rtg</th>
                          <th className="text-yellow-400 text-xs text-right pr-2">Home</th>
                          <th className="text-gray-500 text-xs text-center px-1">Pos</th>
                          <th className="text-yellow-400 text-xs text-left pl-2">Away</th>
                          <th className="text-yellow-400 text-xs text-right w-8">Rtg</th>
                        </tr>
                      </thead>
                      <tbody>
                
                        {(() => {
                      const liveHomePlayers = computeLiveRatings(homePlayers, liveCommentary, true);
                      const liveAwayPlayers = computeLiveRatings(awayPlayers, liveCommentary, false);
                      
                          // Compute icons from live commentary events
                          const getPlayerIcons = (playerId, isHome) => {
                            const icons = [];
                            liveCommentary.forEach(ev => {
                              if (ev.isGoal && ev.isHome === isHome) {
                                // Check if this player scored by matching name in goal text
                                const player = isHome ? liveHomePlayers.find(p => p.id === playerId) : liveAwayPlayers.find(p => p.id === playerId);
                                if (player && ev.text.includes(player.name)) {
                                  icons.push({ type: 'goal', min: ev.min });
                                }
                              }
                              if (ev.type === 'assist' && ev.isHome === isHome) {
                                const player = isHome ? liveHomePlayers.find(p => p.id === playerId) : liveAwayPlayers.find(p => p.id === playerId);
                                if (player && ev.text.includes(player.name)) {
                                  icons.push({ type: 'assist', min: ev.min });
                                }
                              }
                              if (ev.type === 'yellowCard' && ev.playerId === playerId) {
                                icons.push({ type: 'yellow', min: ev.min });
                              }
                              if (ev.type === 'redCard' && ev.playerId === playerId) {
                                icons.push({ type: 'red', min: ev.min });
                              }
                            });
                            return icons;
                          };
                        
                          // Determine single MOTM across both teams (only show when match ended)
                            let homeMotmId = null, awayMotmId = null;
                            if (matchEnded) {
                              let bestRating = 0, bestId = null, bestSide = null;
                             liveHomePlayers.forEach(p => { if (p.matchRating > bestRating) { bestRating = p.matchRating; bestId = p.id; bestSide = 'home'; } });
                              liveAwayPlayers.forEach(p => { if (p.matchRating > bestRating) { bestRating = p.matchRating; bestId = p.id; bestSide = 'away'; } });
                              if (bestSide === 'home') homeMotmId = bestId;
                              else awayMotmId = bestId;
                            }
                        
                          const posMap = { 'GK':'GK', 'LB':'DL', 'RB':'DR', 'CB':'DC', 'CDM':'MC', 'CM':'MC', 'CAM':'AMC', 'LW':'AML', 'RW':'AMR', 'ST':'AC' };
                        
                          return Array.from({ length: Math.max(liveHomePlayers.length, liveAwayPlayers.length) }).map((_, i) => {
                            const hp = liveHomePlayers[i];
                            const ap = liveAwayPlayers[i];
                            const hPos = hp ? hp.positions[0] : '';
                            const aPos = ap ? ap.positions[0] : '';
                            const hIcons = hp ? getPlayerIcons(hp.id, true) : [];
                            const aIcons = ap ? getPlayerIcons(ap.id, false) : [];
                            const hIsMotm = hp && hp.id === homeMotmId;
                            const aIsMotm = ap && ap.id === awayMotmId;
                        
                            const renderIcons = (icons) => (
                              <span className="ml-1">
                                {icons.map((ic, j) => (
                                  <span key={j} className="text-xs" title={`${ic.min}'`}>
                                    {ic.type === 'goal' && <span>âš½</span>}
                                    {ic.type === 'assist' && <span className="text-green-400">ðŸ…°ï¸</span>}
                                    {ic.type === 'yellow' && <span>ðŸŸ¨</span>}
                                    {ic.type === 'red' && <span>ðŸŸ¥</span>}
                                  </span>
                                ))}
                              </span>
                            );
                        
                            return (
                              <tr key={i} className={`border-b border-gray-700/50 ${i >= 11 ? 'opacity-50' : ''} ${hIsMotm || aIsMotm ? 'bg-yellow-900/20' : ''}`}>
                                <td className="py-2 text-white font-bold">{hp ? hp.matchRating.toFixed(0) : ''}</td>
                                <td className="py-2 text-white text-right pr-1 text-xs">
                                  {hp && (
                                    <span>
                                      {hIsMotm && <span className="text-yellow-400">â­ </span>}
                                      {hp.name.split(' ').pop()}
                                      {renderIcons(hIcons)}
                                    </span>
                                  )}
                                </td>
                                <td className="py-2 text-center">
                                  <span className="text-gray-400 text-xs">{hp ? (posMap[hPos] || hPos) : ''}</span>
                                  {(hp || ap) && <span className="text-gray-600 text-xs"> </span>}
                                  <span className="text-gray-400 text-xs">{ap ? (posMap[aPos] || aPos) : ''}</span>
                                </td>
                                <td className="py-2 text-white text-left pl-1 text-xs">
                                  {ap && (
                                    <span>
                                      {ap.name.split(' ').pop()}
                                      {renderIcons(aIcons)}
                                      {aIsMotm && <span className="text-yellow-400"> â­</span>}
                                    </span>
                                  )}
                                </td>
                                <td className="py-2 text-white font-bold text-right">{ap ? ap.matchRating.toFixed(0) : ''}</td>
                              </tr>
                            );
                          });
                        })()}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>

                {(isHalfTime || tacticsPaused) && (() => {
                  const formationLayouts = {
                    '4-3-3': [
                      { x: 50, y: 92 },
                      { x: 12, y: 74 }, { x: 37, y: 77 }, { x: 63, y: 77 }, { x: 88, y: 74 },
                      { x: 50, y: 56 }, { x: 25, y: 50 }, { x: 75, y: 50 },
                      { x: 15, y: 28 }, { x: 85, y: 28 }, { x: 50, y: 22 }
                    ],
                    '4-4-2': [
                      { x: 50, y: 92 },
                      { x: 12, y: 74 }, { x: 37, y: 77 }, { x: 63, y: 77 }, { x: 88, y: 74 },
                      { x: 15, y: 50 }, { x: 40, y: 53 }, { x: 60, y: 53 }, { x: 85, y: 50 },
                      { x: 35, y: 22 }, { x: 65, y: 22 }
                    ],
                    '4-2-3-1': [
                      { x: 50, y: 92 },
                      { x: 12, y: 74 }, { x: 37, y: 77 }, { x: 63, y: 77 }, { x: 88, y: 74 },
                      { x: 35, y: 58 }, { x: 65, y: 58 },
                      { x: 15, y: 38 }, { x: 50, y: 40 }, { x: 85, y: 38 },
                      { x: 50, y: 20 }
                    ],
                    '3-5-2': [
                      { x: 50, y: 92 },
                      { x: 25, y: 77 }, { x: 50, y: 77 }, { x: 75, y: 77 },
                      { x: 10, y: 53 }, { x: 90, y: 53 },
                      { x: 30, y: 48 }, { x: 50, y: 45 }, { x: 70, y: 48 },
                      { x: 35, y: 22 }, { x: 65, y: 22 }
                    ]
                  };
                
                  const layout = formationLayouts[formation];
                  const benchPlayers = team.players.filter(p => !Object.values(startingXI).includes(p.id) && !p.injured).sort((a, b) => b.rating - a.rating);
                
                  const style = team.shirtStyle || 'plain';
                  const pc = team.primaryColor || '#1a1a2e';
                  const sc2 = team.secondaryColor || '#FFFFFF';
                  const gkColor = '#2d8a4e';
                
                  const ShirtSvg = ({ number, isGK, isOOP }) => {
                    const clipId = `tc${number}-${Math.random().toString(36).substr(2,5)}`;
                    const c1 = isGK ? gkColor : isOOP ? '#b45309' : pc;
                    const c2 = isGK ? '#1a6b30' : isOOP ? '#92400e' : sc2;
                    const s = isGK ? 'plain' : isOOP ? 'plain' : style;
                    const dark = ['#000000','#00205B','#1a1a2e','#1B458F','#034694','#003399','#1D428A','#132257','#231F20','#241F20','#012B4A','#00225C','#122336','#0A2452','#1A2F6B','#10274f','#022663','#6D2C34','#7A263A','#670E36','#6C1D45','#5B2D8E','#781D2A','#004D98','#012C57','#99022C','#003DA5','#004FA3','#0054A6','#0055A4','#245701','#2B6303','#1D2CCF','#00296B','#003D7C','#DD0000','#DC052D','#ED1C24','#E2001A','#E32221','#CB3524','#E20613','#D91A2A','#C8102E','#DA291C','#e30613','#EB172B','#EE2523','#E7192F','#E1000F','#ED0000','#6B3524','#c22538','#1B2A4A','#0068A8','#FB090B','#1E71B8','#A31E2D','#A50044','#D40027','#CD2534','#00954C','#12A0D7','#F47920','#E2001A','#6A2382','#00843D'].includes(c1);
                    const light = ['#FFFFFF','#FFE114','#FDE100','#FDB913','#FCDD09','#FFD700','#8AC3EE','#87CEEB','#6CABDD','#95BFE5','#99D6EA','#65B32E'].includes(c1);
                    const txtCol = isGK ? '#FFFFFF' : dark ? '#FFFFFF' : light ? '#000000' : '#FFFFFF';
                    return (
                      <svg viewBox="0 0 60 55" style={{ width: '100%', height: '100%' }}>
                        <defs><clipPath id={clipId}><path d="M10 18 L0 12 L5 0 L20 5 L22 0 L38 0 L40 5 L55 0 L60 12 L50 18 L50 50 L10 50 Z" /></clipPath></defs>
                        <path d="M10 18 L0 12 L5 0 L20 5 L22 0 L38 0 L40 5 L55 0 L60 12 L50 18 L50 50 L10 50 Z" fill={c1} />
                        <g clipPath={`url(#${clipId})`}>
                          {s === 'stripes' && <>{[4,14,24,34,44,54].map(x => <rect key={x} x={x} y="0" width="5" height="55" fill={c2} />)}</>}
                          {s === 'hoops' && <>{[5,15,25,35,45].map(y => <rect key={y} x="0" y={y} width="60" height="5" fill={c2} />)}</>}
                          {s === 'quarters' && <><rect x="30" y="0" width="30" height="25" fill={c2} /><rect x="0" y="25" width="30" height="30" fill={c2} /></>}
                          {s === 'sleeves' && <><path d="M0 12 L5 0 L20 5 L10 18 Z" fill={c2} /><path d="M60 12 L55 0 L40 5 L50 18 Z" fill={c2} /></>}
                          {s === 'sash' && <><path d="M0 12 L5 0 L20 5 L10 18 Z" fill={c2} /><path d="M60 12 L55 0 L40 5 L50 18 Z" fill={c2} /><polygon points="5,50 15,50 55,10 55,0 50,0 45,0 0,45 0,50" fill={c2} opacity="0.9" /></>}
                          {s === 'halves' && <><rect x="30" y="0" width="30" height="55" fill={c2} /><path d="M0 12 L5 0 L20 5 L10 18 Z" fill={c2} /><path d="M60 12 L55 0 L40 5 L50 18 Z" fill={c1} /></>}
                        </g>
                        <path d="M10 18 L0 12 L5 0 L20 5 L22 0 L38 0 L40 5 L55 0 L60 12 L50 18 L50 50 L10 50 Z" fill="none" stroke="rgba(255,255,255,0.6)" strokeWidth="1" />
                        <text x="30" y="36" textAnchor="middle" fill={txtCol} fontSize="18" fontWeight="bold" fontFamily="Arial" stroke={txtCol === '#FFFFFF' ? 'rgba(0,0,0,0.3)' : 'rgba(255,255,255,0.3)'} strokeWidth="0.5">{number}</text>
                      </svg>
                    );
                  };
                
                  return (
                    <div className="fixed inset-0 bg-black/90 z-50 flex flex-col">
                      {/* Score header */}
                      <div className="p-3 text-center" style={{ background: team.primaryColor || '#ea580c' }}>
                        <p className="text-white font-bold text-lg">
                          {isHalfTime ? 'Half Time' : 'Tactics'} â€” {liveScore.home} â€“ {liveScore.away}
                        </p>
                        <p className="text-white/70 text-xs">{liveMinute}th minute</p>
                      </div>
                
                      {/* Match info bar */}
                      <div className="bg-green-900/80 px-3 py-2 text-center">
                        <p className="text-green-300 text-xs font-semibold">
                          Subs: {matchSubs.made}/{matchSubs.max} used
                          {team.players.filter(p => p.injured && Object.values(startingXI).includes(p.id)).length > 0 &&
                            <span className="text-red-400 ml-2">âš ï¸ Injured players in XI!</span>
                          }
                        </p>
                      </div>
                
                      {/* Formation selector */}
                      <div className="bg-gray-800 p-2 flex gap-2 justify-center border-b border-gray-700">
                        {Object.keys(formations).map(f => (
                          <button key={f} onClick={() => {
                            setFormation(f);
                            const xi = {};
                            formations[f].positions.forEach((pos, idx) => {
                              const cid = startingXI[`pos${idx}`];
                              const cp = cid ? team.players.find(p => p.id === cid) : null;
                              if (cp && !cp.injured && cp.positions.includes(pos)) {
                                xi[`pos${idx}`] = cid;
                              }
                            });
                            formations[f].positions.forEach((pos, idx) => {
                              if (!xi[`pos${idx}`]) {
                                const eligible = team.players.filter(p => p.positions.includes(pos) && !p.injured && !Object.values(xi).includes(p.id));
                                if (eligible.length > 0) xi[`pos${idx}`] = eligible.sort((a, b) => b.rating - a.rating)[0].id;
                              }
                            });
                            setStartingXI(xi);
                          }} className={`px-3 py-1.5 rounded text-xs font-bold ${formation === f ? 'bg-orange-600 text-white' : 'bg-gray-700 text-gray-400'}`}>{f}</button>
                        ))}
                      </div>
                
                      {/* Pitch with shirts */}
                      <div className="flex-1 overflow-y-auto">
                        <div className="relative w-full" style={{ paddingBottom: '140%', background: 'linear-gradient(180deg, #2d5a1e 0%, #357a24 8%, #2d5a1e 16%, #357a24 24%, #2d5a1e 32%, #357a24 40%, #2d5a1e 48%, #357a24 56%, #2d5a1e 64%, #357a24 72%, #2d5a1e 80%, #357a24 88%, #2d5a1e 100%)' }}>
                          <div className="absolute inset-0">
                            <svg viewBox="0 0 100 140" className="absolute inset-0 w-full h-full">
                              <rect x="2" y="2" width="96" height="136" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="0.4" />
                              <line x1="2" y1="70" x2="98" y2="70" stroke="rgba(255,255,255,0.2)" strokeWidth="0.3" />
                              <circle cx="50" cy="70" r="10" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="0.3" />
                              <circle cx="50" cy="70" r="0.6" fill="rgba(255,255,255,0.2)" />
                              <rect x="25" y="2" width="50" height="18" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="0.3" />
                              <rect x="35" y="2" width="30" height="7" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="0.3" />
                              <rect x="25" y="120" width="50" height="18" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="0.3" />
                              <rect x="35" y="131" width="30" height="7" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="0.3" />
                              <path d="M 35 20 A 12 12 0 0 0 65 20" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="0.3" />
                              <path d="M 35 120 A 12 12 0 0 1 65 120" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="0.3" />
                            </svg>
                
                            {layout.map((pos, idx) => {
                              const playerId = startingXI[`pos${idx}`];
                              const player = playerId ? team.players.find(p => p.id === playerId) : null;
                              const requiredPos = formations[formation].positions[idx];
                              const isGK = requiredPos === 'GK';
                              const isInjured = player && player.injured;
                              const isOOP = player && !player.positions.includes(requiredPos);
                              const isSelected = selectedSlot === idx;
                              const surname = player ? player.name.split(' ').pop() : requiredPos;
                
                              // Get match rating if available
                              const allMP = [...(liveMatch.homePlayers || []), ...(liveMatch.awayPlayers || [])];
                              const mp = player ? allMP.find(m => m.id === player.id) : null;
                              const rating = mp ? mp.matchRating.toFixed(0) : player ? player.rating : '?';
                
                              return (
                                <div key={idx} onClick={() => setSelectedSlot(isSelected ? null : idx)}
                                  className="absolute flex flex-col items-center cursor-pointer"
                                  style={{ left: `${pos.x}%`, top: `${pos.y / 140 * 100}%`, transform: 'translate(-50%, -50%)', zIndex: isSelected ? 20 : 10, width: '18%' }}>
                                  <div className={`relative transition-transform ${isSelected ? 'scale-125' : ''}`} style={{ width: '42px', height: '38px' }}>
                                    <ShirtSvg number={player ? player.rating : '?'} isGK={isGK} isOOP={(isOOP || isInjured) && !!player} />
                                    {isSelected && <div className="absolute inset-0 rounded" style={{ boxShadow: '0 0 15px rgba(249,115,22,0.9)' }}></div>}
                                    {isInjured && <div className="absolute -top-1 -right-1 text-xs">ðŸš‘</div>}
                                  </div>
                                  <div className="text-white text-center font-bold leading-tight mt-0.5" style={{ fontSize: '8px', textShadow: '0 1px 3px rgba(0,0,0,0.9)' }}>{surname}</div>
                                  <div className="text-gray-300 text-center leading-tight" style={{ fontSize: '7px', textShadow: '0 1px 2px rgba(0,0,0,0.8)' }}>
                                    {player ? `${player.positions.join(' ')} (${rating})` : ''}
                                  </div>
                                  {isOOP && !isInjured && <div style={{ fontSize: '8px' }} className="text-yellow-400">âš ï¸</div>}
                                </div>
                              );
                            })}
                          </div>
                        </div>
                
                        {/* Bench section below pitch */}
                        {selectedSlot !== null && (
                          <div className="bg-orange-900/40 px-3 py-2 text-center">
                            <p className="text-orange-300 text-xs font-semibold">Select a bench player to sub into {formations[formation].positions[selectedSlot]}</p>
                          </div>
                        )}
                
                        <div className="bg-gray-800 p-3 pb-24">
                          <h3 className="text-white font-bold text-sm mb-2">Substitutes</h3>
                          <div className="space-y-1">
                            {benchPlayers.map(p => {
                              const targetPos = selectedSlot !== null ? formations[formation].positions[selectedSlot] : null;
                              const fits = targetPos && p.positions.includes(targetPos);
                              return (
                                <div key={p.id} onClick={() => {
                                  if (selectedSlot !== null && matchSubs.made < matchSubs.max) {
                                    const xi = { ...startingXI };
                                    xi[`pos${selectedSlot}`] = p.id;
                                    setStartingXI(xi);
                                    setMatchSubs(prev => ({ ...prev, made: prev.made + 1 }));
                                    setSelectedSlot(null);
                                  } else if (selectedSlot !== null) {
                                    alert('No substitutions remaining!');
                                  }
                                }}
                                  className={`rounded p-2 flex items-center gap-3 cursor-pointer transition-all ${selectedSlot !== null ? fits ? 'bg-green-900/40 ring-1 ring-green-500' : 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-700'}`}>
                                  <div style={{ width: '32px', height: '28px', flexShrink: 0 }}>
                                    <ShirtSvg number={p.rating} isGK={p.positions.includes('GK')} isOOP={false} />
                                  </div>
                                  <div className="flex-1 min-w-0">
                                    <div className="text-white font-semibold text-sm truncate">{p.name}</div>
                                    <div className="text-gray-400 text-xs">{p.positions.join('/')} â€¢ Age {calcAge(p.dob)}</div>
                                  </div>
                                  {selectedSlot !== null && fits && <span className="text-green-400 text-xs font-bold">âœ“</span>}
                                </div>
                              );
                            })}
                            {benchPlayers.length === 0 && <p className="text-gray-500 text-sm">No available substitutes</p>}
                          </div>
                        </div>
                      </div>
                
                      {/* Resume button */}
                      <div className="fixed bottom-0 left-0 right-0 p-4 bg-gray-900 z-50">
                        <button onClick={() => {
                          setSelectedSlot(null);
                          if (isHalfTime) { setIsHalfTime(false); }
                          if (tacticsPaused) { setTacticsPaused(false); }
                          resumeFromTactics();
                        }} className="w-full bg-green-600 text-white py-4 rounded-lg font-bold text-lg">
                          {isHalfTime ? 'Start Second Half â†’' : 'Resume Match â†’'}
                        </button>
                      </div>
                    </div>
                  );
                })()}
        
              {/* Continue button - only when finished */}
              {isFinished && (
              <div className="fixed bottom-0 left-0 right-0 p-4 bg-gray-900 z-50">
                <button onClick={finishLiveMatch} className="w-full bg-green-600 text-white py-4 rounded-lg font-bold text-lg">Continue</button>
              </div>
            )}
        
              {/* Live indicator */}
              {!isFinished && !isHalfTime && !tacticsPaused && (
              <div className="fixed bottom-0 left-0 right-0 p-4 bg-gray-900 z-40 flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <div className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                  <p className="text-gray-400 text-sm">LIVE â€” {matchHalf === 1 ? '1st Half' : '2nd Half'}</p>
                </div>
                <button onClick={pauseForTactics}
                  disabled={matchSubs.made >= matchSubs.max}
                  className={`px-4 py-2 rounded-lg font-bold text-sm ${matchSubs.made < matchSubs.max ? 'bg-orange-600 text-white' : 'bg-gray-700 text-gray-500 cursor-not-allowed'}`}>
                  ðŸ“‹ Tactics ({matchSubs.max - matchSubs.made} subs)
                </button>
              </div>
            )}
            </div>
          );
        }
          if (state === 'formation') {
            const next = getNext();
            const opp = next ? (next.homeTeamId === team.id ? leagues[league].teams.find(t => t.id === next.awayTeamId) : leagues[league].teams.find(t => t.id === next.homeTeamId)) : null;
            const inj = team.players.filter(p => p.injured);
            const validPlayers = Object.values(startingXI).filter(pid => {
              const p = team.players.find(pl => pl.id === pid);
              return p && !p.injured;
            });
            const selectedCount = validPlayers.length;
            const validXI = selectedCount === 11;

            return (
              <div className="min-h-screen bg-gray-900 p-4">
                <div className="max-w-2xl mx-auto">
                  <h1 className="text-white font-bold text-2xl mb-4">Pre-Match Setup</h1>
                  <div className="bg-gray-800 rounded-lg p-4 mb-4">
                    <p className="text-white">{team.name} vs {opp?.name}</p>
                    <p className="text-gray-400 text-sm">{next?.homeTeamId === team.id ? 'Home' : 'Away'}</p>
                  </div>
                  {inj.length > 0 && (
                    <div className="bg-red-900/20 rounded-lg p-4 mb-4">
                      <h3 className="text-red-400 font-bold mb-2">âš•ï¸ Injured Players</h3>
                      {inj.map(p => {
                        const w = getWeeksUntil(p.injuryUntil);
                        return <p key={p.id} className="text-red-300 text-sm">{p.name} - {w > 0 ? `${w} week${w > 1 ? 's' : ''} remaining` : 'Returning soon'}</p>;
                      })}
                    </div>
                  )}
                  <div className="bg-gray-800 rounded-lg p-4 mb-4">
                    <h3 className="text-white font-bold mb-2">Formation: {formation}</h3>
                    <p className="text-gray-400 text-sm mb-3">{validXI ? 'âœ… Starting XI selected' : `âš ï¸ Select ${11 - selectedCount} more player${11 - selectedCount !== 1 ? 's' : ''}`}</p>
                    <button onClick={() => { setPage('starting-xi'); setState('info-page'); }} className="w-full bg-orange-600 text-white py-3 rounded-lg font-semibold hover:bg-orange-700">Edit Starting XI</button>
                  </div>
                  <button onClick={playMatch} disabled={!validXI} className={`w-full py-4 rounded-lg font-bold text-xl ${validXI ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-700 text-gray-500 cursor-not-allowed'}`}>{validXI ? 'Start Match' : 'Select Starting XI First'}</button>
                </div>
              </div>
            );
          }

          return null;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
