<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title Challenge - Football Manager</title>
    <meta name="description" content="Text-based football manager game across 5 European leagues!">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Icons
        const Trophy = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>;
        const Users = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const TrendingUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>;
        const Calendar = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
        const Home = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
        const Play = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>;
        const Save = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const ArrowLeftRight = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 3 4 7l4 4"/><path d="M4 7h16"/><path d="m16 21 4-4-4-4"/><path d="M20 17H4"/></svg>;
        const Globe = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>;

        // Calculate player value based on position, rating, and age
        const calculatePlayerValue = (player, asOfDate) => {
          const { positions, rating, dob } = player;
          
          const positionValues = {
            'ST': 1.0, 'LW': 0.95, 'RW': 0.95, 'CAM': 0.85, 'CM': 0.70,
            'CDM': 0.68, 'LB': 0.65, 'RB': 0.65, 'CB': 0.60, 'GK': 0.55
          };
          
          const maxMultiplier = Math.max(...positions.map(pos => positionValues[pos] || 0.5));
          
          // Calculate age
          const birthDate = new Date(dob);
          const checkDate = asOfDate || new Date();
          let age = checkDate.getFullYear() - birthDate.getFullYear();
          const monthDiff = checkDate.getMonth() - birthDate.getMonth();
          if (monthDiff < 0 || (monthDiff === 0 && checkDate.getDate() < birthDate.getDate())) {
            age--;
          }
          
          // Age multiplier (peak 21-29)
          let ageMultiplier;
          if (age >= 21 && age <= 29) {
            ageMultiplier = 1.0; // Peak value
          } else if (age < 21) {
            // Young players: curve up from 16-20
            if (rating >= 14) {
              // Highly rated youngsters are expensive
              ageMultiplier = 0.6 + (age - 16) * 0.08 + (rating - 14) * 0.05;
            } else {
              ageMultiplier = 0.4 + (age - 16) * 0.12;
            }
          } else {
            // Decline after 29
            ageMultiplier = Math.max(0.2, 1.0 - ((age - 29) * 0.08));
          }
          
          const baseValue = Math.pow(rating, 2) * maxMultiplier * ageMultiplier * 250000;
          return Math.min(Math.round(baseValue), 100000000);
        };

        const App = () => {
          const [databaseLoaded, setDatabaseLoaded] = useState(false);
          const [initialLeagues, setInitialLeagues] = useState(null);
          const [gameState, setGameState] = useState('main-menu');
          const [selectedLeague, setSelectedLeague] = useState(null);
          const [selectedTeam, setSelectedTeam] = useState(null);
          const [allLeagues, setAllLeagues] = useState(null);
          const [currentMatch, setCurrentMatch] = useState(null);
          const [matchCommentary, setMatchCommentary] = useState([]);
          const [fixtures, setFixtures] = useState({});
          const [currentDate, setCurrentDate] = useState(new Date('2025-08-01'));
          const [selectedPlayerForTransfer, setSelectedPlayerForTransfer] = useState(null);
          const [selectedFormation, setSelectedFormation] = useState('4-3-3');
          const [lineup, setLineup] = useState({});
          const [showFormationPicker, setShowFormationPicker] = useState(false);

          const formations = {
            '4-3-3': { GK: 1, LB: 1, CB: 2, RB: 1, CDM: 1, CM: 2, LW: 1, RW: 1, ST: 1 },
            '4-4-2': { GK: 1, LB: 1, CB: 2, RB: 1, CM: 2, CAM: 2, ST: 2 },
            '4-2-3-1': { GK: 1, LB: 1, CB: 2, RB: 1, CDM: 2, CAM: 1, LW: 1, RW: 1, ST: 1 },
            '3-5-2': { GK: 1, CB: 3, LB: 1, RB: 1, CM: 3, ST: 2 },
            '4-1-4-1': { GK: 1, LB: 1, CB: 2, RB: 1, CDM: 1, CM: 2, LW: 1, RW: 1, ST: 1 }
          };

          useEffect(() => {
            fetch('./leagues-database.json')
              .then(response => response.json())
              .then(data => {
                setInitialLeagues(data);
                setDatabaseLoaded(true);
              })
              .catch(error => {
                console.error('Error loading database:', error);
                alert('Failed to load database. Please refresh the page.');
              });
          }, []);

          useEffect(() => {
            if (selectedTeam && gameState !== 'main-menu' && gameState !== 'league-select' && gameState !== 'team-select') {
              saveGame();
            }
          }, [selectedTeam, allLeagues, fixtures, currentDate, gameState]);

          const saveGame = () => {
            const gameData = {
              selectedLeague,
              selectedTeam,
              allLeagues,
              fixtures,
              currentDate: currentDate.toISOString(),
              selectedFormation,
              lineup,
              gameState
            };
            localStorage.setItem('footballManagerSave', JSON.stringify({ gameData }));
          };

          const newGame = () => {
            setSelectedLeague(null);
            setSelectedTeam(null);
            setAllLeagues(JSON.parse(JSON.stringify(initialLeagues)));
            setFixtures({});
            setCurrentDate(new Date('2025-08-01'));
            setSelectedFormation('4-3-3');
            setLineup({});
            localStorage.removeItem('footballManagerSave');
            setGameState('league-select');
          };

          const resumeGame = () => {
            const saved = localStorage.getItem('footballManagerSave');
            if (saved) {
              try {
                const data = JSON.parse(saved);
                if (data.gameData) {
                  setSelectedLeague(data.gameData.selectedLeague);
                  setSelectedTeam(data.gameData.selectedTeam);
                  setAllLeagues(data.gameData.allLeagues);
                  setFixtures(data.gameData.fixtures);
                  setCurrentDate(new Date(data.gameData.currentDate));
                  setSelectedFormation(data.gameData.selectedFormation || '4-3-3');
                  setLineup(data.gameData.lineup || {});
                  setGameState(data.gameData.gameState === 'main-menu' ? 'squad' : data.gameData.gameState);
                }
              } catch (e) {
                alert('Error loading saved game');
              }
            }
          };

          const hasSavedGame = () => {
            const saved = localStorage.getItem('footballManagerSave');
            if (saved) {
              try {
                const data = JSON.parse(saved);
                return data.gameData && data.gameData.selectedTeam;
              } catch (e) {
                return false;
              }
            }
            return false;
          };

          const generateSeasonFixtures = () => {
            const newFixtures = {};
            
            // Check for retirements and add warnings
            const retirements = [];
            const warnings = [];
            
            Object.keys(allLeagues).forEach(leagueKey => {
              const league = allLeagues[leagueKey];
              const teams = league.teams;
              
              teams.forEach(team => {
                team.players = team.players.filter(player => {
                  const age = calculateAge(player.dob, currentDate);
                  const isGK = player.positions.includes('GK');
                  const retirementAge = isGK ? 38 : 36;
                  
                  if (age >= retirementAge) {
                    if (player.retirementWarning) {
                      retirements.push(`${player.name} (${team.name}) has retired at age ${age}`);
                      return false;
                    } else {
                      player.retirementWarning = true;
                      warnings.push(`${player.name} (${team.name}, age ${age}) will retire at end of season`);
                      return true;
                    }
                  }
                  return true;
                });
                
                team.players.forEach(player => {
                  if (!player.goals) player.goals = 0;
                  if (!player.injured) player.injured = false;
                  if (!player.injuryUntil) player.injuryUntil = null;
                });
              });
              
              // Generate fixtures using round-robin algorithm
              const n = teams.length;
              const leagueFixtures = [];
              
              // Create matchdays (each team plays once per matchday)
              for (let round = 0; round < (n - 1) * 2; round++) {
                const isFirstHalf = round < n - 1;
                const baseRound = isFirstHalf ? round : round - (n - 1);
                
                for (let i = 0; i < n / 2; i++) {
                  let home = (baseRound + i) % (n - 1);
                  let away = (n - 1 - i + baseRound) % (n - 1);
                  
                  if (i === 0) {
                    away = n - 1;
                  }
                  
                  // Swap home/away for second half of season
                  if (!isFirstHalf) {
                    [home, away] = [away, home];
                  }
                  
                  leagueFixtures.push({
                    homeTeamId: teams[home].id,
                    awayTeamId: teams[away].id,
                    played: false,
                    homeScore: null,
                    awayScore: null,
                    scorers: [],
                    matchday: round + 1
                  });
                }
              }
              
              newFixtures[leagueKey] = leagueFixtures;
            });
            
            setFixtures(newFixtures);
            
            if (warnings.length > 0) {
              alert('Retirement Warnings:\n\n' + warnings.join('\n'));
            }
            if (retirements.length > 0) {
              alert('Retirements:\n\n' + retirements.join('\n'));
            }
          };

          const selectLeague = (leagueKey) => {
            setSelectedLeague(leagueKey);
            setGameState('team-select');
          };

          const selectTeam = (team) => {
            setSelectedTeam(team);
            setGameState('squad');
          };
          
          useEffect(() => {
            if (selectedTeam && Object.keys(fixtures).length === 0) {
              generateSeasonFixtures();
            }
          }, [selectedTeam]);

          const getLeagueTable = (leagueKey) => {
            const league = allLeagues[leagueKey];
            const leagueFixtures = fixtures[leagueKey] || [];
            
            const table = league.teams.map(team => ({
              teamId: team.id,
              name: team.name,
              played: 0,
              won: 0,
              drawn: 0,
              lost: 0,
              goalsFor: 0,
              goalsAgainst: 0,
              points: 0
            }));
            
            leagueFixtures.filter(f => f.played).forEach(fixture => {
              const homeTeam = table.find(t => t.teamId === fixture.homeTeamId);
              const awayTeam = table.find(t => t.teamId === fixture.awayTeamId);
              
              if (homeTeam && awayTeam) {
                homeTeam.played++;
                awayTeam.played++;
                homeTeam.goalsFor += fixture.homeScore;
                homeTeam.goalsAgainst += fixture.awayScore;
                awayTeam.goalsFor += fixture.awayScore;
                awayTeam.goalsAgainst += fixture.homeScore;
                
                if (fixture.homeScore > fixture.awayScore) {
                  homeTeam.won++;
                  homeTeam.points += 3;
                  awayTeam.lost++;
                } else if (fixture.homeScore < fixture.awayScore) {
                  awayTeam.won++;
                  awayTeam.points += 3;
                  homeTeam.lost++;
                } else {
                  homeTeam.drawn++;
                  awayTeam.drawn++;
                  homeTeam.points++;
                  awayTeam.points++;
                }
              }
            });
            
            table.sort((a, b) => {
              if (b.points !== a.points) return b.points - a.points;
              return (b.goalsFor - b.goalsAgainst) - (a.goalsFor - a.goalsAgainst);
            });
            
            return table;
          };

          const getTeamRating = (team) => {
            if (!team || !team.players) return 0;
            const total = team.players.reduce((sum, player) => sum + player.rating, 0);
            return Math.round(total / team.players.length);
          };

          const getNextPlayerMatch = () => {
            const leagueFixtures = fixtures[selectedLeague] || [];
            return leagueFixtures.find(f => 
              !f.played && (f.homeTeamId === selectedTeam.id || f.awayTeamId === selectedTeam.id)
            );
          };

          const simulateMatch = (homeTeam, awayTeam, trackScorers = false) => {
            const commentary = [];
            const homeRating = getTeamRating(homeTeam);
            const awayRating = getTeamRating(awayTeam);
            const goalScorers = [];
            
            // Check for injuries before match
            const updateInjuries = (team) => {
              team.players.forEach(player => {
                if (player.injured && player.injuryUntil) {
                  if (new Date(player.injuryUntil) <= currentDate) {
                    player.injured = false;
                    player.injuryUntil = null;
                  }
                }
              });
            };
            
            updateInjuries(homeTeam);
            updateInjuries(awayTeam);
            
            let homeScore = 0;
            let awayScore = 0;
            
            commentary.push(`${homeTeam.name} vs ${awayTeam.name}`);
            commentary.push(`Date: ${currentDate.toLocaleDateString('en-GB')}`);
            commentary.push("Kick off!");
            commentary.push("");
            
            const moments = 8 + Math.floor(Math.random() * 5);
            
            for (let i = 0; i < moments; i++) {
              const minute = Math.floor(Math.random() * 90) + 1;
              const homeChance = (homeRating + Math.random() * 10) / (homeRating + awayRating + Math.random() * 20);
              
              if (Math.random() < 0.3) {
                const selectScorer = (team) => {
                  const rand = Math.random();
                  let scorer;
                  
                  const availablePlayers = team.players.filter(p => !p.injured);
                  
                  if (rand < 0.70) {
                    const attackers = availablePlayers.filter(p => 
                      p.positions.some(pos => ['ST', 'LW', 'RW', 'CAM'].includes(pos))
                    );
                    scorer = attackers[Math.floor(Math.random() * attackers.length)];
                  } else if (rand < 0.90) {
                    const midfielders = availablePlayers.filter(p => 
                      p.positions.some(pos => ['CDM', 'CM'].includes(pos))
                    );
                    scorer = midfielders[Math.floor(Math.random() * midfielders.length)];
                  } else if (rand < 0.999) {
                    const defenders = availablePlayers.filter(p => 
                      p.positions.some(pos => ['LB', 'CB', 'RB'].includes(pos))
                    );
                    scorer = defenders[Math.floor(Math.random() * defenders.length)];
                  } else {
                    // 0.1% chance (1 in 1000)
                    scorer = availablePlayers.find(p => p.positions.includes('GK'));
                  }
                  return scorer;
                };
                
                if (Math.random() < homeChance) {
                  const scorer = selectScorer(homeTeam);
                  if (scorer && Math.random() < 0.4) {
                    homeScore++;
                    commentary.push(`${minute}' GOAL! ${scorer.name} scores for ${homeTeam.name}! ${homeScore}-${awayScore}`);
                    if (trackScorers) {
                      goalScorers.push({ playerId: scorer.id, teamId: homeTeam.id, playerName: scorer.name });
                    }
                  } else if (scorer) {
                    commentary.push(`${minute}' ${scorer.name} with a shot, but it's saved!`);
                  }
                } else {
                  const scorer = selectScorer(awayTeam);
                  if (scorer && Math.random() < 0.4) {
                    awayScore++;
                    commentary.push(`${minute}' GOAL! ${scorer.name} scores for ${awayTeam.name}! ${homeScore}-${awayScore}`);
                    if (trackScorers) {
                      goalScorers.push({ playerId: scorer.id, teamId: awayTeam.id, playerName: scorer.name });
                    }
                  } else if (scorer) {
                    commentary.push(`${minute}' ${scorer.name} shoots wide!`);
                  }
                }
              } else {
                const events = [
                  "Good passing move in midfield",
                  "Strong tackle breaks up the attack",
                  "Corner kick awarded",
                  "Free kick in a dangerous position",
                  "Counter attack developing",
                  "Possession being retained well"
                ];
                const team = Math.random() < homeChance ? homeTeam.name : awayTeam.name;
                commentary.push(`${minute}' ${events[Math.floor(Math.random() * events.length)]} - ${team}`);
              }
            }
            
            // Random injuries (1% chance per match)
            [homeTeam, awayTeam].forEach(team => {
              team.players.forEach(player => {
                if (!player.injured && Math.random() < 0.01) {
                  player.injured = true;
                  const weeksOut = 1 + Math.floor(Math.random() * 4); // 1-4 weeks
                  const injuryDate = new Date(currentDate);
                  injuryDate.setDate(injuryDate.getDate() + (weeksOut * 7));
                  player.injuryUntil = injuryDate.toISOString();
                  
                  if (team.id === selectedTeam.id || trackScorers) {
                    commentary.push("");
                    commentary.push(`INJURY: ${player.name} (${team.name}) injured - out for ${weeksOut} week${weeksOut > 1 ? 's' : ''}`);
                  }
                }
              });
            });
            
            commentary.push("");
            commentary.push(`FULL TIME: ${homeTeam.name} ${homeScore} - ${awayScore} ${awayTeam.name}`);
            
            return { homeScore, awayScore, commentary, scorers: goalScorers };
          };

          const simulateOtherMatches = () => {
            // This function is no longer needed as we simulate in playNextMatch
          };

          const playNextMatch = () => {
            // Show formation picker before match
            if (!showFormationPicker) {
              setShowFormationPicker(true);
              setGameState('formation-picker');
              return;
            }
            
            const nextMatch = getNextPlayerMatch();
            
            if (!nextMatch) {
              const newSeasonStart = new Date(currentDate);
              newSeasonStart.setFullYear(newSeasonStart.getFullYear() + 1);
              newSeasonStart.setMonth(7);
              newSeasonStart.setDate(1);
              
              alert(`Season Complete! New season starts ${newSeasonStart.toLocaleDateString('en-GB')}`);
              setCurrentDate(newSeasonStart);
              generateSeasonFixtures();
              return;
            }
            
            const league = allLeagues[selectedLeague];
            const homeTeam = nextMatch.homeTeamId === selectedTeam.id 
              ? selectedTeam 
              : league.teams.find(t => t.id === nextMatch.homeTeamId);
            const awayTeam = nextMatch.awayTeamId === selectedTeam.id 
              ? selectedTeam 
              : league.teams.find(t => t.id === nextMatch.awayTeamId);
            
            const result = simulateMatch(homeTeam, awayTeam);
            
            // Deep clone fixtures
            const updatedFixtures = JSON.parse(JSON.stringify(fixtures));
            
            // Mark player's match as played
            const playerLeagueFixtures = updatedFixtures[selectedLeague];
            const playerFixtureIndex = playerLeagueFixtures.findIndex(f => 
              f.homeTeamId === nextMatch.homeTeamId && 
              f.awayTeamId === nextMatch.awayTeamId && 
              !f.played
            );
            
            if (playerFixtureIndex !== -1) {
              playerLeagueFixtures[playerFixtureIndex].played = true;
              playerLeagueFixtures[playerFixtureIndex].homeScore = result.homeScore;
              playerLeagueFixtures[playerFixtureIndex].awayScore = result.awayScore;
              playerLeagueFixtures[playerFixtureIndex].scorers = result.scorers || [];
              
              // Update goal tallies for player's match
              result.scorers.forEach(scorer => {
                const team = league.teams.find(t => t.id === scorer.teamId);
                if (team) {
                  const player = team.players.find(p => p.id === scorer.playerId);
                  if (player) {
                    player.goals = (player.goals || 0) + 1;
                  }
                }
              });
            }
            
            // NOW simulate complete matchday for ALL leagues
            Object.keys(allLeagues).forEach(leagueKey => {
              const lg = allLeagues[leagueKey];
              const lgFixtures = updatedFixtures[leagueKey];
              
              if (!lgFixtures) return;
              
              // Find the current matchday number for this league
              const playedCount = lgFixtures.filter(f => f.played).length;
              const currentMatchday = Math.floor(playedCount / (lg.teams.length / 2)) + 1;
              
              // Get all fixtures for this matchday
              const matchdayFixtures = lgFixtures.filter(f => f.matchday === currentMatchday && !f.played);
              
              // Play all fixtures for this matchday
              matchdayFixtures.forEach(fixture => {
                const hTeam = lg.teams.find(t => t.id === fixture.homeTeamId);
                const aTeam = lg.teams.find(t => t.id === fixture.awayTeamId);
                
                if (hTeam && aTeam) {
                  const res = simulateMatch(hTeam, aTeam, true);
                  fixture.played = true;
                  fixture.homeScore = res.homeScore;
                  fixture.awayScore = res.awayScore;
                  fixture.scorers = res.scorers || [];
                  
                  // Update goal tallies
                  res.scorers.forEach(scorer => {
                    const team = lg.teams.find(t => t.id === scorer.teamId);
                    if (team) {
                      const player = team.players.find(p => p.id === scorer.playerId);
                      if (player) {
                        player.goals = (player.goals || 0) + 1;
                      }
                    }
                  });
                }
              });
            });
            
            // Save updated fixtures
            setFixtures(updatedFixtures);
            
            setCurrentMatch({
              opponent: nextMatch.homeTeamId === selectedTeam.id ? awayTeam.name : homeTeam.name,
              playerScore: nextMatch.homeTeamId === selectedTeam.id ? result.homeScore : result.awayScore,
              opponentScore: nextMatch.homeTeamId === selectedTeam.id ? result.awayScore : result.homeScore,
              isHome: nextMatch.homeTeamId === selectedTeam.id
            });
            
            setMatchCommentary(result.commentary);
            
            // Advance date
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() + (3 + Math.floor(Math.random() * 2)));
            
            if (newDate.getMonth() === 6 && newDate.getDate() > 30) {
              newDate.setMonth(7);
              newDate.setDate(1);
              newDate.setFullYear(newDate.getFullYear() + 1);
            }
            
            setCurrentDate(newDate);
            setShowFormationPicker(false);
            setGameState('match-result');
          };
          
          const getTopScorers = (leagueKey) => {
            const league = allLeagues[leagueKey];
            const scorers = [];
            
            league.teams.forEach(team => {
              team.players.forEach(player => {
                if (player.goals && player.goals > 0) {
                  scorers.push({
                    name: player.name,
                    team: team.name,
                    goals: player.goals
                  });
                }
              });
            });
            
            scorers.sort((a, b) => b.goals - a.goals);
            return scorers.slice(0, 10);
          };

          const calculateAge = (dob, asOfDate = currentDate) => {
            const birthDate = new Date(dob);
            let age = asOfDate.getFullYear() - birthDate.getFullYear();
            const monthDiff = asOfDate.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && asOfDate.getDate() < birthDate.getDate())) {
              age--;
            }
            return age;
          };

          const formatCurrency = (amount) => {
            return '¬£' + Math.round(amount / 1000000) + 'M';
          };

          const formatDate = (date) => {
            return new Date(date).toLocaleDateString('en-GB');
          };
          
          const getPlayerValueWithDate = (player) => {
            return calculatePlayerValue(player, currentDate);
          };

          if (!databaseLoaded || !initialLeagues) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-green-900 flex items-center justify-center">
                <div className="text-center">
                  <div className="w-16 h-16 mx-auto mb-4 text-yellow-400 animate-pulse flex items-center justify-center">
                    <Trophy />
                  </div>
                  <div className="text-white text-2xl">Loading game data...</div>
                </div>
              </div>
            );
          }

          // Main Menu
          if (gameState === 'main-menu') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-green-900 p-4 flex items-center justify-center">
                <div className="max-w-md w-full">
                  <div className="text-center mb-12">
                    <div className="w-24 h-24 mx-auto mb-6 text-yellow-400 flex items-center justify-center">
                      <Trophy />
                    </div>
                    <h1 className="text-5xl font-bold text-white mb-3">Title Challenge</h1>
                    <p className="text-green-200 text-lg">5 European Leagues</p>
                  </div>
                  
                  <div className="space-y-4">
                    <button
                      onClick={newGame}
                      className="w-full bg-yellow-400 text-green-900 py-6 rounded-lg font-bold text-xl hover:bg-yellow-300 transition-all flex items-center justify-center gap-3"
                    >
                      <Play />
                      New Game
                    </button>
                    
                    <button
                      onClick={resumeGame}
                      disabled={!hasSavedGame()}
                      className={`w-full py-6 rounded-lg font-bold text-xl transition-all flex items-center justify-center gap-3 ${
                        hasSavedGame()
                          ? 'bg-white/20 text-white hover:bg-white/30'
                          : 'bg-white/5 text-gray-500 cursor-not-allowed'
                      }`}
                    >
                      <Save />
                      Resume Game
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          // League Selection
          if (gameState === 'league-select') {
            const leagueFlags = {
              england: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø',
              germany: 'üá©üá™',
              spain: 'üá™üá∏',
              france: 'üá´üá∑',
              italy: 'üáÆüáπ'
            };

            return (
              <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-green-900 p-4">
                <div className="max-w-4xl mx-auto">
                  <div className="text-center mb-8 pt-8">
                    <div className="w-16 h-16 mx-auto mb-4 text-yellow-400 flex items-center justify-center">
                      <Globe />
                    </div>
                    <h1 className="text-4xl font-bold text-white mb-2">Choose Your League</h1>
                    <p className="text-green-200">Season starts: 01/08/2025</p>
                  </div>
                  
                  <div className="grid gap-4">
                    {Object.keys(initialLeagues).map(leagueKey => {
                      const league = initialLeagues[leagueKey];
                      return (
                        <div
                          key={leagueKey}
                          onClick={() => selectLeague(leagueKey)}
                          className="bg-white/10 backdrop-blur-sm rounded-lg p-6 cursor-pointer hover:bg-white/20 transition-all border-2 border-white/20 hover:border-yellow-400"
                        >
                          <div className="flex justify-between items-center">
                            <div>
                              <h2 className="text-3xl font-bold text-white mb-2">
                                {leagueFlags[leagueKey]} {league.name}
                              </h2>
                              <p className="text-green-200">{league.country}</p>
                              <p className="text-green-200 text-sm">{league.teams.length} teams ‚Ä¢ 38 matches per season</p>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>

                  <button
                    onClick={() => setGameState('main-menu')}
                    className="w-full mt-4 bg-white/20 text-white py-3 rounded-lg font-semibold hover:bg-white/30 transition-all"
                  >
                    Back to Menu
                  </button>
                </div>
              </div>
            );
          }

          // Team Selection
          if (gameState === 'team-select') {
            const league = initialLeagues[selectedLeague];
            
            return (
              <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-green-900 p-4">
                <div className="max-w-4xl mx-auto">
                  <div className="text-center mb-8 pt-8">
                    <div className="w-16 h-16 mx-auto mb-4 text-yellow-400 flex items-center justify-center">
                      <Trophy />
                    </div>
                    <h1 className="text-4xl font-bold text-white mb-2">{league.name}</h1>
                    <p className="text-green-200">Choose your team</p>
                  </div>
                  
                  <div className="grid gap-4">
                    {league.teams.map(team => (
                      <div
                        key={team.id}
                        onClick={() => selectTeam(team)}
                        className="bg-white/10 backdrop-blur-sm rounded-lg p-6 cursor-pointer hover:bg-white/20 transition-all border-2 border-white/20 hover:border-yellow-400"
                      >
                        <div className="flex justify-between items-center flex-wrap gap-4">
                          <div>
                            <h2 className="text-2xl font-bold text-white mb-2">{team.name}</h2>
                            <p className="text-green-200">Squad: {team.players.length} players</p>
                            <p className="text-green-200">Budget: {formatCurrency(team.budget)}</p>
                          </div>
                          <div className="text-center">
                            <div className="text-3xl font-bold text-yellow-400">{getTeamRating(team)}</div>
                            <div className="text-sm text-green-200">Rating</div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>

                  <button
                    onClick={() => setGameState('league-select')}
                    className="w-full mt-4 bg-white/20 text-white py-3 rounded-lg font-semibold hover:bg-white/30 transition-all"
                  >
                    Back to Leagues
                  </button>
                </div>
              </div>
            );
          }

          // Formation Picker
          if (gameState === 'formation-picker') {
            const nextMatch = getNextPlayerMatch();
            const opponent = nextMatch.homeTeamId === selectedTeam.id
              ? allLeagues[selectedLeague].teams.find(t => t.id === nextMatch.awayTeamId)
              : allLeagues[selectedLeague].teams.find(t => t.id === nextMatch.homeTeamId);
            
            const injuredPlayers = selectedTeam.players.filter(p => p.injured);
            
            return (
              <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-green-900 p-4">
                <div className="max-w-4xl mx-auto">
                  <div className="bg-white/10 backdrop-blur-sm rounded-lg p-6 mb-4">
                    <h1 className="text-3xl font-bold text-white mb-2">Pre-Match Setup</h1>
                    <p className="text-green-200">
                      {selectedTeam.name} vs {opponent?.name} ({nextMatch.homeTeamId === selectedTeam.id ? 'Home' : 'Away'})
                    </p>
                    <p className="text-green-200">{formatDate(currentDate)}</p>
                  </div>

                  {injuredPlayers.length > 0 && (
                    <div className="bg-red-500/20 rounded-lg p-4 mb-4">
                      <h3 className="text-white font-bold mb-2">‚öïÔ∏è Injured Players</h3>
                      {injuredPlayers.map(player => (
                        <p key={player.id} className="text-red-200 text-sm">
                          {player.name} - Returns: {formatDate(player.injuryUntil)}
                        </p>
                      ))}
                    </div>
                  )}

                  <div className="bg-white/10 backdrop-blur-sm rounded-lg p-6 mb-4">
                    <h2 className="text-2xl font-bold text-white mb-4">Select Formation</h2>
                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                      {Object.keys(formations).map(formation => (
                        <button
                          key={formation}
                          onClick={() => setSelectedFormation(formation)}
                          className={`p-4 rounded-lg font-bold text-lg transition-all ${
                            selectedFormation === formation
                              ? 'bg-yellow-400 text-green-900'
                              : 'bg-white/10 text-white hover:bg-white/20'
                          }`}
                        >
                          {formation}
                        </button>
                      ))}
                    </div>
                    <p className="text-green-200 mt-4 text-sm">
                      Formation affects match tactics and player positioning
                    </p>
                  </div>

                  <button
                    onClick={() => {
                      setShowFormationPicker(false);
                      playNextMatch();
                    }}
                    className="w-full bg-yellow-400 text-green-900 py-4 rounded-lg font-bold text-xl hover:bg-yellow-300 transition-all"
                  >
                    Start Match
                  </button>
                </div>
              </div>
            );
          }

          // Squad/League/Transfers view
          if (gameState === 'squad' || gameState === 'league-table' || gameState === 'all-leagues' || gameState === 'transfers' || gameState === 'fixtures' || gameState === 'top-scorers') {
            const nextMatch = getNextPlayerMatch();
            const table = getLeagueTable(selectedLeague);
            const playerPosition = table.findIndex(t => t.teamId === selectedTeam.id) + 1;
            
            return (
              <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-green-900 p-4">
                <div className="max-w-6xl mx-auto">
                  <div className="bg-white/10 backdrop-blur-sm rounded-lg p-6 mb-4">
                    <div className="flex justify-between items-center flex-wrap gap-4">
                      <div>
                        <h1 className="text-3xl font-bold text-white mb-2">{selectedTeam.name}</h1>
                        <p className="text-green-200">
                          {allLeagues[selectedLeague].name} | Position: {playerPosition} | Date: {formatDate(currentDate)}
                        </p>
                        <p className="text-green-200">Budget: {formatCurrency(selectedTeam.budget)}</p>
                      </div>
                      <button
                        onClick={() => setGameState('main-menu')}
                        className="bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-all flex items-center gap-2"
                      >
                        <Home />
                        Menu
                      </button>
                    </div>
                  </div>

                  <div className="flex gap-2 mb-4 flex-wrap">
                    <button
                      onClick={() => setGameState('squad')}
                      className={`px-4 py-2 rounded-lg font-semibold transition-all flex items-center gap-2 text-sm ${
                        gameState === 'squad' ? 'bg-yellow-400 text-green-900' : 'bg-white/10 text-white hover:bg-white/20'
                      }`}
                    >
                      <Users />
                      Squad
                    </button>
                    <button
                      onClick={() => setGameState('fixtures')}
                      className={`px-4 py-2 rounded-lg font-semibold transition-all flex items-center gap-2 text-sm ${
                        gameState === 'fixtures' ? 'bg-yellow-400 text-green-900' : 'bg-white/10 text-white hover:bg-white/20'
                      }`}
                    >
                      <Calendar />
                      Fixtures
                    </button>
                    <button
                      onClick={() => setGameState('transfers')}
                      className={`px-4 py-2 rounded-lg font-semibold transition-all flex items-center gap-2 text-sm ${
                        gameState === 'transfers' ? 'bg-yellow-400 text-green-900' : 'bg-white/10 text-white hover:bg-white/20'
                      }`}
                    >
                      <ArrowLeftRight />
                      Transfers
                    </button>
                    <button
                      onClick={() => setGameState('league-table')}
                      className={`px-4 py-2 rounded-lg font-semibold transition-all flex items-center gap-2 text-sm ${
                        gameState === 'league-table' ? 'bg-yellow-400 text-green-900' : 'bg-white/10 text-white hover:bg-white/20'
                      }`}
                    >
                      <TrendingUp />
                      Table
                    </button>
                    <button
                      onClick={() => setGameState('all-leagues')}
                      className={`px-4 py-2 rounded-lg font-semibold transition-all flex items-center gap-2 text-sm ${
                        gameState === 'all-leagues' ? 'bg-yellow-400 text-green-900' : 'bg-white/10 text-white hover:bg-white/20'
                      }`}
                    >
                      <Globe />
                      All Leagues
                    </button>
                    <button
                      onClick={() => setGameState('top-scorers')}
                      className={`px-4 py-2 rounded-lg font-semibold transition-all flex items-center gap-2 text-sm ${
                        gameState === 'top-scorers' ? 'bg-yellow-400 text-green-900' : 'bg-white/10 text-white hover:bg-white/20'
                      }`}
                    >
                      <Trophy />
                      Top Scorers
                    </button>
                  </div>

                  {gameState === 'squad' && (
                    <div className="bg-white/10 backdrop-blur-sm rounded-lg p-6 mb-4">
                      <h2 className="text-2xl font-bold text-white mb-4">Your Squad</h2>
                      <p className="text-green-200 mb-2 text-sm">Current Formation: {selectedFormation}</p>
                      <div className="space-y-2">
                        {selectedTeam.players.map(player => (
                          <div key={player.id} className={`rounded p-3 flex justify-between items-center flex-wrap gap-2 ${
                            player.injured ? 'bg-red-500/20' : 'bg-white/5'
                          }`}>
                            <div>
                              <span className="text-white font-semibold">{player.name}</span>
                              {player.injured && <span className="text-red-400 ml-2">‚öïÔ∏è INJURED</span>}
                              <span className="text-green-200 ml-4">{player.positions.join('/')}</span>
                              <span className="text-green-200 ml-4">Age: {calculateAge(player.dob)}</span>
                              {player.goals > 0 && <span className="text-yellow-400 ml-4">‚öΩ {player.goals}</span>}
                            </div>
                            <div className="text-green-400 font-semibold">{formatCurrency(getPlayerValueWithDate(player))}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {gameState === 'fixtures' && (
                    <div className="bg-white/10 backdrop-blur-sm rounded-lg p-6 mb-4">
                      <h2 className="text-2xl font-bold text-white mb-4">Season Fixtures</h2>
                      <div className="space-y-2 max-h-96 overflow-y-auto">
                        {(fixtures[selectedLeague] || []).map((fixture, index) => {
                          const league = allLeagues[selectedLeague];
                          const homeTeam = league.teams.find(t => t.id === fixture.homeTeamId);
                          const awayTeam = league.teams.find(t => t.id === fixture.awayTeamId);
                          const isPlayerMatch = fixture.homeTeamId === selectedTeam.id || fixture.awayTeamId === selectedTeam.id;
                          
                          return (
                            <div
                              key={index}
                              className={`p-3 rounded text-sm ${
                                isPlayerMatch 
                                  ? fixture.played ? 'bg-yellow-400/20' : 'bg-green-400/20'
                                  : 'bg-white/5'
                              }`}
                            >
                              <div className="flex justify-between items-center">
                                <span className="text-white">
                                  {homeTeam?.name} vs {awayTeam?.name}
                                </span>
                                {fixture.played ? (
                                  <span className="text-green-200 font-bold">
                                    {fixture.homeScore} - {fixture.awayScore}
                                  </span>
                                ) : (
                                  <span className="text-gray-400">Not played</span>
                                )}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}

                  {gameState === 'transfers' && (
                    <div className="space-y-4">
                      {selectedPlayerForTransfer ? (
                        <div className="bg-white/10 backdrop-blur-sm rounded-lg p-6">
                          <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold text-white">Transfer {selectedPlayerForTransfer.name}</h2>
                            <button
                              onClick={() => setSelectedPlayerForTransfer(null)}
                              className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600"
                            >
                              Cancel
                            </button>
                          </div>
                          <p className="text-green-200 mb-4">Value: {formatCurrency(getPlayerValueWithDate(selectedPlayerForTransfer))}</p>
                          <h3 className="text-xl font-bold text-white mb-3">Select destination team:</h3>
                          <div className="space-y-2 max-h-96 overflow-y-auto">
                            {Object.keys(allLeagues).map(leagueKey => {
                              const league = allLeagues[leagueKey];
                              return league.teams.filter(t => t.id !== selectedTeam.id).map(team => {
                                const playerValue = getPlayerValueWithDate(selectedPlayerForTransfer);
                                const canAfford = team.budget >= playerValue;
                                return (
                                  <div
                                    key={team.id}
                                    onClick={() => {
                                      if (canAfford) {
                                        const updatedLeagues = JSON.parse(JSON.stringify(allLeagues));
                                        Object.keys(updatedLeagues).forEach(lk => {
                                          updatedLeagues[lk].teams = updatedLeagues[lk].teams.map(t => {
                                            if (t.id === selectedTeam.id) {
                                              return {
                                                ...t,
                                                budget: t.budget + playerValue,
                                                players: t.players.filter(p => p.id !== selectedPlayerForTransfer.id)
                                              };
                                            }
                                            if (t.id === team.id) {
                                              return {
                                                ...t,
                                                budget: t.budget - playerValue,
                                                players: [...t.players, selectedPlayerForTransfer]
                                              };
                                            }
                                            return t;
                                          });
                                        });
                                        setAllLeagues(updatedLeagues);
                                        setSelectedTeam(updatedLeagues[selectedLeague].teams.find(t => t.id === selectedTeam.id));
                                        setSelectedPlayerForTransfer(null);
                                        alert(`${selectedPlayerForTransfer.name} transferred to ${team.name}!`);
                                      }
                                    }}
                                    className={`bg-white/5 rounded p-4 transition-all flex justify-between items-center ${
                                      canAfford ? 'cursor-pointer hover:bg-white/10' : 'opacity-50 cursor-not-allowed'
                                    }`}
                                  >
                                    <div>
                                      <div className="text-white font-semibold">{team.name}</div>
                                      <div className="text-green-200 text-sm">{league.name}</div>
                                      <div className="text-green-200">Budget: {formatCurrency(team.budget)}</div>
                                    </div>
                                    {!canAfford && <span className="text-red-400 text-sm">Insufficient funds</span>}
                                  </div>
                                );
                              });
                            })}
                          </div>
                        </div>
                      ) : (
                        <>
                          <div className="bg-white/10 backdrop-blur-sm rounded-lg p-6">
                            <h2 className="text-2xl font-bold text-white mb-4">Your Squad</h2>
                            <p className="text-green-200 mb-4">Click a player to sell them</p>
                            <div className="space-y-2">
                              {selectedTeam.players.map(player => (
                                <div
                                  key={player.id}
                                  onClick={() => setSelectedPlayerForTransfer(player)}
                                  className="bg-white/5 rounded p-3 flex justify-between items-center cursor-pointer hover:bg-white/10 transition-all flex-wrap gap-2"
                                >
                                  <div>
                                    <span className="text-white font-semibold">{player.name}</span>
                                    <span className="text-green-200 ml-4">{player.positions.join('/')}</span>
                                    <span className="text-green-200 ml-4">Age: {calculateAge(player.dob)}</span>
                                  </div>
                                  <span className="text-green-400 font-semibold">{formatCurrency(calculatePlayerValue(player))}</span>
                                </div>
                              ))}
                            </div>
                          </div>

                          <div className="bg-white/10 backdrop-blur-sm rounded-lg p-6">
                            <h2 className="text-2xl font-bold text-white mb-4">Available Players - All Leagues</h2>
                            <div className="space-y-4 max-h-96 overflow-y-auto">
                              {Object.keys(allLeagues).map(leagueKey => {
                                const league = allLeagues[leagueKey];
                                return (
                                  <div key={leagueKey}>
                                    <h3 className="text-xl font-semibold text-yellow-400 mb-2">{league.name}</h3>
                                    {league.teams.filter(t => t.id !== selectedTeam.id).map(team => (
                                      <div key={team.id} className="mb-3">
                                        <h4 className="text-md font-semibold text-white mb-2">{team.name}</h4>
                                        <div className="space-y-1">
                                          {team.players.slice(0, 3).map(player => {
                                            const playerValue = getPlayerValueWithDate(player);
                                            const canAfford = selectedTeam.budget >= playerValue;
                                            return (
                                              <div
                                                key={player.id}
                                                onClick={() => {
                                                  if (canAfford) {
                                                    if (confirm(`Sign ${player.name} for ${formatCurrency(playerValue)}?`)) {
                                                      const updatedLeagues = JSON.parse(JSON.stringify(allLeagues));
                                                      Object.keys(updatedLeagues).forEach(lk => {
                                                        updatedLeagues[lk].teams = updatedLeagues[lk].teams.map(t => {
                                                          if (t.id === team.id) {
                                                            return {
                                                              ...t,
                                                              budget: t.budget + playerValue,
                                                              players: t.players.filter(p => p.id !== player.id)
                                                            };
                                                          }
                                                          if (t.id === selectedTeam.id) {
                                                            return {
                                                              ...t,
                                                              budget: t.budget - playerValue,
                                                              players: [...t.players, player]
                                                            };
                                                          }
                                                          return t;
                                                        });
                                                      });
                                                      setAllLeagues(updatedLeagues);
                                                      setSelectedTeam(updatedLeagues[selectedLeague].teams.find(t => t.id === selectedTeam.id));
                                                      alert(`${player.name} signed!`);
                                                    }
                                                  } else {
                                                    alert('Insufficient budget!');
                                                  }
                                                }}
                                                className={`bg-white/5 rounded p-2 transition-all flex justify-between items-center flex-wrap gap-2 text-sm ${
                                                  canAfford ? 'cursor-pointer hover:bg-white/10' : 'opacity-50 cursor-not-allowed'
                                                }`}
                                              >
                                                <div>
                                                  <span className="text-white font-semibold">{player.name}</span>
                                                  <span className="text-green-200 ml-2">{player.positions.join('/')}</span>
                                                  <span className="text-green-200 ml-2">Age: {calculateAge(player.dob)}</span>
                                                </div>
                                                <span className={canAfford ? 'text-green-400 font-semibold' : 'text-red-400 font-semibold'}>
                                                  {formatCurrency(playerValue)}
                                                </span>
                                              </div>
                                            );
                                          })}
                                        </div>
                                      </div>
                                    ))}
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        </>
                      )}
                    </div>
                  )}

                  {gameState === 'league-table' && (
                    <div className="bg-white/10 backdrop-blur-sm rounded-lg p-6 mb-4">
                      <h2 className="text-2xl font-bold text-white mb-4">{allLeagues[selectedLeague].name} Table</h2>
                      <div className="overflow-x-auto">
                        <table className="w-full text-white text-sm">
                          <thead>
                            <tr className="border-b border-white/20">
                              <th className="text-left p-2">Pos</th>
                              <th className="text-left p-2">Team</th>
                              <th className="text-center p-2">P</th>
                              <th className="text-center p-2">W</th>
                              <th className="text-center p-2">D</th>
                              <th className="text-center p-2">L</th>
                              <th className="text-center p-2">GF</th>
                              <th className="text-center p-2">GA</th>
                              <th className="text-center p-2">GD</th>
                              <th className="text-center p-2">Pts</th>
                            </tr>
                          </thead>
                          <tbody>
                            {table.map((team, index) => (
                              <tr
                                key={team.teamId}
                                className={`border-b border-white/10 ${
                                  team.teamId === selectedTeam.id ? 'bg-yellow-400/20' : ''
                                }`}
                              >
                                <td className="p-2 font-bold">{index + 1}</td>
                                <td className="p-2">{team.name}</td>
                                <td className="text-center p-2">{team.played}</td>
                                <td className="text-center p-2">{team.won}</td>
                                <td className="text-center p-2">{team.drawn}</td>
                                <td className="text-center p-2">{team.lost}</td>
                                <td className="text-center p-2">{team.goalsFor}</td>
                                <td className="text-center p-2">{team.goalsAgainst}</td>
                                <td className="text-center p-2">{team.goalsFor - team.goalsAgainst}</td>
                                <td className="text-center p-2 font-bold">{team.points}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}

                  {gameState === 'all-leagues' && (
                    <div className="space-y-4">
                      {Object.keys(allLeagues).map(leagueKey => {
                        const league = allLeagues[leagueKey];
                        const table = getLeagueTable(leagueKey);
                        return (
                          <div key={leagueKey} className="bg-white/10 backdrop-blur-sm rounded-lg p-6">
                            <h2 className="text-2xl font-bold text-white mb-4">{league.name}</h2>
                            <div className="overflow-x-auto">
                              <table className="w-full text-white text-sm">
                                <thead>
                                  <tr className="border-b border-white/20">
                                    <th className="text-left p-2">Pos</th>
                                    <th className="text-left p-2">Team</th>
                                    <th className="text-center p-2">P</th>
                                    <th className="text-center p-2">Pts</th>
                                    <th className="text-center p-2">GD</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {table.slice(0, 5).map((team, index) => (
                                    <tr
                                      key={team.teamId}
                                      className={`border-b border-white/10 ${
                                        team.teamId === selectedTeam.id ? 'bg-yellow-400/20' : ''
                                      }`}
                                    >
                                      <td className="p-2 font-bold">{index + 1}</td>
                                      <td className="p-2">{team.name}</td>
                                      <td className="text-center p-2">{team.played}</td>
                                      <td className="text-center p-2 font-bold">{team.points}</td>
                                      <td className="text-center p-2">{team.goalsFor - team.goalsAgainst}</td>
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}

                  {gameState === 'top-scorers' && (
                    <div className="space-y-4">
                      {Object.keys(allLeagues).map(leagueKey => {
                        const league = allLeagues[leagueKey];
                        const topScorers = getTopScorers(leagueKey);
                        return (
                          <div key={leagueKey} className="bg-white/10 backdrop-blur-sm rounded-lg p-6">
                            <h2 className="text-2xl font-bold text-white mb-4">‚öΩ {league.name} - Top Scorers</h2>
                            {topScorers.length > 0 ? (
                              <div className="space-y-2">
                                {topScorers.map((scorer, index) => (
                                  <div key={index} className="bg-white/5 rounded p-3 flex justify-between items-center">
                                    <div>
                                      <span className="text-yellow-400 font-bold mr-3">{index + 1}.</span>
                                      <span className="text-white font-semibold">{scorer.name}</span>
                                      <span className="text-green-200 ml-3 text-sm">{scorer.team}</span>
                                    </div>
                                    <span className="text-yellow-400 font-bold text-xl">{scorer.goals}</span>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <p className="text-green-200">No goals scored yet this season</p>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  )}

                  {nextMatch ? (
                    <button
                      onClick={playNextMatch}
                      className="w-full bg-yellow-400 text-green-900 py-4 rounded-lg font-bold text-xl hover:bg-yellow-300 transition-all flex items-center justify-center gap-2"
                    >
                      <Calendar />
                      Play Next Match
                      {(() => {
                        const league = allLeagues[selectedLeague];
                        const opponent = nextMatch.homeTeamId === selectedTeam.id
                          ? league.teams.find(t => t.id === nextMatch.awayTeamId)
                          : league.teams.find(t => t.id === nextMatch.homeTeamId);
                        return opponent ? ` - vs ${opponent.name} (${nextMatch.homeTeamId === selectedTeam.id ? 'H' : 'A'})` : '';
                      })()}
                    </button>
                  ) : (
                    <div className="bg-yellow-400/20 text-yellow-200 p-6 rounded-lg text-center">
                      <h2 className="text-2xl font-bold mb-2">Season Complete!</h2>
                      <p>Final Position: {playerPosition}</p>
                      <button
                        onClick={() => {
                          const newSeasonStart = new Date(currentDate);
                          newSeasonStart.setFullYear(newSeasonStart.getFullYear() + 1);
                          newSeasonStart.setMonth(7);
                          newSeasonStart.setDate(1);
                          setCurrentDate(newSeasonStart);
                          generateSeasonFixtures();
                          alert('New season started!');
                        }}
                        className="mt-4 bg-yellow-400 text-green-900 px-6 py-3 rounded-lg font-bold hover:bg-yellow-300"
                      >
                        Start New Season
                      </button>
                    </div>
                  )}
                </div>
              </div>
            );
          }

          // Match Result
          if (gameState === 'match-result') {
            const resultText = 
              currentMatch.playerScore > currentMatch.opponentScore ? 'VICTORY!' :
              currentMatch.playerScore < currentMatch.opponentScore ? 'DEFEAT' :
              'DRAW';
            
            const resultColor = 
              currentMatch.playerScore > currentMatch.opponentScore ? 'text-green-400' :
              currentMatch.playerScore < currentMatch.opponentScore ? 'text-red-400' :
              'text-yellow-400';

            const table = getLeagueTable(selectedLeague);
            const playerPosition = table.findIndex(t => t.teamId === selectedTeam.id) + 1;

            return (
              <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-green-900 p-4">
                <div className="max-w-4xl mx-auto">
                  <div className="bg-white/10 backdrop-blur-sm rounded-lg p-6 mb-4">
                    <h1 className={`text-4xl font-bold text-center mb-4 ${resultColor}`}>{resultText}</h1>
                    <div className="text-center text-white text-3xl font-bold mb-2">
                      {currentMatch.isHome ? selectedTeam.name : currentMatch.opponent} {currentMatch.playerScore} - {currentMatch.opponentScore} {currentMatch.isHome ? currentMatch.opponent : selectedTeam.name}
                    </div>
                    <p className="text-center text-green-200">
                      {formatDate(currentDate)} | League Position: {playerPosition}
                    </p>
                  </div>

                  <div className="bg-white/10 backdrop-blur-sm rounded-lg p-6 mb-4 max-h-96 overflow-y-auto">
                    <h2 className="text-2xl font-bold text-white mb-4">Match Commentary</h2>
                    {matchCommentary.map((comment, index) => (
                      <p key={index} className="text-green-100 mb-2 font-mono text-sm">
                        {comment}
                      </p>
                    ))}
                  </div>

                  <div className="flex gap-4 flex-wrap">
                    <button
                      onClick={() => setGameState('league-table')}
                      className="flex-1 min-w-[200px] bg-white/20 text-white py-4 rounded-lg font-bold hover:bg-white/30 transition-all"
                    >
                      View Table
                    </button>
                    <button
                      onClick={() => {
                        const nextMatch = getNextPlayerMatch();
                        if (nextMatch) {
                          setGameState('squad');
                        } else {
                          setGameState('squad');
                        }
                      }}
                      className="flex-1 min-w-[200px] bg-yellow-400 text-green-900 py-4 rounded-lg font-bold hover:bg-yellow-300 transition-all"
                    >
                      Continue
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
